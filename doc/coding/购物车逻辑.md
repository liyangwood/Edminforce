购物车逻辑
=========


###Reference

```
参考:
https://docs.mongodb.org/manual/tutorial/perform-two-phase-commits/
http://docs.mongodb.org/ecosystem/use-cases/inventory-management/


用到购物车和事务逻辑的模块：

1.register class (normal)
2.register class (book the same time)
3.cancel class
4.change class


```

###购物车的状态

```
  
    一个购物车从添加到完成或取消作为一个事务
    
    购物车的状态：
    
    [normal flow]
    
    1.active  初始创建的状态 用户永远只有一个active的购物车， 数据处于一致状态
    
    2 pending 当用户开始添加item到购物车时 并修改class可用数量时设置此状态
    
    3.1 checking 开始pay
            此后超时分两种  pay-in-store 24h   pay-now 15m？
            
    3.2 applied 在这个状态 已支付完毕 购物车和class课程的数目已经一致， 但后面还有一些额外的事要做
            
            1.删除 class表中 对应的carted信息
            2.为classRegister表添加课程注册信息，
           
            3.修改 class的student表 更新学生信息 方便查询
            4.更改 swimmer中的class信息 方便查询
            
    4. done   购物行为完成        
    
    
    [expired flow]（由定时任务处理）
    
    5. expiring 
    6. expired
    
    [cancel flow]用户在未支付前主动取消单个后全部课程（pay-in-store情况，一天后才会自动过期）
    
    7. canceling
    8. canceled
                    

```

###故障处理 Failure Scenarios

#####恢复执行 Recovery Operations
```
在以下状态时 尚未执行或执行了部分而中断：

pending  定时任务检查 继续后面的步骤   确保反复执行结果唯一 
applied  定时任务检查 继续后面的步骤   确保反复执行结果唯一

```
#####回滚 Rollback Operations

```
checking状态
cancel   未支付成功或主动取消  执行逆向过程恢复class可用数目
expired  执行逆向过程恢复class可用数目

```
####定时任务

```
  1. 超时的active
     超时的pending 回滚， 未超时则在程序中继续往下执行
     超时的applied=>done
  2. 检查class中对应的购物车是否已经不存在  
     按照删除顺序应该不会出现但http://docs.mongodb.org/ecosystem/use-cases/inventory-management/中有这个逻辑
  
 
```
 
 

### mongodb 数据结构 
```
仅列出关键字段

暂不使用classRegister表 以后为了查询方便可考虑使用

1.classes存储课程信息
classes:{
  seatsTotal 总数
  seatsRemain:剩余名数 初值同seatsTotal  //
  carted:[
    {
      cartId,
      swimmerId,
      quantity,  //定义quantity是为了使用负数表示取消class或change class时使用
      timestamp  
    }
  ],
  students:[] // 学生列表
}  


2.购物车信息
shoppingCarts:{
  accountId
  items:[
    { 
      swimmerId,classId, quantity,      //key
      swimmer, class1, class2, class3  //这些为详细信息 方便查询
    }
  ]
}

3.swimmer信息
swimmers:{
  classes:[] //id列表  仅为方便查询 在applied阶段更新
}




```
###模块实现

```
注册课程 
  
取消课程：  注册数量标记为－1

change课程：一个－1 一个+1 一个事务过程 类似银行转账过程


```

