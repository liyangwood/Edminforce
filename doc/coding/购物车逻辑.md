购物车逻辑
=========


###Reference

```
参考:
http://docs.mongodb.org/ecosystem/use-cases/inventory-management/
http://docs.mongodb.org/ecosystem/use-cases/inventory-management/


用到购物车和事务逻辑的模块：

1.register class (normal)
2.register class (book the same time)
3.cancel class
4.change class


```

###购物车的状态

```
  
    一个购物车从添加到完成或取消作为一个事务
    
    购物车的状态：
    
    [normal flow]
    
    1. active  初始创建的状态 用户永远只有一个active的购物车
    
    2. pending 当用户开始pay时设置此状态
            此后超时分两种  pay-in-store 24h   pay-now 15m？
            
    3. applied 在这个状态 已支付完毕 购物车和class课程的数目已经一致， 但后面还有一些额外的事要做
            
            1.删除 class表中 对应的carted信息
            2.修改 class的student表 更新学生信息 方便查询
            3.更改 swimmer中的class信息 方便查询
            5.为class register表 添加课程注册信息？ 此表可根据需要删除 也是为了方便查询
            
    4. done   购物行为完成        
    
    
    [expired flow]（由定时任务处理）
    
    5. expiring 
    6. expired
    
    [cancel flow]用户在未支付前主动取消单个后全部课程（pay-in-store情况，一天后才会自动过期）
    
    7. canceling
    8. canceled
                    

```

###故障处理 Failure Scenarios

#####恢复执行 Recovery Operations
```
在以下状态时 尚未执行或执行了部分而中断：

pending  定时任务检查 继续后面的步骤   确保反复执行结果唯一 
applied  定时任务检查 继续后面的步骤   确保反复执行结果唯一

```
#####回滚 Rollback Operations

pending 未支付成功或主动取消  执行逆向过程恢复class可用数目

Applied 这个过程中断后不需要恢复 应继续执行 新的改动新建购物车

### mongodb 数据结构 
```
仅列出关键字段

暂不使用classRegister表 以后为了查询方便可考虑使用

1.classes存储课程信息
classes:{
  seatsToal 总数
  seatsRemain:剩余名数 处置同seatsToal  //
  carted:[
    {
      cartId,
      swimmerId,
      qty,  //定义qty是为了使用负数表示取消class或change class时使用
      time  
    }
  ],
  students:[] // 学生列表
}  


2.购物车信息
shoppingCarts:{
  accountId
  items:[{ swimmer, class1, class2, class3}]
}

3.swimmer信息
swimmers:{
  classes:[] //id列表  仅为方便查询 在applied阶段更新
}




```
###模块实现

```
注册课程 
  
取消课程：  注册数量标记为－1

change课程：一个－1 一个+1 一个事务过程 类似银行转账过程


```

