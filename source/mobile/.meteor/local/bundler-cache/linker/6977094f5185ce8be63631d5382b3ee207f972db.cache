[{"type":"js","data":"(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar _ = Package.underscore._;\n\n/* Package-scope variables */\nvar shoppingCart, shopping_cart_export, common_create_cart, common_get_or_create_active_cart, common_check_cart_status, create_cart, get_active_cart_id, get_carts, checkCartStatus, register_add_class_to_cart, register_add_preference_to_cart, change_caculate_fee, change_create_cart, change_get_or_create_active_cart, change_class, change_class_due, change_class_refund, change_add_class_to_cart, change_move_pending_to_applied, change_move__applied_to_done, change_move_pending_to_checking, change_rollback_from_pending, change_rollback_from_checking, change_checking_to_applied, cancel_create_cart, cancel_add_class_to_cart, cancel_move_canceling_to_applied, cancel_move_canceling_to_applied_rollback, cancel_move_applied_to_done;\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                               //\n// packages/cal_cart/shoppingCart.common.js                                                                      //\n//                                                                                                               //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                 //\n/**                                                                                                              // 1\n * Created on 9/25/15.                                                                                           // 2\n */                                                                                                              // 3\n                                                                                                                 // 4\n                                                                                                                 // 5\n                                                                                                                 // 6\nshoppingCart = {};                                                                                               // 7\n                                                                                                                 // 8\n//a utils                                                                                                        // 9\nshopping_cart_export=function(obj){                                                                              // 10\n    for(var x in obj){                                                                                           // 11\n                                                                                                                 // 12\n        if(obj.hasOwnProperty(x)){                                                                               // 13\n                                                                                                                 // 14\n            if(shoppingCart[x]){                                                                                 // 15\n                throw x+\" is duplicated\";                                                                        // 16\n            }                                                                                                    // 17\n            shoppingCart[x] =obj[x]                                                                              // 18\n        }                                                                                                        // 19\n    }                                                                                                            // 20\n}                                                                                                                // 21\n/////////////////////////////////////////////////////////                                                        // 22\n                                                                                                                 // 23\n////package scope                                                                                                // 24\n                                                                                                                 // 25\n//{type:'register'}                                                                                              // 26\ncommon_create_cart = function (params) {                                                                         // 27\n                                                                                                                 // 28\n    App.info = App.info || DB.App.findOne()                                                                      // 29\n                                                                                                                 // 30\n    var shoppingCart = {                                                                                         // 31\n        status: 'active',                                                                                        // 32\n        accountId: Meteor.userId(),                                                                              // 33\n        type: params.type,                                                                                       // 34\n        sessionId: App.info.sessionRegister,                                                                     // 35\n        items: params.item ? [params.item] : []                                                                  // 36\n    }                                                                                                            // 37\n                                                                                                                 // 38\n    var cartId = DB.ShoppingCart.insert(shoppingCart);                                                           // 39\n                                                                                                                 // 40\n    return DB.ShoppingCart.findOne({_id: cartId});                                                               // 41\n                                                                                                                 // 42\n}                                                                                                                // 43\n                                                                                                                 // 44\n                                                                                                                 // 45\n//{type:'register'}                                                                                              // 46\ncommon_get_or_create_active_cart = function (params) {                                                           // 47\n                                                                                                                 // 48\n    var cart = DB.ShoppingCart.findOne({                                                                         // 49\n        accountId: Meteor.userId(),                                                                              // 50\n        status: 'active',                                                                                        // 51\n        type: params.type,                                                                                       // 52\n        lastModified: {$gt: new Date(+new Date() - 15 * 60 * 1000)}                                              // 53\n                                                                                                                 // 54\n                                                                                                                 // 55\n    })                                                                                                           // 56\n                                                                                                                 // 57\n    return cart || create_cart({status: 'active', type: params.type})                                            // 58\n}                                                                                                                // 59\n                                                                                                                 // 60\n                                                                                                                 // 61\ncommon_check_cart_status =function (cartId, status) {                                                            // 62\n                                                                                                                 // 63\n    //todo 加入时间计算                                                                                                // 64\n    var cart = DB.ShoppingCart.findOne({                                                                         // 65\n        _id: cartId,                                                                                             // 66\n        accountId: Meteor.userId(),                                                                              // 67\n        status: status                                                                                           // 68\n    })                                                                                                           // 69\n                                                                                                                 // 70\n    return !!(cart && cart._id)                                                                                  // 71\n                                                                                                                 // 72\n}                                                                                                                // 73\n                                                                                                                 // 74\n                                                                                                                 // 75\n                                                                                                                 // 76\n                                                                                                                 // 77\n                                                                                                                 // 78\n                                                                                                                 // 79\n///////////////////old to delete///////////////////                                                              // 80\ncreate_cart = function (item) {                                                                                  // 81\n    App.info = App.info || DB.App.findOne()                                                                      // 82\n                                                                                                                 // 83\n    var shoppingCart = {                                                                                         // 84\n        status: 'active',                                                                                        // 85\n        accountId: Meteor.userId(),                                                                              // 86\n        sessionId: App.info.sessionRegister,                                                                     // 87\n        items: item ? [item] : []                                                                                // 88\n    }                                                                                                            // 89\n                                                                                                                 // 90\n    var cartId = DB.ShoppingCart.insert(shoppingCart);                                                           // 91\n                                                                                                                 // 92\n    return cartId;                                                                                               // 93\n                                                                                                                 // 94\n}                                                                                                                // 95\n                                                                                                                 // 96\n//todo pending且未超时状态下 恢复为active的逻辑                                                                               // 97\nget_active_cart_id =function (createIfNotExist) {                                                                // 98\n                                                                                                                 // 99\n    var cart = DB.ShoppingCart.findOne({ //todo 加入时间计算                                                           // 100\n        accountId: Meteor.userId(),                                                                              // 101\n        status: 'active'                                                                                         // 102\n    })                                                                                                           // 103\n                                                                                                                 // 104\n    //console.log(cart)                                                                                          // 105\n                                                                                                                 // 106\n    return (cart && cart._id) || (createIfNotExist && create_cart());                                            // 107\n}                                                                                                                // 108\n                                                                                                                 // 109\nget_carts = function (status) {                                                                                  // 110\n    App.info = App.info || DB.App.findOne()                                                                      // 111\n                                                                                                                 // 112\n    var options = {                                                                                              // 113\n        accountId: Meteor.userId(),                                                                              // 114\n        sessionId: App.info.sessionRegister,                                                                     // 115\n    }                                                                                                            // 116\n    status = status | {}                                                                                         // 117\n                                                                                                                 // 118\n    options = _.extend(options, status)                                                                          // 119\n                                                                                                                 // 120\n    var carts = DB.ShoppingCart.find(options).fetch()                                                            // 121\n    return carts;                                                                                                // 122\n}                                                                                                                // 123\n                                                                                                                 // 124\n                                                                                                                 // 125\n//package scope                                                                                                  // 126\ncheckCartStatus =function (cartId, status) {                                                                     // 127\n                                                                                                                 // 128\n    //todo 加入时间计算                                                                                                // 129\n    var cart = DB.ShoppingCart.findOne({                                                                         // 130\n        _id: cartId,                                                                                             // 131\n        accountId: Meteor.userId(),                                                                              // 132\n        status: status                                                                                           // 133\n    })                                                                                                           // 134\n                                                                                                                 // 135\n    return !!(cart && cart._id)                                                                                  // 136\n                                                                                                                 // 137\n}                                                                                                                // 138\n                                                                                                                 // 139\n                                                                                                                 // 140\n                                                                                                                 // 141\n                                                                                                                 // 142\nshopping_cart_export({                                                                                           // 143\n    //create_cart: create_cart,                                                                                  // 144\n    get_or_create_active_cart: common_get_or_create_active_cart,                                                 // 145\n    check_cart_status: common_check_cart_status,                                                                 // 146\n                                                                                                                 // 147\n                                                                                                                 // 148\n    ////////old/////                                                                                             // 149\n    create_cart: create_cart,                                                                                    // 150\n    get_active_cart_id: get_active_cart_id,                                                                      // 151\n    get_carts: get_carts,                                                                                        // 152\n    checkCartStatus: checkCartStatus                                                                             // 153\n})                                                                                                               // 154\n                                                                                                                 // 155\n                                                                                                                 // 156\n                                                                                                                 // 157\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                               //\n// packages/cal_cart/shoppingCart.register.js                                                                    //\n//                                                                                                               //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                 //\n/**                                                                                                              // 1\n * Created on 9/25/15.                                                                                           // 2\n */                                                                                                              // 3\n                                                                                                                 // 4\n                                                                                                                 // 5\n                                                                                                                 // 6\nregister_add_class_to_cart = function (classId) {                                                                // 7\n                                                                                                                 // 8\n                                                                                                                 // 9\n}                                                                                                                // 10\nregister_add_preference_to_cart = function () {                                                                  // 11\n                                                                                                                 // 12\n                                                                                                                 // 13\n}                                                                                                                // 14\n                                                                                                                 // 15\nfunction add_item_to_cart(item) {                                                                                // 16\n                                                                                                                 // 17\n                                                                                                                 // 18\n}                                                                                                                // 19\n                                                                                                                 // 20\n//cart中 单个swimmer添加的课程的数量                                                                                        // 21\nfunction get_class_count_in_cart(cartId, swimmerId) {                                                            // 22\n    var cart = DB.ShoppingCart.findOne({                                                                         // 23\n        _id: cartId                                                                                              // 24\n    })                                                                                                           // 25\n    if (!cart)throw new Meteor.Error(500, 'in get_class_count_in_cart', 'cart not exist ' + cartId)              // 26\n                                                                                                                 // 27\n    var items = cart.items                                                                                       // 28\n    var count = 0                                                                                                // 29\n                                                                                                                 // 30\n    items.forEach(function (item) {                                                                              // 31\n        if (item.swimmerId == swimmerId) count++                                                                 // 32\n    })                                                                                                           // 33\n                                                                                                                 // 34\n    return count;                                                                                                // 35\n}                                                                                                                // 36\n//用于检查是否已经注册过该课程                                                                                                 // 37\nfunction get_class_count_in_register(swimmerId, classId, sessionId) {                                            // 38\n    App.info = App.info || DB.App.findOne()                                                                      // 39\n                                                                                                                 // 40\n    sessionId = sessionId || App.info.sessionRegister                                                            // 41\n                                                                                                                 // 42\n    var count = DB.ClassesRegister.find({                                                                        // 43\n        swimmerId:swimmerId,                                                                                     // 44\n        classId:classId,                                                                                         // 45\n        sessionId: sessionId                                                                                     // 46\n    }).count()                                                                                                   // 47\n                                                                                                                 // 48\n    return count;                                                                                                // 49\n}                                                                                                                // 50\n                                                                                                                 // 51\n//==============================================================                                                 // 52\n//////////////////////old////////////////////////////                                                            // 53\n//注册课程 先占用课程数量                                                                                                   // 54\n                                                                                                                 // 55\n                                                                                                                 // 56\n/////////////////////////////////////////////                                                                    // 57\n//{swimmerId,classId, quantity , swimmer,  class1, ...}                                                          // 58\nfunction add_class_to_cart(item) {                                                                               // 59\n                                                                                                                 // 60\n                                                                                                                 // 61\n    //////////////////////////////////                                                                           // 62\n    //check 参数                                                                                                   // 63\n    if (!item || !item.classId) {                                                                                // 64\n        throw new Meteor.Error('param invalid', 'in add_class_to_cart', item);                                   // 65\n    }                                                                                                            // 66\n                                                                                                                 // 67\n    ////////////////////////////////////                                                                         // 68\n    //check class可注册数目                                                                                           // 69\n    var classItem = DB.Classes.findOne({                                                                         // 70\n        _id: item.classId                                                                                        // 71\n    })                                                                                                           // 72\n    if (classItem.seatsRemain < 1) {                                                                             // 73\n        throw new Meteor.Error('ERROR_CLASS_NOT_ENOUGH', 'in add_class_to_cart');                                // 74\n    }                                                                                                            // 75\n                                                                                                                 // 76\n                                                                                                                 // 77\n    ///////////////////////////////////                                                                          // 78\n    //获取或创建购物车                                                                                                   // 79\n    var cart_id = get_active_cart_id(true)                                                                       // 80\n    if (!cart_id) {                                                                                              // 81\n        throw new Meteor.Error(500,                                                                              // 82\n            'add_class_to_cart  error',                                                                          // 83\n            'get_active_cart_id: ' + cart_id);                                                                   // 84\n    }                                                                                                            // 85\n    console.log('get_active_cart_id ' + cart_id);                                                                // 86\n                                                                                                                 // 87\n                                                                                                                 // 88\n    //////////////////////////////////////////                                                                   // 89\n    //check 检测购物车是否已有该class                                                                                      // 90\n    var cart = DB.ShoppingCart.findOne(                                                                          // 91\n        {                                                                                                        // 92\n            _id: cart_id,                                                                                        // 93\n            status: 'active',                                                                                    // 94\n            items: {                                                                                             // 95\n                $elemMatch: {                                                                                    // 96\n                    'swimmerId': item.swimmerId,                                                                 // 97\n                    'classId': item.classId                                                                      // 98\n                                                                                                                 // 99\n                }                                                                                                // 100\n            }                                                                                                    // 101\n        })                                                                                                       // 102\n                                                                                                                 // 103\n    if (cart) {                                                                                                  // 104\n        throw new Meteor.Error('ERROR_CLASS_ALREADY_IN_CART', 'in add_class_to_cart');                           // 105\n    }                                                                                                            // 106\n    console.log('check if cart exist', cart,item.swimmerId,item.classId)                                         // 107\n                                                                                                                 // 108\n                                                                                                                 // 109\n    //////////////////////////////////////////////////                                                           // 110\n    /////////check 单次 一个swimmer最多注册3节                                                                            // 111\n    var classCount = get_class_count_in_cart(cart_id, item.swimmerId);                                           // 112\n    if (classCount == 3) {                                                                                       // 113\n        throw new Meteor.Error('ERROR_CLASS_ALREADY_3_IN_CART', 'in add_class_to_cart');                         // 114\n    }                                                                                                            // 115\n                                                                                                                 // 116\n    if(get_class_count_in_register(item.swimmerId, item.classId)){                                               // 117\n        throw new Meteor.Error('ERROR_CLASS_ALREADY_REGISTERED', 'in add_class_to_cart');                        // 118\n                                                                                                                 // 119\n    }                                                                                                            // 120\n                                                                                                                 // 121\n                                                                                                                 // 122\n    /////////////加入购物车///////////                                                                                // 123\n    var result;                                                                                                  // 124\n    result = DB.ShoppingCart.update({//todo 1门课仅可注册一个； 最多注册3门                                                    // 125\n        '_id': cart_id                                                                                           // 126\n    }, {                                                                                                         // 127\n        '$set': {status: 'pending'},//已开始事务处里 置为pending                                                          // 128\n        '$push': {                                                                                               // 129\n            'items': item  //item.quantity==1 or -1                                                              // 130\n        }                                                                                                        // 131\n    })                                                                                                           // 132\n                                                                                                                 // 133\n    if (!result) {                                                                                               // 134\n        throw new Meteor.Error(500, 'add_class_to_cart error', 'DB.ShoppingCart.update $push');                  // 135\n    }                                                                                                            // 136\n    ;                                                                                                            // 137\n                                                                                                                 // 138\n    //此时处于pending状态 若此处中断 若超时由定时程序清理，继续往下进行 todo恢复逻辑                                                             // 139\n                                                                                                                 // 140\n    //可能数量不够 //todo 1门课仅可注册一个； 最多注册3门 ;确保多次操作结果唯一                                                                // 141\n    result = DB.Classes.update(                                                                                  // 142\n        {'_id': item.classId, 'seatsRemain': {'$gte': item.quantity}},                                           // 143\n        {                                                                                                        // 144\n            '$inc': {'seatsRemain': -item.quantity},                                                             // 145\n            '$push': {                                                                                           // 146\n                'carted': {                                                                                      // 147\n                    'type': 'register',                                                                          // 148\n                    'cartId': cart_id,                                                                           // 149\n                    'swimmerId': item.swimmerId,                                                                 // 150\n                    'quantity': item.quantity,                                                                   // 151\n                    'timestamp': new Date()                                                                      // 152\n                }                                                                                                // 153\n            }                                                                                                    // 154\n        })                                                                                                       // 155\n                                                                                                                 // 156\n    //todo result判断仅适用第一次加入 恢复操作不再适用                                                                             // 157\n    if (!result) {                                                                                               // 158\n        DB.ShoppingCart.update(                                                                                  // 159\n            {'_id': cart_id},                                                                                    // 160\n            {                                                                                                    // 161\n                '$set': {status: 'active'}, //重置为active                                                          // 162\n                '$pull': {                                                                                       // 163\n                    'items': {                                                                                   // 164\n                        //'type': 'register',                                                                    // 165\n                        'swimmerId': item.swimmerId,                                                             // 166\n                        classId: item.classId                                                                    // 167\n                    }                                                                                            // 168\n                }                                                                                                // 169\n            })                                                                                                   // 170\n                                                                                                                 // 171\n        throw new Meteor.Error(500,                                                                              // 172\n            'add_class_to_cart ' + cart_id + ' error. There is not enough class to register?',                   // 173\n            'DB.Classes.update $push');                                                                          // 174\n                                                                                                                 // 175\n    } else {                                                                                                     // 176\n        DB.ShoppingCart.update(                                                                                  // 177\n            {'_id': cart_id},                                                                                    // 178\n            {                                                                                                    // 179\n                '$set': {status: 'active'} //重置为active                                                           // 180\n            })                                                                                                   // 181\n        return {cartId: cart_id}                                                                                 // 182\n    }                                                                                                            // 183\n                                                                                                                 // 184\n}                                                                                                                // 185\n                                                                                                                 // 186\n//添加两个备选                                                                                                         // 187\n/*                                                                                                               // 188\n *                                                                                                               // 189\n * {                                                                                                             // 190\n * cartId                                                                                                        // 191\n *                                                                                                               // 192\n * classId,  定位到class                                                                                            // 193\n * swimmerId 定位到swimmer                                                                                          // 194\n *                                                                                                               // 195\n * preferenceNum,                                                                                                // 196\n * data {item}                                                                                                   // 197\n * ,                                                                                                             // 198\n * , }                                                                                                           // 199\n * */                                                                                                            // 200\nfunction add_preference_to_cart(p) {                                                                             // 201\n                                                                                                                 // 202\n    //var cartId = get_active_cart_id();                                                                         // 203\n    var cartId = p.cartId                                                                                        // 204\n    if (!checkCartStatus(cartId, 'active')) {                                                                    // 205\n        throw new Meteor.Error(500, cartId + ' is not active');                                                  // 206\n    }                                                                                                            // 207\n                                                                                                                 // 208\n                                                                                                                 // 209\n    //console.log(p)                                                                                             // 210\n                                                                                                                 // 211\n    if (!cartId) return 'cartId not exist';                                                                      // 212\n                                                                                                                 // 213\n                                                                                                                 // 214\n    /*                                                                                                           // 215\n     http://docs.mongodb.org/manual/reference/operator/projection/positional/#proj._S_                           // 216\n     {                                                                                                           // 217\n     '_id': p.cartId,                                                                                            // 218\n     'items.swimmer._id': p.swimmer._id,                                                                         // 219\n     'items.class1._id': p.class1._id                                                                            // 220\n     }                                                                                                           // 221\n     在一个swimmer选择多个class时总是匹配第一个  $elemMatch不存在这个问题                                                              // 222\n     * */                                                                                                        // 223\n                                                                                                                 // 224\n    if (p.preferenceNum == 2) {                                                                                  // 225\n        DB.ShoppingCart.update({                                                                                 // 226\n            '_id': cartId,                                                                                       // 227\n            'items': {                                                                                           // 228\n                $elemMatch: {                                                                                    // 229\n                    'swimmerId': p.swimmerId,                                                                    // 230\n                    'classId': p.classId                                                                         // 231\n                                                                                                                 // 232\n                }                                                                                                // 233\n            }                                                                                                    // 234\n        }, {                                                                                                     // 235\n            $set: {                                                                                              // 236\n                'items.$.class2': p.data  //class2                                                               // 237\n            }                                                                                                    // 238\n        })                                                                                                       // 239\n    }                                                                                                            // 240\n    if (p.preferenceNum == 3) {                                                                                  // 241\n        DB.ShoppingCart.update({                                                                                 // 242\n            '_id': cartId,                                                                                       // 243\n            'items': {                                                                                           // 244\n                $elemMatch: {                                                                                    // 245\n                    'swimmerId': p.swimmerId,                                                                    // 246\n                    'classId': p.classId                                                                         // 247\n                }                                                                                                // 248\n            }                                                                                                    // 249\n        }, {                                                                                                     // 250\n            $set: {                                                                                              // 251\n                'items.$.class3': p.data //class3                                                                // 252\n            }                                                                                                    // 253\n        })                                                                                                       // 254\n    }                                                                                                            // 255\n}                                                                                                                // 256\n                                                                                                                 // 257\n//当用户触发pay－now 或 pay－in－store时                                                                                   // 258\nfunction move_to_checking(cartId, checkoutType) {                                                                // 259\n    //todo check payType value                                                                                   // 260\n                                                                                                                 // 261\n    //var cartId = get_active_cart_id()                                                                          // 262\n    if (!checkCartStatus(cartId, 'active')) {                                                                    // 263\n        throw new Meteor.Error(500, cartId + ' is not active');                                                  // 264\n    }                                                                                                            // 265\n                                                                                                                 // 266\n                                                                                                                 // 267\n    var result = DB.ShoppingCart.update({                                                                        // 268\n        '_id': cartId,                                                                                           // 269\n        status: 'active'                                                                                         // 270\n    }, {                                                                                                         // 271\n        '$set': {                                                                                                // 272\n            'checkoutType': checkoutType,                                                                        // 273\n            'status': 'checking'                                                                                 // 274\n        }                                                                                                        // 275\n                                                                                                                 // 276\n    })                                                                                                           // 277\n                                                                                                                 // 278\n    if (!result) {                                                                                               // 279\n        throw new Meteor.Error(500, 'move_to_checking error');                                                   // 280\n                                                                                                                 // 281\n    }                                                                                                            // 282\n                                                                                                                 // 283\n    return {status: 'success'}                                                                                   // 284\n                                                                                                                 // 285\n}                                                                                                                // 286\n                                                                                                                 // 287\n//支付成功后调用此过程                                                                                                     // 288\n//在店里通过后台 或根据支付网关的回调 设置为已支付  同时触发后续处理过程                                                                          // 289\nfunction move_to_applied(cartId) {                                                                               // 290\n    //todo check to make sure paied                                                                              // 291\n                                                                                                                 // 292\n    if (!checkCartStatus(cartId, 'checking')) {                                                                  // 293\n        throw new Meteor.Error(500, cartId + ' is not in status of checking');                                   // 294\n    }                                                                                                            // 295\n                                                                                                                 // 296\n                                                                                                                 // 297\n    DB.ShoppingCart.update({                                                                                     // 298\n        '_id': cartId,                                                                                           // 299\n        'status': 'checking'                                                                                     // 300\n    }, {                                                                                                         // 301\n        '$set': {status: 'applied'} //                                                                           // 302\n                                                                                                                 // 303\n    })                                                                                                           // 304\n                                                                                                                 // 305\n    move_to_done(cartId)                                                                                         // 306\n}                                                                                                                // 307\n                                                                                                                 // 308\nfunction move_to_done(cartId) {                                                                                  // 309\n                                                                                                                 // 310\n    if (!checkCartStatus(cartId, 'applied')) {                                                                   // 311\n        throw new Meteor.Error(500, cartId + ' is not in status of applied');                                    // 312\n    }                                                                                                            // 313\n                                                                                                                 // 314\n    var cart = DB.ShoppingCart.findOne({ //todo optimize                                                         // 315\n        _id: cartId                                                                                              // 316\n    })                                                                                                           // 317\n                                                                                                                 // 318\n    //console.log(cart)                                                                                          // 319\n                                                                                                                 // 320\n    _move_to_done(cart)                                                                                          // 321\n}                                                                                                                // 322\n                                                                                                                 // 323\n//private                                                                                                        // 324\n//cart status [apllied]=>[done]                                                                                  // 325\nfunction _move_to_done(cart) {                                                                                   // 326\n                                                                                                                 // 327\n    if (typeof cart === 'string') {                                                                              // 328\n                                                                                                                 // 329\n    }                                                                                                            // 330\n                                                                                                                 // 331\n                                                                                                                 // 332\n    //todo test  mongodb 多个class 一个cart有多个item是否都可以删除                                                            // 333\n    DB.Classes.update({                                                                                          // 334\n        'carted.cartId': cart._id                                                                                // 335\n    }, {                                                                                                         // 336\n        '$pull': {                                                                                               // 337\n            'carted': {cartId: cart._id}                                                                         // 338\n        }                                                                                                        // 339\n    }, {multi: true})                                                                                            // 340\n                                                                                                                 // 341\n                                                                                                                 // 342\n    cart.items.forEach(function (item) {                                                                         // 343\n                                                                                                                 // 344\n        if (item.quantity == 1) {//注册 todo using type                                                            // 345\n                                                                                                                 // 346\n            //insert the document if it does not exist                                                           // 347\n            DB.ClassesRegister.update({                                                                          // 348\n                swimmerId: item.swimmerId,                                                                       // 349\n                classId: item.classId,                                                                           // 350\n                status: 'normal',                                                                                // 351\n                                                                                                                 // 352\n                accountId: cart.accountId,                                                                       // 353\n                sessionId: cart.sessionId,                                                                       // 354\n                cartId: cart._id                                                                                 // 355\n            }, {                                                                                                 // 356\n                $set: {                                                                                          // 357\n                    registerTime: cart.lastModified                                                              // 358\n                }                                                                                                // 359\n            }, {                                                                                                 // 360\n                upsert: true //insert if not found                                                               // 361\n            })                                                                                                   // 362\n                                                                                                                 // 363\n                                                                                                                 // 364\n        } else if (item.quantity == -1) {//取消注册 todo using type                                                  // 365\n            DB.ClassesRegister.remove({                                                                          // 366\n                swimmerId: item.swimmerId,                                                                       // 367\n                classId: item.classId,                                                                           // 368\n                                                                                                                 // 369\n                sessionId: cart.sessionId,                                                                       // 370\n                cartId: cart._id                                                                                 // 371\n            })                                                                                                   // 372\n                                                                                                                 // 373\n        } else if (item.type == 'change') {                                                                      // 374\n                                                                                                                 // 375\n                                                                                                                 // 376\n        }                                                                                                        // 377\n    })                                                                                                           // 378\n                                                                                                                 // 379\n    //以上过程非异步 完成之后                                                                                               // 380\n    DB.ShoppingCart.update({                                                                                     // 381\n        '_id': cart._id,                                                                                         // 382\n        'status': 'applied'                                                                                      // 383\n    }, {                                                                                                         // 384\n        '$set': {status: 'done'} //                                                                              // 385\n    })                                                                                                           // 386\n                                                                                                                 // 387\n}                                                                                                                // 388\n                                                                                                                 // 389\n                                                                                                                 // 390\n//{cartId, swimmerId,classId}                                                                                    // 391\nfunction delete_class_from_cart(params){                                                                         // 392\n                                                                                                                 // 393\n    console.log('====delete_class_from_cart params=====:',params)                                                // 394\n                                                                                                                 // 395\n                                                                                                                 // 396\n    //恢复class数目                                                                                                  // 397\n    result = DB.Classes.update(                                                                                  // 398\n        {'_id': params.classId},                                                                                 // 399\n        {                                                                                                        // 400\n            '$inc': {'seatsRemain': 1},                                                                          // 401\n            '$pull': {                                                                                           // 402\n                'carted': {                                                                                      // 403\n                    'type': 'register',                                                                          // 404\n                    'cartId': params.cartId,                                                                     // 405\n                    'swimmerId': params.swimmerId,                                                               // 406\n                    'quantity': 1,                                                                               // 407\n                    //'timestamp': new Date()                                                                    // 408\n                }                                                                                                // 409\n            }                                                                                                    // 410\n        })                                                                                                       // 411\n    console.log('====delete_class_from_cart [restore class] step1=====:'+result)                                 // 412\n                                                                                                                 // 413\n    //从购物车删除                                                                                                     // 414\n    var result = DB.ShoppingCart.update(                                                                         // 415\n        {'_id': params.cartId},                                                                                  // 416\n        {                                                                                                        // 417\n            '$set': {status: 'active'}, //重置为active                                                              // 418\n            '$pull': {                                                                                           // 419\n                'items': {                                                                                       // 420\n                    //'type': 'register',                                                                        // 421\n                    'swimmerId': params.swimmerId,                                                               // 422\n                    classId: params.classId                                                                      // 423\n                }                                                                                                // 424\n            }                                                                                                    // 425\n        })                                                                                                       // 426\n    console.log('====delete_class_from_cart step2=====:'+result)                                                 // 427\n                                                                                                                 // 428\n                                                                                                                 // 429\n                                                                                                                 // 430\n                                                                                                                 // 431\n}                                                                                                                // 432\n                                                                                                                 // 433\n/*                                                                                                               // 434\n* cartId  确定购物车                                                                                                  // 435\n* swimmerId classId   确定一个item                                                                                   // 436\n* preferenceNum   确定preference  1，2，3                                                                            // 437\n* classData     新的class数据  classId？                                                                              // 438\n*                                                                                                                // 439\n* */                                                                                                             // 440\nfunction change_preference_in_cart(params){                                                                      // 441\n                                                                                                                 // 442\n    console.log('change_preference_in_cart',params)                                                              // 443\n                                                                                                                 // 444\n    //check 处于active状态                                                                                           // 445\n                                                                                                                 // 446\n    if(params.preferenceNum==1) {                                                                                // 447\n                                                                                                                 // 448\n                                                                                                                 // 449\n        //更新购物车课程 以及状态                                                                                           // 450\n        var result =DB.ShoppingCart.update({                                                                     // 451\n            '_id': params.cartId,                                                                                // 452\n            'items': {                                                                                           // 453\n                $elemMatch: {                                                                                    // 454\n                    'swimmerId': params.swimmerId,                                                               // 455\n                    'classId': params.classId                                                                    // 456\n                }                                                                                                // 457\n            }                                                                                                    // 458\n        }, {                                                                                                     // 459\n            $set: {                                                                                              // 460\n                status: 'pending',                                                                               // 461\n                //'items.$.swimmerId': classData.swimmerId,                                                      // 462\n                'items.$.classId': params.classData.classId,                                                     // 463\n                'items.$.class1': params.classData //class3                                                      // 464\n            }                                                                                                    // 465\n        })                                                                                                       // 466\n        console.log('--step1---result-----',result)                                                              // 467\n                                                                                                                 // 468\n        //恢复已选课程数目                                                                                               // 469\n        result = DB.Classes.update(                                                                              // 470\n            {'_id': params.classId},                                                                             // 471\n            {                                                                                                    // 472\n                '$inc': {'seatsRemain': 1},                                                                      // 473\n                '$pull': {                                                                                       // 474\n                    'carted': {                                                                                  // 475\n                        'type': 'register',                                                                      // 476\n                        'cartId': params.cartId,                                                                 // 477\n                        'swimmerId': params.swimmerId,                                                           // 478\n                        'quantity': 1,                                                                           // 479\n                        //'timestamp': new Date()                                                                // 480\n                    }                                                                                            // 481\n                }                                                                                                // 482\n            })                                                                                                   // 483\n        console.log('--step2---result-----',result)                                                              // 484\n                                                                                                                 // 485\n                                                                                                                 // 486\n        //占用新class的数目                                                                                            // 487\n        result = DB.Classes.update(                                                                              // 488\n            {'_id': params.classId, 'seatsRemain': {'$gte': 1}},                                                 // 489\n            {                                                                                                    // 490\n                '$inc': {'seatsRemain': -1},                                                                     // 491\n                '$push': {                                                                                       // 492\n                    'carted': {                                                                                  // 493\n                        'type': 'register',                                                                      // 494\n                        'cartId': params.cartId,                                                                 // 495\n                        'swimmerId': params.swimmerId,                                                           // 496\n                        'quantity': 1,                                                                           // 497\n                        'timestamp': new Date()                                                                  // 498\n                    }                                                                                            // 499\n                }                                                                                                // 500\n            })                                                                                                   // 501\n                                                                                                                 // 502\n                                                                                                                 // 503\n        if (result)                                                                                              // 504\n        {                                                                                                        // 505\n            DB.ShoppingCart.update(                                                                              // 506\n                {'_id': params.cartId},                                                                          // 507\n                {                                                                                                // 508\n                    '$set': {status: 'active'} //重置为active                                                       // 509\n                })                                                                                               // 510\n            return {cartId: params.cartId}                                                                       // 511\n                                                                                                                 // 512\n        }else {                                                                                                  // 513\n                                                                                                                 // 514\n            //DB.ShoppingCart.update(                                                                            // 515\n            //    {'_id': cart_id},                                                                              // 516\n            //    {                                                                                              // 517\n            //        '$set': {status: 'active'}, //重置为active                                                    // 518\n            //        '$pull': {                                                                                 // 519\n            //            'items': {                                                                             // 520\n            //                'type': 'register',                                                                // 521\n            //                'swimmerId': item.swimmerId,                                                       // 522\n            //                classId: item.classId                                                              // 523\n            //            }                                                                                      // 524\n            //        }                                                                                          // 525\n            //    })                                                                                             // 526\n            //todo 回退逻辑 但这种情况极少发生 一般前端可选 就有相应课程                                                                  // 527\n                                                                                                                 // 528\n            throw new Meteor.Error(500,                                                                          // 529\n                'change_preference 1' + params.cartId + ' error. There is not enough class you are changing to',\n                'DB.Classes.update $push');                                                                      // 531\n                                                                                                                 // 532\n        }                                                                                                        // 533\n                                                                                                                 // 534\n                                                                                                                 // 535\n                                                                                                                 // 536\n                                                                                                                 // 537\n                                                                                                                 // 538\n    } else if(params.preferenceNum==2){                                                                          // 539\n                                                                                                                 // 540\n        DB.ShoppingCart.update({                                                                                 // 541\n            '_id': params.cartId,                                                                                // 542\n            'items': {                                                                                           // 543\n                $elemMatch: {                                                                                    // 544\n                    'swimmerId': params.swimmerId,                                                               // 545\n                    'classId': params.classId                                                                    // 546\n                }                                                                                                // 547\n            }                                                                                                    // 548\n        }, {                                                                                                     // 549\n            $set: {                                                                                              // 550\n                'items.$.class2': params.classData //class3                                                      // 551\n            }                                                                                                    // 552\n        })                                                                                                       // 553\n                                                                                                                 // 554\n                                                                                                                 // 555\n    }else if(params.preferenceNum==3){                                                                           // 556\n                                                                                                                 // 557\n        DB.ShoppingCart.update({                                                                                 // 558\n            '_id': params.cartId,                                                                                // 559\n            'items': {                                                                                           // 560\n                $elemMatch: {                                                                                    // 561\n                    'swimmerId': params.swimmerId,                                                               // 562\n                    'classId': params.classId                                                                    // 563\n                }                                                                                                // 564\n            }                                                                                                    // 565\n        }, {                                                                                                     // 566\n            $set: {                                                                                              // 567\n                'items.$.class3': params.classData //class3                                                      // 568\n            }                                                                                                    // 569\n        })                                                                                                       // 570\n                                                                                                                 // 571\n                                                                                                                 // 572\n    }                                                                                                            // 573\n                                                                                                                 // 574\n                                                                                                                 // 575\n}                                                                                                                // 576\n                                                                                                                 // 577\n                                                                                                                 // 578\n//clear uncompletedShoppingCartItem                                                                              // 579\n//流程中断时 清除课程占用及选课记录                                                                                              // 580\nfunction clear_uncompleted_item_in_cart(){                                                                       // 581\n                                                                                                                 // 582\n    console.log('====clear_uncompleted_item_in_cart===')                                                         // 583\n                                                                                                                 // 584\n    var cart = DB.ShoppingCart.findOne(                                                                          // 585\n        {                                                                                                        // 586\n            status: 'active',                                                                                    // 587\n            type:'register'                                                                                      // 588\n        })                                                                                                       // 589\n                                                                                                                 // 590\n    var items=[]                                                                                                 // 591\n                                                                                                                 // 592\n    //找出未完成的item                                                                                                 // 593\n    if(cart && cart.items){                                                                                      // 594\n        items=_.filter(cart.items,function(item){                                                                // 595\n            return  !(item.class1 && item.class2 && item.class3)                                                 // 596\n        })                                                                                                       // 597\n    }                                                                                                            // 598\n                                                                                                                 // 599\n                                                                                                                 // 600\n                                                                                                                 // 601\n    items.forEach(function(item){                                                                                // 602\n                                                                                                                 // 603\n        delete_class_from_cart({                                                                                 // 604\n            cartId:cart._id,                                                                                     // 605\n            swimmerId: item.swimmerId,                                                                           // 606\n            classId:item.classId                                                                                 // 607\n                                                                                                                 // 608\n        })                                                                                                       // 609\n    })                                                                                                           // 610\n}                                                                                                                // 611\n                                                                                                                 // 612\nshopping_cart_export({                                                                                           // 613\n                                                                                                                 // 614\n    //add_class_register_to_cart: add_class_register_to_cart,                                                    // 615\n    add_item_to_cart: add_item_to_cart,                                                                          // 616\n    add_class_to_cart: add_class_to_cart,                                                                        // 617\n    add_preference_to_cart: add_preference_to_cart,                                                              // 618\n    move_to_checking: move_to_checking,                                                                          // 619\n    move_to_applied: move_to_applied,                                                                            // 620\n    move_to_done: move_to_done,                                                                                  // 621\n                                                                                                                 // 622\n    delete_class_from_cart:delete_class_from_cart,                                                               // 623\n    change_preference_in_cart:change_preference_in_cart,                                                         // 624\n    clear_uncompleted_item_in_cart:clear_uncompleted_item_in_cart                                                // 625\n                                                                                                                 // 626\n})                                                                                                               // 627\n                                                                                                                 // 628\n                                                                                                                 // 629\n                                                                                                                 // 630\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                               //\n// packages/cal_cart/shoppingCart.change.js                                                                      //\n//                                                                                                               //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                 //\n/**                                                                                                              // 1\n * Created on 9/25/15.                                                                                           // 2\n */                                                                                                              // 3\n                                                                                                                 // 4\n                                                                                                                 // 5\n//计算change class的费用  根据正负走不同逻辑                                                                                   // 6\n//若用户仍需补交费用 需限时   占用新class名额                                                                                     // 7\n//                                                                                                               // 8\nchange_caculate_fee = function (swimmerId, fromClassId, toClassId) {                                             // 9\n                                                                                                                 // 10\n                                                                                                                 // 11\n    return -10 //假定需退用户10元                                                                                       // 12\n    //return 10                                                                                                  // 13\n}                                                                                                                // 14\n                                                                                                                 // 15\nchange_create_cart = function(item){                                                                             // 16\n    App.info = App.info || DB.App.findOne()                                                                      // 17\n                                                                                                                 // 18\n    var shoppingCart = {                                                                                         // 19\n        accountId: Meteor.userId(),                                                                              // 20\n        type: 'change',                                                                                          // 21\n        status: 'active',                                                                                        // 22\n        sessionId: App.info.sessionRegister,                                                                     // 23\n        items: item?[item]:[]                                                                                    // 24\n    }                                                                                                            // 25\n                                                                                                                 // 26\n    var cartId = DB.ShoppingCart.insert(shoppingCart);                                                           // 27\n                                                                                                                 // 28\n    return cartId;                                                                                               // 29\n}                                                                                                                // 30\n                                                                                                                 // 31\nchange_get_or_create_active_cart =function(){                                                                    // 32\n                                                                                                                 // 33\n    var cart = DB.ShoppingCart.findOne({                                                                         // 34\n        _id: cartId,                                                                                             // 35\n        accountId: Meteor.userId(),                                                                              // 36\n        type:'change',                                                                                           // 37\n        //15分以内的                                                                                                 // 38\n        lastModified: {$gt: new Date(+new Date() - 15 * 60 * 1000)}                                              // 39\n                                                                                                                 // 40\n    })                                                                                                           // 41\n                                                                                                                 // 42\n    return cart || change_create_cart()                                                                          // 43\n                                                                                                                 // 44\n}                                                                                                                // 45\n                                                                                                                 // 46\n                                                                                                                 // 47\nchange_class=function(swimmerId, fromClassId, toClassId){                                                        // 48\n    var fee = change_caculate_fee(swimmerId, fromClassId, toClassId)                                             // 49\n    if(fee>0){                                                                                                   // 50\n        change_class_due(swimmerId, fromClassId, toClassId)                                                      // 51\n                                                                                                                 // 52\n    }else{//<=0                                                                                                  // 53\n        change_class_refund(swimmerId, fromClassId, toClassId)                                                   // 54\n    }                                                                                                            // 55\n                                                                                                                 // 56\n}                                                                                                                // 57\n                                                                                                                 // 58\n                                                                                                                 // 59\nchange_class_due =function(swimmerId, fromClassId, toClassId){                                                   // 60\n                                                                                                                 // 61\n}                                                                                                                // 62\n                                                                                                                 // 63\nchange_class_refund=function(swimmerId, fromClassId, toClassId){                                                 // 64\n                                                                                                                 // 65\n    ////////////check/////////                                                                                   // 66\n    //确保swimmerId已注册fromClassId 并且未进行 cancel或change操作                                                            // 67\n    var registerItem =DB.ClassesRegister.findOne({                                                               // 68\n        swimmerId:swimmerId,                                                                                     // 69\n        classId:fromClassId                                                                                      // 70\n    })                                                                                                           // 71\n    if(!registerItem){                                                                                           // 72\n        throw new Meteor.Error(500, swimmerId+' did not register class '+fromClassId);                           // 73\n    }else if(registerItem.status!='normal'){                                                                     // 74\n                                                                                                                 // 75\n        throw new Meteor.Error(500, 'class is under status '+registerItem.status);                               // 76\n    }                                                                                                            // 77\n                                                                                                                 // 78\n    //check 数目                                                                                                   // 79\n                                                                                                                 // 80\n                                                                                                                 // 81\n    //////////////////////                                                                                       // 82\n                                                                                                                 // 83\n                                                                                                                 // 84\n    //var cart = change_get_or_create_active_cart()                                                              // 85\n    //var cart_id = cart._id                                                                                     // 86\n                                                                                                                 // 87\n    var cart_id = change_create_cart()                                                                           // 88\n                                                                                                                 // 89\n    console.log('1-----'+cart_id)                                                                                // 90\n                                                                                                                 // 91\n                                                                                                                 // 92\n    //构造改变课程时的item                                                                                               // 93\n    var item = {                                                                                                 // 94\n        type: 'change',                                                                                          // 95\n        swimmerId: swimmerId,                                                                                    // 96\n        fromClassId: fromClassId,                                                                                // 97\n        toClassId: toClassId,                                                                                    // 98\n                                                                                                                 // 99\n        //extra info todo only pick special fields                                                               // 100\n        swimmer: DB.Swimmers.findOne({_id: swimmerId}),                                                          // 101\n        fromClass: DB.Classes.findOne({_id: fromClassId}),                                                       // 102\n        toClass: DB.Classes.findOne({_id: toClassId})                                                            // 103\n                                                                                                                 // 104\n    }                                                                                                            // 105\n                                                                                                                 // 106\n                                                                                                                 // 107\n                                                                                                                 // 108\n    ///////////////////////////////////////////////                                                              // 109\n    //完成change class购物车创建                                                                                        // 110\n    var result = DB.ShoppingCart.update({                                                                        // 111\n        '_id': cart_id                                                                                           // 112\n    }, {                                                                                                         // 113\n        '$set': {status: 'pending'},//已开始事务处里 置为pending  todo touch时间                                            // 114\n        '$push': {                                                                                               // 115\n            'items': item  //item.quantity==1 or -1                                                              // 116\n        }                                                                                                        // 117\n    })                                                                                                           // 118\n                                                                                                                 // 119\n                                                                                                                 // 120\n    console.log('2-----'+result)                                                                                 // 121\n                                                                                                                 // 122\n                                                                                                                 // 123\n    ////////////////////change_move_pending_to_applied/////////////////                                          // 124\n                                                                                                                 // 125\n    //占用一个class  todo 确保$push 唯一                                                                                 // 126\n    //需先查询 todo 确保不存在以前的change历史 否则清理以前的操作                                                                       // 127\n                                                                                                                 // 128\n                                                                                                                 // 129\n    //后面基于 以前未做过相同的change并且因为特殊原因而中断                                                                             // 130\n    result = DB.Classes.update(                                                                                  // 131\n        {                                                                                                        // 132\n            '_id': toClassId,                                                                                    // 133\n            'seatsRemain': {'$gte': 1}                                                                           // 134\n        },                                                                                                       // 135\n        {                                                                                                        // 136\n            '$inc': {'seatsRemain': -1},                                                                         // 137\n            '$push': {                                                                                           // 138\n                'carted': {                                                                                      // 139\n                    'cartId': cart_id,                                                                           // 140\n                                                                                                                 // 141\n                    'type': 'change',                                                                            // 142\n                    'fromClassId': fromClassId,                                                                  // 143\n                    'toClassId': toClassId,                                                                      // 144\n                                                                                                                 // 145\n                    'swimmerId': swimmerId,                                                                      // 146\n                    'quantity': 1,  //change时购物车无数量 class里需要数量 用于恢复时区分是from还是to                                  // 147\n                    'timestamp': new Date()                                                                      // 148\n                }                                                                                                // 149\n            }                                                                                                    // 150\n        })                                                                                                       // 151\n                                                                                                                 // 152\n    console.log('3-----'+result)                                                                                 // 153\n                                                                                                                 // 154\n                                                                                                                 // 155\n    if (!result) {//占用失败 数目不够时                                                                                   // 156\n        DB.ShoppingCart.update(                                                                                  // 157\n            {'_id': cart_id},                                                                                    // 158\n            {                                                                                                    // 159\n                '$set': {status: 'active'}, //重置为active                                                          // 160\n                '$pull': {                                                                                       // 161\n                    'items': {                                                                                   // 162\n                        'type': 'change',                                                                        // 163\n                        'fromClassId': fromClassId,                                                              // 164\n                        'toClassId': toClassId,                                                                  // 165\n                    }                                                                                            // 166\n                }                                                                                                // 167\n            })                                                                                                   // 168\n        //todo 直接删除购物车？                                                                                          // 169\n                                                                                                                 // 170\n        throw new Meteor.Error(500, 'add_class_to_cart error 课程占用失败');                                           // 171\n                                                                                                                 // 172\n    }                                                                                                            // 173\n                                                                                                                 // 174\n    //else {                                                                                                     // 175\n    //    DB.ShoppingCart.update(                                                                                // 176\n    //        {'_id': cart_id},                                                                                  // 177\n    //        {                                                                                                  // 178\n    //            '$set': {status: 'active'} //重置为active                                                         // 179\n    //        })                                                                                                 // 180\n    //    return {cartId: cart_id}                                                                               // 181\n    //}                                                                                                          // 182\n                                                                                                                 // 183\n                                                                                                                 // 184\n                                                                                                                 // 185\n    //标记oldclass                                                                                                 // 186\n    var oldRegister =DB.ClassesRegister.update({                                                                 // 187\n        swimmerId:swimmerId,                                                                                     // 188\n        classId:fromClassId                                                                                      // 189\n    },{                                                                                                          // 190\n        '$set': {status: 'changing'},                                                                            // 191\n        '$push': {                                                                                               // 192\n            'carted':cart_id                                                                                     // 193\n        }                                                                                                        // 194\n    })                                                                                                           // 195\n                                                                                                                 // 196\n                                                                                                                 // 197\n    console.log('4-----'+oldRegister)                                                                            // 198\n    App.info = App.info || DB.App.findOne()                                                                      // 199\n                                                                                                                 // 200\n    // 插入并标记newclass                                                                                             // 201\n    var newRegister =DB.ClassesRegister.insert({                                                                 // 202\n        sessionId: App.info.sessionRegister,                                                                     // 203\n        account:Meteor.userId(),                                                                                 // 204\n        swimmerId:swimmerId,                                                                                     // 205\n        classId:toClassId,                                                                                       // 206\n        cartId:cart_id,                                                                                          // 207\n        status: 'changing',                                                                                      // 208\n        'carted':[cart_id]                                                                                       // 209\n    })                                                                                                           // 210\n                                                                                                                 // 211\n    console.log('5-----'+newRegister)                                                                            // 212\n                                                                                                                 // 213\n                                                                                                                 // 214\n    ////// 到达applied 状态                                                                                          // 215\n    result=DB.ShoppingCart.update(                                                                               // 216\n        {'_id': cart_id},                                                                                        // 217\n        {                                                                                                        // 218\n            '$set': {status: 'applied'} //重置为active                                                              // 219\n        })                                                                                                       // 220\n                                                                                                                 // 221\n    console.log('6-----'+result)                                                                                 // 222\n                                                                                                                 // 223\n                                                                                                                 // 224\n    //已成功退课 清除事务纪录                                                                                               // 225\n    //change_move__applied_to_donejia                                                                            // 226\n    //todo 增加 changed canceled 态保持历史操作？                                                                          // 227\n                                                                                                                 // 228\n                                                                                                                 // 229\n    console.log('change_move__applied_to_done');                                                                 // 230\n                                                                                                                 // 231\n    result =DB.ClassesRegister.remove({                                                                          // 232\n        swimmerId:swimmerId,                                                                                     // 233\n        classId:fromClassId,                                                                                     // 234\n        status:'changing'                                                                                        // 235\n    });                                                                                                          // 236\n    console.log('7-----'+result)                                                                                 // 237\n                                                                                                                 // 238\n    result = DB.ClassesRegister.update({                                                                         // 239\n        swimmerId:swimmerId,                                                                                     // 240\n        classId:toClassId,                                                                                       // 241\n        status:'changing'                                                                                        // 242\n    },{                                                                                                          // 243\n        $set:{status: 'normal'},                                                                                 // 244\n        $pull:{'carted':cart_id}                                                                                 // 245\n    })                                                                                                           // 246\n    console.log('8-----'+result)                                                                                 // 247\n                                                                                                                 // 248\n                                                                                                                 // 249\n    //旧课程数目＋1                                                                                                    // 250\n    result =DB.Classes.update(                                                                                   // 251\n        {                                                                                                        // 252\n            '_id': fromClassId                                                                                   // 253\n        },                                                                                                       // 254\n        {                                                                                                        // 255\n            '$inc': {'seatsRemain': 1}                                                                           // 256\n        })                                                                                                       // 257\n                                                                                                                 // 258\n    console.log('9-----'+result)                                                                                 // 259\n                                                                                                                 // 260\n                                                                                                                 // 261\n    //新课程 清除事务纪录                                                                                                 // 262\n    result =DB.Classes.update(                                                                                   // 263\n        {                                                                                                        // 264\n            '_id': toClassId                                                                                     // 265\n        },                                                                                                       // 266\n        {                                                                                                        // 267\n            '$pull': {                                                                                           // 268\n                'carted': {                                                                                      // 269\n                    'cartId': cart_id,                                                                           // 270\n                                                                                                                 // 271\n                    'type': 'change',                                                                            // 272\n                    'fromClassId': fromClassId,                                                                  // 273\n                    'toClassId': toClassId,                                                                      // 274\n                                                                                                                 // 275\n                    'swimmerId': swimmerId,                                                                      // 276\n                    'quantity': 1  //change时购物车无数量 class里需要数量 用于恢复时区分是from还是to                                   // 277\n                }                                                                                                // 278\n            }                                                                                                    // 279\n        })                                                                                                       // 280\n    console.log('10-----'+result)                                                                                // 281\n                                                                                                                 // 282\n                                                                                                                 // 283\n    result =DB.ShoppingCart.update(                                                                              // 284\n        {'_id': cart_id},                                                                                        // 285\n        {                                                                                                        // 286\n            '$set': {status: 'done'} //重置为active                                                                 // 287\n        })                                                                                                       // 288\n                                                                                                                 // 289\n                                                                                                                 // 290\n    console.log('11-----'+result)                                                                                // 291\n                                                                                                                 // 292\n                                                                                                                 // 293\n                                                                                                                 // 294\n                                                                                                                 // 295\n}                                                                                                                // 296\n                                                                                                                 // 297\n                                                                                                                 // 298\n//pending =>                                                                                                     // 299\nchange_add_class_to_cart = function (swimmerId, fromClassId, toClassId) {                                        // 300\n                                                                                                                 // 301\n}                                                                                                                // 302\n                                                                                                                 // 303\n                                                                                                                 // 304\n/*                                                                                                               // 305\n    1.classes 占用一个fromclass对应的数目                                                                                 // 306\n    2.标记classRegister中 oldclass对应项状态为 changing                                                                   // 307\n                                                                                                                 // 308\n    若用户需支付费用 cart进入 checking状态 根据支付情况以及是否超时进行后面处理                                                                // 309\n                                                                                                                 // 310\n    若需退用户费用 直接标记为applied 走applied＝》done步骤                                                                        // 311\n* */                                                                                                             // 312\nchange_move_pending_to_applied =function(){                                                                      // 313\n                                                                                                                 // 314\n                                                                                                                 // 315\n                                                                                                                 // 316\n                                                                                                                 // 317\n                                                                                                                 // 318\n}                                                                                                                // 319\nchange_move__applied_to_done =function(){                                                                        // 320\n                                                                                                                 // 321\n                                                                                                                 // 322\n}                                                                                                                // 323\n                                                                                                                 // 324\n                                                                                                                 // 325\n///////////////due//////用户欠费的case/////////////////////////////                                                   // 326\n                                                                                                                 // 327\nchange_move_pending_to_checking=function(){                                                                      // 328\n                                                                                                                 // 329\n}                                                                                                                // 330\n//由pending回滚  支付超时 或程序异常 导致停留在checking态                                                                          // 331\nchange_rollback_from_pending =function(){                                                                        // 332\n                                                                                                                 // 333\n}                                                                                                                // 334\n                                                                                                                 // 335\nchange_rollback_from_checking=function(){                                                                        // 336\n                                                                                                                 // 337\n}                                                                                                                // 338\n                                                                                                                 // 339\nchange_checking_to_applied=function(){                                                                           // 340\n                                                                                                                 // 341\n}                                                                                                                // 342\n                                                                                                                 // 343\n                                                                                                                 // 344\n                                                                                                                 // 345\nshopping_cart_export({                                                                                           // 346\n    //add_class_change_to_cart: change_add_class_to_cart                                                         // 347\n    change_class:change_class                                                                                    // 348\n})                                                                                                               // 349\n                                                                                                                 // 350\n                                                                                                                 // 351\n                                                                                                                 // 352\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                               //\n// packages/cal_cart/shoppingCart.cancel.js                                                                      //\n//                                                                                                               //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                 //\n/**                                                                                                              // 1\n * Created on 9/25/15.                                                                                           // 2\n */                                                                                                              // 3\n                                                                                                                 // 4\n                                                                                                                 // 5\n                                                                                                                 // 6\n/*                                                                                                               // 7\n                                                                                                                 // 8\n    canceling<--[middle]--> applied-->done                                                                       // 9\n                                                                                                                 // 10\n* */                                                                                                             // 11\n                                                                                                                 // 12\n//canceling                                                                                                      // 13\ncancel_create_cart = function (item) {                                                                           // 14\n    var shoppingCart = {                                                                                         // 15\n        accountId: Meteor.userId(),                                                                              // 16\n        type: 'cancel',                                                                                          // 17\n        status: 'canceling',                                                                                     // 18\n        sessionId: App.info.sessionRegister,                                                                     // 19\n        items: item?[item]:[]                                                                                    // 20\n    }                                                                                                            // 21\n                                                                                                                 // 22\n    var cartId = DB.ShoppingCart.insert(shoppingCart);                                                           // 23\n                                                                                                                 // 24\n    return cartId;                                                                                               // 25\n                                                                                                                 // 26\n    //return DB.ShoppingCart.findOne({_id: cartId});                                                             // 27\n}                                                                                                                // 28\n                                                                                                                 // 29\n//取消课程 先退费再恢复课程数量   cancel 付费后再 恢复class数量                                                                        // 30\ncancel_add_class_to_cart = function (swimmerId, classId) {                                                       // 31\n    //check swimmer belong to current account todo                                                               // 32\n    //check 用户已注册该课程                                                                                             // 33\n    App.info = App.info || DB.App.findOne()                                                                      // 34\n                                                                                                                 // 35\n    var classReg = DB.ClassesRegister.findOne({                                                                  // 36\n        swimmerId: swimmerId,                                                                                    // 37\n        classId: classId,                                                                                        // 38\n        sessionId: App.info.sessionRegister                                                                      // 39\n    })                                                                                                           // 40\n                                                                                                                 // 41\n    if (!classReg) {                                                                                             // 42\n        throw new Meteor.Error(500, 'add_class_cancel_to_cart:class not exist');                                 // 43\n    }                                                                                                            // 44\n                                                                                                                 // 45\n    ////////create item data                                                                                     // 46\n    var item = {                                                                                                 // 47\n        type: 'cancel',                                                                                          // 48\n        classId: classId,                                                                                        // 49\n        swimmerId: swimmerId,                                                                                    // 50\n        quantity: -1,                                                                                            // 51\n                                                                                                                 // 52\n        //extra info todo only pick special fields                                                               // 53\n        swimmer: DB.Swimmers.findOne({_id: swimmerId}),                                                          // 54\n        class: DB.Classes.findOne({_id: classId})                                                                // 55\n    }                                                                                                            // 56\n                                                                                                                 // 57\n    /////step1 加入购物车                                                                                             // 58\n    var cart_id = cancel_create_cart(item)                                                                       // 59\n                                                                                                                 // 60\n    //var result = DB.ShoppingCart.update({                                                                      // 61\n    //    '_id': cart_id                                                                                         // 62\n    //}, {                                                                                                       // 63\n    //    '$set': {status: 'pending'},//已开始事务处里 置为pending                                                        // 64\n    //    '$push': {                                                                                             // 65\n    //        'items': item                                                                                      // 66\n    //    }                                                                                                      // 67\n    //})                                                                                                         // 68\n                                                                                                                 // 69\n                                                                                                                 // 70\n    cancel_move_canceling_to_applied(cart_id, item)                                                              // 71\n                                                                                                                 // 72\n                                                                                                                 // 73\n}                                                                                                                // 74\n                                                                                                                 // 75\n                                                                                                                 // 76\n//canceling=>applied 若需canceling恢复执行同样调用此函数                                                                      // 77\ncancel_move_canceling_to_applied = function (cart_id, item) {                                                    // 78\n                                                                                                                 // 79\n    //step2更新商品数量                                                                                                // 80\n    var result = DB.Classes.update(                                                                              // 81\n        {                                                                                                        // 82\n            '_id': item.classId//,                                                                               // 83\n            //'carted.swimmerId' and type                                                                        // 84\n            //'seatsRemain': {'$gte': item.quantity}                                                             // 85\n            //todo add condition to prevent duplicate $push                                                      // 86\n        },                                                                                                       // 87\n        {                                                                                                        // 88\n            '$inc': {'seatsRemain': -item.quantity},                                                             // 89\n            '$push': {                                                                                           // 90\n                'carted': {                                                                                      // 91\n                    'type': 'cancel',                                                                            // 92\n                    'cartId': cart_id,                                                                           // 93\n                    'swimmerId': item.swimmerId,                                                                 // 94\n                    'quantity': item.quantity,                                                                   // 95\n                    'timestamp': new Date()                                                                      // 96\n                }                                                                                                // 97\n            }                                                                                                    // 98\n        })                                                                                                       // 99\n                                                                                                                 // 100\n                                                                                                                 // 101\n    /////标记registerClass项为 canceling                                                                             // 102\n    var result = DB.ClassesRegister.update({                                                                     // 103\n        'classId': item.classId,                                                                                 // 104\n        'swimmerId': item.swimmerId                                                                              // 105\n    }, {                                                                                                         // 106\n        '$set': {status: 'canceling'}//已开始事务处里 置为pending                                                         // 107\n    })                                                                                                           // 108\n                                                                                                                 // 109\n                                                                                                                 // 110\n}                                                                                                                // 111\n                                                                                                                 // 112\n                                                                                                                 // 113\n//canceling未到达applied状态而中断 回滚逻辑 逆操作                                                                              // 114\ncancel_move_canceling_to_applied_rollback =function(){                                                           // 115\n                                                                                                                 // 116\n                                                                                                                 // 117\n}                                                                                                                // 118\n                                                                                                                 // 119\n//applied_to_done  退款后的清理工作                                                                                      // 120\n//删除 classRegister 项                                                                                             // 121\n//删除 classRegister 中的carted项                                                                                     // 122\ncancel_move_applied_to_done = function () {                                                                      // 123\n                                                                                                                 // 124\n                                                                                                                 // 125\n}                                                                                                                // 126\n                                                                                                                 // 127\n                                                                                                                 // 128\nshopping_cart_export({                                                                                           // 129\n    cancel_add_class_to_cart: cancel_add_class_to_cart                                                           // 130\n})                                                                                                               // 131\n                                                                                                                 // 132\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                               //\n// packages/cal_cart/shoppingCart.cron.js                                                                        //\n//                                                                                                               //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                 //\n/**                                                                                                              // 1\n * Created on 9/25/15.                                                                                           // 2\n */                                                                                                              // 3\n                                                                                                                 // 4\n                                                                                                                 // 5\n//////////////////////定时任务/////////////////////////////                                                          // 6\n//后续处理  此过程若中断 可由定时程序确保其完成                                                                                       // 7\nfunction cron_move_applied_to_done() {                                                                           // 8\n    if (this.connection) return;                                                                                 // 9\n                                                                                                                 // 10\n    var allCarts = get_carts({'status': 'applied'})                                                              // 11\n                                                                                                                 // 12\n    //可能有多个cart                                                                                                  // 13\n    allCarts.forEach(function (cart) {                                                                           // 14\n        _move_to_done(cart)                                                                                      // 15\n    })                                                                                                           // 16\n}                                                                                                                // 17\n//定时程序调用 走 expired状态流程                                                                                           // 18\nfunction cron_expiring() {                                                                                       // 19\n                                                                                                                 // 20\n                                                                                                                 // 21\n}                                                                                                                // 22\n                                                                                                                 // 23\n                                                                                                                 // 24\nshopping_cart_export({                                                                                           // 25\n    cron_move_applied_to_done: cron_move_applied_to_done,                                                        // 26\n    cron_expiring: cron_expiring                                                                                 // 27\n})                                                                                                               // 28\n                                                                                                                 // 29\n                                                                                                                 // 30\n                                                                                                                 // 31\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nif (typeof Package === 'undefined') Package = {};\nPackage['cal:cart'] = {\n  shoppingCart: shoppingCart\n};\n\n})();\n","servePath":"/packages/cal_cart.js","sourceMap":{"version":3,"sources":["/packages/cal_cart/shoppingCart.common.js","/packages/cal_cart/shoppingCart.register.js","/packages/cal_cart/shoppingCart.change.js","/packages/cal_cart/shoppingCart.cancel.js","/packages/cal_cart/shoppingCart.cron.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uH;;;;;;;;;;;;;;;;;;AC5JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uH;;;;;;;;;;;;;;;;;;ACrnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uH;;;;;;;;;;;;;;;;;;AC/VA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uH;;;;;;;;;;;;;;;;;;ACnIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sH","file":"/packages/cal_cart.js","sourcesContent":["/**\n * Created on 9/25/15.\n */\n\n\n\nshoppingCart = {};\n\n//a utils\nshopping_cart_export=function(obj){\n    for(var x in obj){\n\n        if(obj.hasOwnProperty(x)){\n\n            if(shoppingCart[x]){\n                throw x+\" is duplicated\";\n            }\n            shoppingCart[x] =obj[x]\n        }\n    }\n}\n/////////////////////////////////////////////////////////\n\n////package scope\n\n//{type:'register'}\ncommon_create_cart = function (params) {\n\n    App.info = App.info || DB.App.findOne()\n\n    var shoppingCart = {\n        status: 'active',\n        accountId: Meteor.userId(),\n        type: params.type,\n        sessionId: App.info.sessionRegister,\n        items: params.item ? [params.item] : []\n    }\n\n    var cartId = DB.ShoppingCart.insert(shoppingCart);\n\n    return DB.ShoppingCart.findOne({_id: cartId});\n\n}\n\n\n//{type:'register'}\ncommon_get_or_create_active_cart = function (params) {\n\n    var cart = DB.ShoppingCart.findOne({\n        accountId: Meteor.userId(),\n        status: 'active',\n        type: params.type,\n        lastModified: {$gt: new Date(+new Date() - 15 * 60 * 1000)}\n\n\n    })\n\n    return cart || create_cart({status: 'active', type: params.type})\n}\n\n\ncommon_check_cart_status =function (cartId, status) {\n\n    //todo 加入时间计算\n    var cart = DB.ShoppingCart.findOne({\n        _id: cartId,\n        accountId: Meteor.userId(),\n        status: status\n    })\n\n    return !!(cart && cart._id)\n\n}\n\n\n\n\n\n\n///////////////////old to delete///////////////////\ncreate_cart = function (item) {\n    App.info = App.info || DB.App.findOne()\n\n    var shoppingCart = {\n        status: 'active',\n        accountId: Meteor.userId(),\n        sessionId: App.info.sessionRegister,\n        items: item ? [item] : []\n    }\n\n    var cartId = DB.ShoppingCart.insert(shoppingCart);\n\n    return cartId;\n\n}\n\n//todo pending且未超时状态下 恢复为active的逻辑\nget_active_cart_id =function (createIfNotExist) {\n\n    var cart = DB.ShoppingCart.findOne({ //todo 加入时间计算\n        accountId: Meteor.userId(),\n        status: 'active'\n    })\n\n    //console.log(cart)\n\n    return (cart && cart._id) || (createIfNotExist && create_cart());\n}\n\nget_carts = function (status) {\n    App.info = App.info || DB.App.findOne()\n\n    var options = {\n        accountId: Meteor.userId(),\n        sessionId: App.info.sessionRegister,\n    }\n    status = status | {}\n\n    options = _.extend(options, status)\n\n    var carts = DB.ShoppingCart.find(options).fetch()\n    return carts;\n}\n\n\n//package scope\ncheckCartStatus =function (cartId, status) {\n\n    //todo 加入时间计算\n    var cart = DB.ShoppingCart.findOne({\n        _id: cartId,\n        accountId: Meteor.userId(),\n        status: status\n    })\n\n    return !!(cart && cart._id)\n\n}\n\n\n\n\nshopping_cart_export({\n    //create_cart: create_cart,\n    get_or_create_active_cart: common_get_or_create_active_cart,\n    check_cart_status: common_check_cart_status,\n\n\n    ////////old/////\n    create_cart: create_cart,\n    get_active_cart_id: get_active_cart_id,\n    get_carts: get_carts,\n    checkCartStatus: checkCartStatus\n})\n\n\n","/**\n * Created on 9/25/15.\n */\n\n\n\nregister_add_class_to_cart = function (classId) {\n\n\n}\nregister_add_preference_to_cart = function () {\n\n\n}\n\nfunction add_item_to_cart(item) {\n\n\n}\n\n//cart中 单个swimmer添加的课程的数量\nfunction get_class_count_in_cart(cartId, swimmerId) {\n    var cart = DB.ShoppingCart.findOne({\n        _id: cartId\n    })\n    if (!cart)throw new Meteor.Error(500, 'in get_class_count_in_cart', 'cart not exist ' + cartId)\n\n    var items = cart.items\n    var count = 0\n\n    items.forEach(function (item) {\n        if (item.swimmerId == swimmerId) count++\n    })\n\n    return count;\n}\n//用于检查是否已经注册过该课程\nfunction get_class_count_in_register(swimmerId, classId, sessionId) {\n    App.info = App.info || DB.App.findOne()\n\n    sessionId = sessionId || App.info.sessionRegister\n\n    var count = DB.ClassesRegister.find({\n        swimmerId:swimmerId,\n        classId:classId,\n        sessionId: sessionId\n    }).count()\n\n    return count;\n}\n\n//==============================================================\n//////////////////////old////////////////////////////\n//注册课程 先占用课程数量\n\n\n/////////////////////////////////////////////\n//{swimmerId,classId, quantity , swimmer,  class1, ...}\nfunction add_class_to_cart(item) {\n\n\n    //////////////////////////////////\n    //check 参数\n    if (!item || !item.classId) {\n        throw new Meteor.Error('param invalid', 'in add_class_to_cart', item);\n    }\n\n    ////////////////////////////////////\n    //check class可注册数目\n    var classItem = DB.Classes.findOne({\n        _id: item.classId\n    })\n    if (classItem.seatsRemain < 1) {\n        throw new Meteor.Error('ERROR_CLASS_NOT_ENOUGH', 'in add_class_to_cart');\n    }\n\n\n    ///////////////////////////////////\n    //获取或创建购物车\n    var cart_id = get_active_cart_id(true)\n    if (!cart_id) {\n        throw new Meteor.Error(500,\n            'add_class_to_cart  error',\n            'get_active_cart_id: ' + cart_id);\n    }\n    console.log('get_active_cart_id ' + cart_id);\n\n\n    //////////////////////////////////////////\n    //check 检测购物车是否已有该class\n    var cart = DB.ShoppingCart.findOne(\n        {\n            _id: cart_id,\n            status: 'active',\n            items: {\n                $elemMatch: {\n                    'swimmerId': item.swimmerId,\n                    'classId': item.classId\n\n                }\n            }\n        })\n\n    if (cart) {\n        throw new Meteor.Error('ERROR_CLASS_ALREADY_IN_CART', 'in add_class_to_cart');\n    }\n    console.log('check if cart exist', cart,item.swimmerId,item.classId)\n\n\n    //////////////////////////////////////////////////\n    /////////check 单次 一个swimmer最多注册3节\n    var classCount = get_class_count_in_cart(cart_id, item.swimmerId);\n    if (classCount == 3) {\n        throw new Meteor.Error('ERROR_CLASS_ALREADY_3_IN_CART', 'in add_class_to_cart');\n    }\n\n    if(get_class_count_in_register(item.swimmerId, item.classId)){\n        throw new Meteor.Error('ERROR_CLASS_ALREADY_REGISTERED', 'in add_class_to_cart');\n\n    }\n\n\n    /////////////加入购物车///////////\n    var result;\n    result = DB.ShoppingCart.update({//todo 1门课仅可注册一个； 最多注册3门\n        '_id': cart_id\n    }, {\n        '$set': {status: 'pending'},//已开始事务处里 置为pending\n        '$push': {\n            'items': item  //item.quantity==1 or -1\n        }\n    })\n\n    if (!result) {\n        throw new Meteor.Error(500, 'add_class_to_cart error', 'DB.ShoppingCart.update $push');\n    }\n    ;\n\n    //此时处于pending状态 若此处中断 若超时由定时程序清理，继续往下进行 todo恢复逻辑\n\n    //可能数量不够 //todo 1门课仅可注册一个； 最多注册3门 ;确保多次操作结果唯一\n    result = DB.Classes.update(\n        {'_id': item.classId, 'seatsRemain': {'$gte': item.quantity}},\n        {\n            '$inc': {'seatsRemain': -item.quantity},\n            '$push': {\n                'carted': {\n                    'type': 'register',\n                    'cartId': cart_id,\n                    'swimmerId': item.swimmerId,\n                    'quantity': item.quantity,\n                    'timestamp': new Date()\n                }\n            }\n        })\n\n    //todo result判断仅适用第一次加入 恢复操作不再适用\n    if (!result) {\n        DB.ShoppingCart.update(\n            {'_id': cart_id},\n            {\n                '$set': {status: 'active'}, //重置为active\n                '$pull': {\n                    'items': {\n                        //'type': 'register',\n                        'swimmerId': item.swimmerId,\n                        classId: item.classId\n                    }\n                }\n            })\n\n        throw new Meteor.Error(500,\n            'add_class_to_cart ' + cart_id + ' error. There is not enough class to register?',\n            'DB.Classes.update $push');\n\n    } else {\n        DB.ShoppingCart.update(\n            {'_id': cart_id},\n            {\n                '$set': {status: 'active'} //重置为active\n            })\n        return {cartId: cart_id}\n    }\n\n}\n\n//添加两个备选\n/*\n *\n * {\n * cartId\n *\n * classId,  定位到class\n * swimmerId 定位到swimmer\n *\n * preferenceNum,\n * data {item}\n * ,\n * , }\n * */\nfunction add_preference_to_cart(p) {\n\n    //var cartId = get_active_cart_id();\n    var cartId = p.cartId\n    if (!checkCartStatus(cartId, 'active')) {\n        throw new Meteor.Error(500, cartId + ' is not active');\n    }\n\n\n    //console.log(p)\n\n    if (!cartId) return 'cartId not exist';\n\n\n    /*\n     http://docs.mongodb.org/manual/reference/operator/projection/positional/#proj._S_\n     {\n     '_id': p.cartId,\n     'items.swimmer._id': p.swimmer._id,\n     'items.class1._id': p.class1._id\n     }\n     在一个swimmer选择多个class时总是匹配第一个  $elemMatch不存在这个问题\n     * */\n\n    if (p.preferenceNum == 2) {\n        DB.ShoppingCart.update({\n            '_id': cartId,\n            'items': {\n                $elemMatch: {\n                    'swimmerId': p.swimmerId,\n                    'classId': p.classId\n\n                }\n            }\n        }, {\n            $set: {\n                'items.$.class2': p.data  //class2\n            }\n        })\n    }\n    if (p.preferenceNum == 3) {\n        DB.ShoppingCart.update({\n            '_id': cartId,\n            'items': {\n                $elemMatch: {\n                    'swimmerId': p.swimmerId,\n                    'classId': p.classId\n                }\n            }\n        }, {\n            $set: {\n                'items.$.class3': p.data //class3\n            }\n        })\n    }\n}\n\n//当用户触发pay－now 或 pay－in－store时\nfunction move_to_checking(cartId, checkoutType) {\n    //todo check payType value\n\n    //var cartId = get_active_cart_id()\n    if (!checkCartStatus(cartId, 'active')) {\n        throw new Meteor.Error(500, cartId + ' is not active');\n    }\n\n\n    var result = DB.ShoppingCart.update({\n        '_id': cartId,\n        status: 'active'\n    }, {\n        '$set': {\n            'checkoutType': checkoutType,\n            'status': 'checking'\n        }\n\n    })\n\n    if (!result) {\n        throw new Meteor.Error(500, 'move_to_checking error');\n\n    }\n\n    return {status: 'success'}\n\n}\n\n//支付成功后调用此过程\n//在店里通过后台 或根据支付网关的回调 设置为已支付  同时触发后续处理过程\nfunction move_to_applied(cartId) {\n    //todo check to make sure paied\n\n    if (!checkCartStatus(cartId, 'checking')) {\n        throw new Meteor.Error(500, cartId + ' is not in status of checking');\n    }\n\n\n    DB.ShoppingCart.update({\n        '_id': cartId,\n        'status': 'checking'\n    }, {\n        '$set': {status: 'applied'} //\n\n    })\n\n    move_to_done(cartId)\n}\n\nfunction move_to_done(cartId) {\n\n    if (!checkCartStatus(cartId, 'applied')) {\n        throw new Meteor.Error(500, cartId + ' is not in status of applied');\n    }\n\n    var cart = DB.ShoppingCart.findOne({ //todo optimize\n        _id: cartId\n    })\n\n    //console.log(cart)\n\n    _move_to_done(cart)\n}\n\n//private\n//cart status [apllied]=>[done]\nfunction _move_to_done(cart) {\n\n    if (typeof cart === 'string') {\n\n    }\n\n\n    //todo test  mongodb 多个class 一个cart有多个item是否都可以删除\n    DB.Classes.update({\n        'carted.cartId': cart._id\n    }, {\n        '$pull': {\n            'carted': {cartId: cart._id}\n        }\n    }, {multi: true})\n\n\n    cart.items.forEach(function (item) {\n\n        if (item.quantity == 1) {//注册 todo using type\n\n            //insert the document if it does not exist\n            DB.ClassesRegister.update({\n                swimmerId: item.swimmerId,\n                classId: item.classId,\n                status: 'normal',\n\n                accountId: cart.accountId,\n                sessionId: cart.sessionId,\n                cartId: cart._id\n            }, {\n                $set: {\n                    registerTime: cart.lastModified\n                }\n            }, {\n                upsert: true //insert if not found\n            })\n\n\n        } else if (item.quantity == -1) {//取消注册 todo using type\n            DB.ClassesRegister.remove({\n                swimmerId: item.swimmerId,\n                classId: item.classId,\n\n                sessionId: cart.sessionId,\n                cartId: cart._id\n            })\n\n        } else if (item.type == 'change') {\n\n\n        }\n    })\n\n    //以上过程非异步 完成之后\n    DB.ShoppingCart.update({\n        '_id': cart._id,\n        'status': 'applied'\n    }, {\n        '$set': {status: 'done'} //\n    })\n\n}\n\n\n//{cartId, swimmerId,classId}\nfunction delete_class_from_cart(params){\n\n    console.log('====delete_class_from_cart params=====:',params)\n\n\n    //恢复class数目\n    result = DB.Classes.update(\n        {'_id': params.classId},\n        {\n            '$inc': {'seatsRemain': 1},\n            '$pull': {\n                'carted': {\n                    'type': 'register',\n                    'cartId': params.cartId,\n                    'swimmerId': params.swimmerId,\n                    'quantity': 1,\n                    //'timestamp': new Date()\n                }\n            }\n        })\n    console.log('====delete_class_from_cart [restore class] step1=====:'+result)\n\n    //从购物车删除\n    var result = DB.ShoppingCart.update(\n        {'_id': params.cartId},\n        {\n            '$set': {status: 'active'}, //重置为active\n            '$pull': {\n                'items': {\n                    //'type': 'register',\n                    'swimmerId': params.swimmerId,\n                    classId: params.classId\n                }\n            }\n        })\n    console.log('====delete_class_from_cart step2=====:'+result)\n\n\n\n\n}\n\n/*\n* cartId  确定购物车\n* swimmerId classId   确定一个item\n* preferenceNum   确定preference  1，2，3\n* classData     新的class数据  classId？\n*\n* */\nfunction change_preference_in_cart(params){\n\n    console.log('change_preference_in_cart',params)\n\n    //check 处于active状态\n\n    if(params.preferenceNum==1) {\n\n\n        //更新购物车课程 以及状态\n        var result =DB.ShoppingCart.update({\n            '_id': params.cartId,\n            'items': {\n                $elemMatch: {\n                    'swimmerId': params.swimmerId,\n                    'classId': params.classId\n                }\n            }\n        }, {\n            $set: {\n                status: 'pending',\n                //'items.$.swimmerId': classData.swimmerId,\n                'items.$.classId': params.classData.classId,\n                'items.$.class1': params.classData //class3\n            }\n        })\n        console.log('--step1---result-----',result)\n\n        //恢复已选课程数目\n        result = DB.Classes.update(\n            {'_id': params.classId},\n            {\n                '$inc': {'seatsRemain': 1},\n                '$pull': {\n                    'carted': {\n                        'type': 'register',\n                        'cartId': params.cartId,\n                        'swimmerId': params.swimmerId,\n                        'quantity': 1,\n                        //'timestamp': new Date()\n                    }\n                }\n            })\n        console.log('--step2---result-----',result)\n\n\n        //占用新class的数目\n        result = DB.Classes.update(\n            {'_id': params.classId, 'seatsRemain': {'$gte': 1}},\n            {\n                '$inc': {'seatsRemain': -1},\n                '$push': {\n                    'carted': {\n                        'type': 'register',\n                        'cartId': params.cartId,\n                        'swimmerId': params.swimmerId,\n                        'quantity': 1,\n                        'timestamp': new Date()\n                    }\n                }\n            })\n\n\n        if (result)\n        {\n            DB.ShoppingCart.update(\n                {'_id': params.cartId},\n                {\n                    '$set': {status: 'active'} //重置为active\n                })\n            return {cartId: params.cartId}\n\n        }else {\n\n            //DB.ShoppingCart.update(\n            //    {'_id': cart_id},\n            //    {\n            //        '$set': {status: 'active'}, //重置为active\n            //        '$pull': {\n            //            'items': {\n            //                'type': 'register',\n            //                'swimmerId': item.swimmerId,\n            //                classId: item.classId\n            //            }\n            //        }\n            //    })\n            //todo 回退逻辑 但这种情况极少发生 一般前端可选 就有相应课程\n\n            throw new Meteor.Error(500,\n                'change_preference 1' + params.cartId + ' error. There is not enough class you are changing to',\n                'DB.Classes.update $push');\n\n        }\n\n\n\n\n\n    } else if(params.preferenceNum==2){\n\n        DB.ShoppingCart.update({\n            '_id': params.cartId,\n            'items': {\n                $elemMatch: {\n                    'swimmerId': params.swimmerId,\n                    'classId': params.classId\n                }\n            }\n        }, {\n            $set: {\n                'items.$.class2': params.classData //class3\n            }\n        })\n\n\n    }else if(params.preferenceNum==3){\n\n        DB.ShoppingCart.update({\n            '_id': params.cartId,\n            'items': {\n                $elemMatch: {\n                    'swimmerId': params.swimmerId,\n                    'classId': params.classId\n                }\n            }\n        }, {\n            $set: {\n                'items.$.class3': params.classData //class3\n            }\n        })\n\n\n    }\n\n\n}\n\n\n//clear uncompletedShoppingCartItem\n//流程中断时 清除课程占用及选课记录\nfunction clear_uncompleted_item_in_cart(){\n\n    console.log('====clear_uncompleted_item_in_cart===')\n\n    var cart = DB.ShoppingCart.findOne(\n        {\n            status: 'active',\n            type:'register'\n        })\n\n    var items=[]\n\n    //找出未完成的item\n    if(cart && cart.items){\n        items=_.filter(cart.items,function(item){\n            return  !(item.class1 && item.class2 && item.class3)\n        })\n    }\n\n\n\n    items.forEach(function(item){\n\n        delete_class_from_cart({\n            cartId:cart._id,\n            swimmerId: item.swimmerId,\n            classId:item.classId\n\n        })\n    })\n}\n\nshopping_cart_export({\n\n    //add_class_register_to_cart: add_class_register_to_cart,\n    add_item_to_cart: add_item_to_cart,\n    add_class_to_cart: add_class_to_cart,\n    add_preference_to_cart: add_preference_to_cart,\n    move_to_checking: move_to_checking,\n    move_to_applied: move_to_applied,\n    move_to_done: move_to_done,\n\n    delete_class_from_cart:delete_class_from_cart,\n    change_preference_in_cart:change_preference_in_cart,\n    clear_uncompleted_item_in_cart:clear_uncompleted_item_in_cart\n\n})\n\n\n","/**\n * Created on 9/25/15.\n */\n\n\n//计算change class的费用  根据正负走不同逻辑\n//若用户仍需补交费用 需限时   占用新class名额\n//\nchange_caculate_fee = function (swimmerId, fromClassId, toClassId) {\n\n\n    return -10 //假定需退用户10元\n    //return 10\n}\n\nchange_create_cart = function(item){\n    App.info = App.info || DB.App.findOne()\n\n    var shoppingCart = {\n        accountId: Meteor.userId(),\n        type: 'change',\n        status: 'active',\n        sessionId: App.info.sessionRegister,\n        items: item?[item]:[]\n    }\n\n    var cartId = DB.ShoppingCart.insert(shoppingCart);\n\n    return cartId;\n}\n\nchange_get_or_create_active_cart =function(){\n\n    var cart = DB.ShoppingCart.findOne({\n        _id: cartId,\n        accountId: Meteor.userId(),\n        type:'change',\n        //15分以内的\n        lastModified: {$gt: new Date(+new Date() - 15 * 60 * 1000)}\n\n    })\n\n    return cart || change_create_cart()\n\n}\n\n\nchange_class=function(swimmerId, fromClassId, toClassId){\n    var fee = change_caculate_fee(swimmerId, fromClassId, toClassId)\n    if(fee>0){\n        change_class_due(swimmerId, fromClassId, toClassId)\n\n    }else{//<=0\n        change_class_refund(swimmerId, fromClassId, toClassId)\n    }\n\n}\n\n\nchange_class_due =function(swimmerId, fromClassId, toClassId){\n\n}\n\nchange_class_refund=function(swimmerId, fromClassId, toClassId){\n\n    ////////////check/////////\n    //确保swimmerId已注册fromClassId 并且未进行 cancel或change操作\n    var registerItem =DB.ClassesRegister.findOne({\n        swimmerId:swimmerId,\n        classId:fromClassId\n    })\n    if(!registerItem){\n        throw new Meteor.Error(500, swimmerId+' did not register class '+fromClassId);\n    }else if(registerItem.status!='normal'){\n\n        throw new Meteor.Error(500, 'class is under status '+registerItem.status);\n    }\n\n    //check 数目\n\n\n    //////////////////////\n\n\n    //var cart = change_get_or_create_active_cart()\n    //var cart_id = cart._id\n\n    var cart_id = change_create_cart()\n\n    console.log('1-----'+cart_id)\n\n\n    //构造改变课程时的item\n    var item = {\n        type: 'change',\n        swimmerId: swimmerId,\n        fromClassId: fromClassId,\n        toClassId: toClassId,\n\n        //extra info todo only pick special fields\n        swimmer: DB.Swimmers.findOne({_id: swimmerId}),\n        fromClass: DB.Classes.findOne({_id: fromClassId}),\n        toClass: DB.Classes.findOne({_id: toClassId})\n\n    }\n\n\n\n    ///////////////////////////////////////////////\n    //完成change class购物车创建\n    var result = DB.ShoppingCart.update({\n        '_id': cart_id\n    }, {\n        '$set': {status: 'pending'},//已开始事务处里 置为pending  todo touch时间\n        '$push': {\n            'items': item  //item.quantity==1 or -1\n        }\n    })\n\n\n    console.log('2-----'+result)\n\n\n    ////////////////////change_move_pending_to_applied/////////////////\n\n    //占用一个class  todo 确保$push 唯一\n    //需先查询 todo 确保不存在以前的change历史 否则清理以前的操作\n\n\n    //后面基于 以前未做过相同的change并且因为特殊原因而中断\n    result = DB.Classes.update(\n        {\n            '_id': toClassId,\n            'seatsRemain': {'$gte': 1}\n        },\n        {\n            '$inc': {'seatsRemain': -1},\n            '$push': {\n                'carted': {\n                    'cartId': cart_id,\n\n                    'type': 'change',\n                    'fromClassId': fromClassId,\n                    'toClassId': toClassId,\n\n                    'swimmerId': swimmerId,\n                    'quantity': 1,  //change时购物车无数量 class里需要数量 用于恢复时区分是from还是to\n                    'timestamp': new Date()\n                }\n            }\n        })\n\n    console.log('3-----'+result)\n\n\n    if (!result) {//占用失败 数目不够时\n        DB.ShoppingCart.update(\n            {'_id': cart_id},\n            {\n                '$set': {status: 'active'}, //重置为active\n                '$pull': {\n                    'items': {\n                        'type': 'change',\n                        'fromClassId': fromClassId,\n                        'toClassId': toClassId,\n                    }\n                }\n            })\n        //todo 直接删除购物车？\n\n        throw new Meteor.Error(500, 'add_class_to_cart error 课程占用失败');\n\n    }\n\n    //else {\n    //    DB.ShoppingCart.update(\n    //        {'_id': cart_id},\n    //        {\n    //            '$set': {status: 'active'} //重置为active\n    //        })\n    //    return {cartId: cart_id}\n    //}\n\n\n\n    //标记oldclass\n    var oldRegister =DB.ClassesRegister.update({\n        swimmerId:swimmerId,\n        classId:fromClassId\n    },{\n        '$set': {status: 'changing'},\n        '$push': {\n            'carted':cart_id\n        }\n    })\n\n\n    console.log('4-----'+oldRegister)\n    App.info = App.info || DB.App.findOne()\n\n    // 插入并标记newclass\n    var newRegister =DB.ClassesRegister.insert({\n        sessionId: App.info.sessionRegister,\n        account:Meteor.userId(),\n        swimmerId:swimmerId,\n        classId:toClassId,\n        cartId:cart_id,\n        status: 'changing',\n        'carted':[cart_id]\n    })\n\n    console.log('5-----'+newRegister)\n\n\n    ////// 到达applied 状态\n    result=DB.ShoppingCart.update(\n        {'_id': cart_id},\n        {\n            '$set': {status: 'applied'} //重置为active\n        })\n\n    console.log('6-----'+result)\n\n\n    //已成功退课 清除事务纪录\n    //change_move__applied_to_donejia\n    //todo 增加 changed canceled 态保持历史操作？\n\n\n    console.log('change_move__applied_to_done');\n\n    result =DB.ClassesRegister.remove({\n        swimmerId:swimmerId,\n        classId:fromClassId,\n        status:'changing'\n    });\n    console.log('7-----'+result)\n\n    result = DB.ClassesRegister.update({\n        swimmerId:swimmerId,\n        classId:toClassId,\n        status:'changing'\n    },{\n        $set:{status: 'normal'},\n        $pull:{'carted':cart_id}\n    })\n    console.log('8-----'+result)\n\n\n    //旧课程数目＋1\n    result =DB.Classes.update(\n        {\n            '_id': fromClassId\n        },\n        {\n            '$inc': {'seatsRemain': 1}\n        })\n\n    console.log('9-----'+result)\n\n\n    //新课程 清除事务纪录\n    result =DB.Classes.update(\n        {\n            '_id': toClassId\n        },\n        {\n            '$pull': {\n                'carted': {\n                    'cartId': cart_id,\n\n                    'type': 'change',\n                    'fromClassId': fromClassId,\n                    'toClassId': toClassId,\n\n                    'swimmerId': swimmerId,\n                    'quantity': 1  //change时购物车无数量 class里需要数量 用于恢复时区分是from还是to\n                }\n            }\n        })\n    console.log('10-----'+result)\n\n\n    result =DB.ShoppingCart.update(\n        {'_id': cart_id},\n        {\n            '$set': {status: 'done'} //重置为active\n        })\n\n\n    console.log('11-----'+result)\n\n\n\n\n}\n\n\n//pending =>\nchange_add_class_to_cart = function (swimmerId, fromClassId, toClassId) {\n\n}\n\n\n/*\n    1.classes 占用一个fromclass对应的数目\n    2.标记classRegister中 oldclass对应项状态为 changing\n\n    若用户需支付费用 cart进入 checking状态 根据支付情况以及是否超时进行后面处理\n\n    若需退用户费用 直接标记为applied 走applied＝》done步骤\n* */\nchange_move_pending_to_applied =function(){\n\n\n\n\n\n}\nchange_move__applied_to_done =function(){\n\n\n}\n\n\n///////////////due//////用户欠费的case/////////////////////////////\n\nchange_move_pending_to_checking=function(){\n\n}\n//由pending回滚  支付超时 或程序异常 导致停留在checking态\nchange_rollback_from_pending =function(){\n\n}\n\nchange_rollback_from_checking=function(){\n\n}\n\nchange_checking_to_applied=function(){\n\n}\n\n\n\nshopping_cart_export({\n    //add_class_change_to_cart: change_add_class_to_cart\n    change_class:change_class\n})\n\n\n","/**\n * Created on 9/25/15.\n */\n\n\n\n/*\n\n    canceling<--[middle]--> applied-->done\n\n* */\n\n//canceling\ncancel_create_cart = function (item) {\n    var shoppingCart = {\n        accountId: Meteor.userId(),\n        type: 'cancel',\n        status: 'canceling',\n        sessionId: App.info.sessionRegister,\n        items: item?[item]:[]\n    }\n\n    var cartId = DB.ShoppingCart.insert(shoppingCart);\n\n    return cartId;\n\n    //return DB.ShoppingCart.findOne({_id: cartId});\n}\n\n//取消课程 先退费再恢复课程数量   cancel 付费后再 恢复class数量\ncancel_add_class_to_cart = function (swimmerId, classId) {\n    //check swimmer belong to current account todo\n    //check 用户已注册该课程\n    App.info = App.info || DB.App.findOne()\n\n    var classReg = DB.ClassesRegister.findOne({\n        swimmerId: swimmerId,\n        classId: classId,\n        sessionId: App.info.sessionRegister\n    })\n\n    if (!classReg) {\n        throw new Meteor.Error(500, 'add_class_cancel_to_cart:class not exist');\n    }\n\n    ////////create item data\n    var item = {\n        type: 'cancel',\n        classId: classId,\n        swimmerId: swimmerId,\n        quantity: -1,\n\n        //extra info todo only pick special fields\n        swimmer: DB.Swimmers.findOne({_id: swimmerId}),\n        class: DB.Classes.findOne({_id: classId})\n    }\n\n    /////step1 加入购物车\n    var cart_id = cancel_create_cart(item)\n\n    //var result = DB.ShoppingCart.update({\n    //    '_id': cart_id\n    //}, {\n    //    '$set': {status: 'pending'},//已开始事务处里 置为pending\n    //    '$push': {\n    //        'items': item\n    //    }\n    //})\n\n\n    cancel_move_canceling_to_applied(cart_id, item)\n\n\n}\n\n\n//canceling=>applied 若需canceling恢复执行同样调用此函数\ncancel_move_canceling_to_applied = function (cart_id, item) {\n\n    //step2更新商品数量\n    var result = DB.Classes.update(\n        {\n            '_id': item.classId//,\n            //'carted.swimmerId' and type\n            //'seatsRemain': {'$gte': item.quantity}\n            //todo add condition to prevent duplicate $push\n        },\n        {\n            '$inc': {'seatsRemain': -item.quantity},\n            '$push': {\n                'carted': {\n                    'type': 'cancel',\n                    'cartId': cart_id,\n                    'swimmerId': item.swimmerId,\n                    'quantity': item.quantity,\n                    'timestamp': new Date()\n                }\n            }\n        })\n\n\n    /////标记registerClass项为 canceling\n    var result = DB.ClassesRegister.update({\n        'classId': item.classId,\n        'swimmerId': item.swimmerId\n    }, {\n        '$set': {status: 'canceling'}//已开始事务处里 置为pending\n    })\n\n\n}\n\n\n//canceling未到达applied状态而中断 回滚逻辑 逆操作\ncancel_move_canceling_to_applied_rollback =function(){\n\n\n}\n\n//applied_to_done  退款后的清理工作\n//删除 classRegister 项\n//删除 classRegister 中的carted项\ncancel_move_applied_to_done = function () {\n\n\n}\n\n\nshopping_cart_export({\n    cancel_add_class_to_cart: cancel_add_class_to_cart\n})\n","/**\n * Created on 9/25/15.\n */\n\n\n//////////////////////定时任务/////////////////////////////\n//后续处理  此过程若中断 可由定时程序确保其完成\nfunction cron_move_applied_to_done() {\n    if (this.connection) return;\n\n    var allCarts = get_carts({'status': 'applied'})\n\n    //可能有多个cart\n    allCarts.forEach(function (cart) {\n        _move_to_done(cart)\n    })\n}\n//定时程序调用 走 expired状态流程\nfunction cron_expiring() {\n\n\n}\n\n\nshopping_cart_export({\n    cron_move_applied_to_done: cron_move_applied_to_done,\n    cron_expiring: cron_expiring\n})\n\n\n"]}}]