[{"type":"js","data":"(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar NpmModuleBcrypt = Package['npm-bcrypt'].NpmModuleBcrypt;\nvar Accounts = Package['accounts-base'].Accounts;\nvar AccountsServer = Package['accounts-base'].AccountsServer;\nvar SRP = Package.srp.SRP;\nvar SHA256 = Package.sha.SHA256;\nvar EJSON = Package.ejson.EJSON;\nvar DDP = Package['ddp-client'].DDP;\nvar DDPServer = Package['ddp-server'].DDPServer;\nvar Email = Package.email.Email;\nvar EmailInternals = Package.email.EmailInternals;\nvar Random = Package.random.Random;\nvar check = Package.check.check;\nvar Match = Package.check.Match;\nvar _ = Package.underscore._;\n\n(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                         //\n// packages/accounts-password/packages/accounts-password.js                                                //\n//                                                                                                         //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                           //\n(function(){                                                                                               // 1\n                                                                                                           // 2\n/////////////////////////////////////////////////////////////////////////////////////////////////////      // 3\n//                                                                                                 //      // 4\n// packages/accounts-password/email_templates.js                                                   //      // 5\n//                                                                                                 //      // 6\n/////////////////////////////////////////////////////////////////////////////////////////////////////      // 7\n                                                                                                   //      // 8\n/**                                                                                                // 1    // 9\n * @summary Options to customize emails sent from the Accounts system.                             // 2    // 10\n * @locus Server                                                                                   // 3    // 11\n */                                                                                                // 4    // 12\nAccounts.emailTemplates = {                                                                        // 5    // 13\n  from: \"Meteor Accounts <no-reply@meteor.com>\",                                                   // 6    // 14\n  siteName: Meteor.absoluteUrl().replace(/^https?:\\/\\//, '').replace(/\\/$/, ''),                   // 7    // 15\n                                                                                                   // 8    // 16\n  resetPassword: {                                                                                 // 9    // 17\n    subject: function(user) {                                                                      // 10   // 18\n      return \"How to reset your password on \" + Accounts.emailTemplates.siteName;                  // 11   // 19\n    },                                                                                             // 12   // 20\n    text: function(user, url) {                                                                    // 13   // 21\n      var greeting = (user.profile && user.profile.name) ?                                         // 14   // 22\n            (\"Hello \" + user.profile.name + \",\") : \"Hello,\";                                       // 15   // 23\n      return greeting + \"\\n\"                                                                       // 16   // 24\n        + \"\\n\"                                                                                     // 17   // 25\n        + \"To reset your password, simply click the link below.\\n\"                                 // 18   // 26\n        + \"\\n\"                                                                                     // 19   // 27\n        + url + \"\\n\"                                                                               // 20   // 28\n        + \"\\n\"                                                                                     // 21   // 29\n        + \"Thanks.\\n\";                                                                             // 22   // 30\n    }                                                                                              // 23   // 31\n  },                                                                                               // 24   // 32\n  verifyEmail: {                                                                                   // 25   // 33\n    subject: function(user) {                                                                      // 26   // 34\n      return \"How to verify email address on \" + Accounts.emailTemplates.siteName;                 // 27   // 35\n    },                                                                                             // 28   // 36\n    text: function(user, url) {                                                                    // 29   // 37\n      var greeting = (user.profile && user.profile.name) ?                                         // 30   // 38\n            (\"Hello \" + user.profile.name + \",\") : \"Hello,\";                                       // 31   // 39\n      return greeting + \"\\n\"                                                                       // 32   // 40\n        + \"\\n\"                                                                                     // 33   // 41\n        + \"To verify your account email, simply click the link below.\\n\"                           // 34   // 42\n        + \"\\n\"                                                                                     // 35   // 43\n        + url + \"\\n\"                                                                               // 36   // 44\n        + \"\\n\"                                                                                     // 37   // 45\n        + \"Thanks.\\n\";                                                                             // 38   // 46\n    }                                                                                              // 39   // 47\n  },                                                                                               // 40   // 48\n  enrollAccount: {                                                                                 // 41   // 49\n    subject: function(user) {                                                                      // 42   // 50\n      return \"An account has been created for you on \" + Accounts.emailTemplates.siteName;         // 43   // 51\n    },                                                                                             // 44   // 52\n    text: function(user, url) {                                                                    // 45   // 53\n      var greeting = (user.profile && user.profile.name) ?                                         // 46   // 54\n            (\"Hello \" + user.profile.name + \",\") : \"Hello,\";                                       // 47   // 55\n      return greeting + \"\\n\"                                                                       // 48   // 56\n        + \"\\n\"                                                                                     // 49   // 57\n        + \"To start using the service, simply click the link below.\\n\"                             // 50   // 58\n        + \"\\n\"                                                                                     // 51   // 59\n        + url + \"\\n\"                                                                               // 52   // 60\n        + \"\\n\"                                                                                     // 53   // 61\n        + \"Thanks.\\n\";                                                                             // 54   // 62\n    }                                                                                              // 55   // 63\n  }                                                                                                // 56   // 64\n};                                                                                                 // 57   // 65\n                                                                                                   // 58   // 66\n/////////////////////////////////////////////////////////////////////////////////////////////////////      // 67\n                                                                                                           // 68\n}).call(this);                                                                                             // 69\n                                                                                                           // 70\n                                                                                                           // 71\n                                                                                                           // 72\n                                                                                                           // 73\n                                                                                                           // 74\n                                                                                                           // 75\n(function(){                                                                                               // 76\n                                                                                                           // 77\n/////////////////////////////////////////////////////////////////////////////////////////////////////      // 78\n//                                                                                                 //      // 79\n// packages/accounts-password/password_server.js                                                   //      // 80\n//                                                                                                 //      // 81\n/////////////////////////////////////////////////////////////////////////////////////////////////////      // 82\n                                                                                                   //      // 83\n/// BCRYPT                                                                                         // 1    // 84\n                                                                                                   // 2    // 85\nvar bcrypt = NpmModuleBcrypt;                                                                      // 3    // 86\nvar bcryptHash = Meteor.wrapAsync(bcrypt.hash);                                                    // 4    // 87\nvar bcryptCompare = Meteor.wrapAsync(bcrypt.compare);                                              // 5    // 88\n                                                                                                   // 6    // 89\n// User records have a 'services.password.bcrypt' field on them to hold                            // 7    // 90\n// their hashed passwords (unless they have a 'services.password.srp'                              // 8    // 91\n// field, in which case they will be upgraded to bcrypt the next time                              // 9    // 92\n// they log in).                                                                                   // 10   // 93\n//                                                                                                 // 11   // 94\n// When the client sends a password to the server, it can either be a                              // 12   // 95\n// string (the plaintext password) or an object with keys 'digest' and                             // 13   // 96\n// 'algorithm' (must be \"sha-256\" for now). The Meteor client always sends                         // 14   // 97\n// password objects { digest: *, algorithm: \"sha-256\" }, but DDP clients                           // 15   // 98\n// that don't have access to SHA can just send plaintext passwords as                              // 16   // 99\n// strings.                                                                                        // 17   // 100\n//                                                                                                 // 18   // 101\n// When the server receives a plaintext password as a string, it always                            // 19   // 102\n// hashes it with SHA256 before passing it into bcrypt. When the server                            // 20   // 103\n// receives a password as an object, it asserts that the algorithm is                              // 21   // 104\n// \"sha-256\" and then passes the digest to bcrypt.                                                 // 22   // 105\n                                                                                                   // 23   // 106\n                                                                                                   // 24   // 107\nAccounts._bcryptRounds = 10;                                                                       // 25   // 108\n                                                                                                   // 26   // 109\n// Given a 'password' from the client, extract the string that we should                           // 27   // 110\n// bcrypt. 'password' can be one of:                                                               // 28   // 111\n//  - String (the plaintext password)                                                              // 29   // 112\n//  - Object with 'digest' and 'algorithm' keys. 'algorithm' must be \"sha-256\".                    // 30   // 113\n//                                                                                                 // 31   // 114\nvar getPasswordString = function (password) {                                                      // 32   // 115\n  if (typeof password === \"string\") {                                                              // 33   // 116\n    password = SHA256(password);                                                                   // 34   // 117\n  } else { // 'password' is an object                                                              // 35   // 118\n    if (password.algorithm !== \"sha-256\") {                                                        // 36   // 119\n      throw new Error(\"Invalid password hash algorithm. \" +                                        // 37   // 120\n                      \"Only 'sha-256' is allowed.\");                                               // 38   // 121\n    }                                                                                              // 39   // 122\n    password = password.digest;                                                                    // 40   // 123\n  }                                                                                                // 41   // 124\n  return password;                                                                                 // 42   // 125\n};                                                                                                 // 43   // 126\n                                                                                                   // 44   // 127\n// Use bcrypt to hash the password for storage in the database.                                    // 45   // 128\n// `password` can be a string (in which case it will be run through                                // 46   // 129\n// SHA256 before bcrypt) or an object with properties `digest` and                                 // 47   // 130\n// `algorithm` (in which case we bcrypt `password.digest`).                                        // 48   // 131\n//                                                                                                 // 49   // 132\nvar hashPassword = function (password) {                                                           // 50   // 133\n  password = getPasswordString(password);                                                          // 51   // 134\n  return bcryptHash(password, Accounts._bcryptRounds);                                             // 52   // 135\n};                                                                                                 // 53   // 136\n                                                                                                   // 54   // 137\n// Check whether the provided password matches the bcrypt'ed password in                           // 55   // 138\n// the database user record. `password` can be a string (in which case                             // 56   // 139\n// it will be run through SHA256 before bcrypt) or an object with                                  // 57   // 140\n// properties `digest` and `algorithm` (in which case we bcrypt                                    // 58   // 141\n// `password.digest`).                                                                             // 59   // 142\n//                                                                                                 // 60   // 143\nAccounts._checkPassword = function (user, password) {                                              // 61   // 144\n  var result = {                                                                                   // 62   // 145\n    userId: user._id                                                                               // 63   // 146\n  };                                                                                               // 64   // 147\n                                                                                                   // 65   // 148\n  password = getPasswordString(password);                                                          // 66   // 149\n                                                                                                   // 67   // 150\n  if (! bcryptCompare(password, user.services.password.bcrypt)) {                                  // 68   // 151\n    result.error = new Meteor.Error(403, \"Incorrect password\");                                    // 69   // 152\n  }                                                                                                // 70   // 153\n                                                                                                   // 71   // 154\n  return result;                                                                                   // 72   // 155\n};                                                                                                 // 73   // 156\nvar checkPassword = Accounts._checkPassword;                                                       // 74   // 157\n                                                                                                   // 75   // 158\n///                                                                                                // 76   // 159\n/// LOGIN                                                                                          // 77   // 160\n///                                                                                                // 78   // 161\n                                                                                                   // 79   // 162\nAccounts._findUserByQuery = function (query) {                                                     // 80   // 163\n  var user = null;                                                                                 // 81   // 164\n                                                                                                   // 82   // 165\n  if (query.id) {                                                                                  // 83   // 166\n    user = Meteor.users.findOne({ _id: query.id });                                                // 84   // 167\n  } else {                                                                                         // 85   // 168\n    var fieldName;                                                                                 // 86   // 169\n    var fieldValue;                                                                                // 87   // 170\n    if (query.username) {                                                                          // 88   // 171\n      fieldName = 'username';                                                                      // 89   // 172\n      fieldValue = query.username;                                                                 // 90   // 173\n    } else if (query.email) {                                                                      // 91   // 174\n      fieldName = 'emails.address';                                                                // 92   // 175\n      fieldValue = query.email;                                                                    // 93   // 176\n    } else {                                                                                       // 94   // 177\n      throw new Error(\"shouldn't happen (validation missed something)\");                           // 95   // 178\n    }                                                                                              // 96   // 179\n    var selector = {};                                                                             // 97   // 180\n    selector[fieldName] = fieldValue;                                                              // 98   // 181\n    user = Meteor.users.findOne(selector);                                                         // 99   // 182\n    // If user is not found, try a case insensitive lookup                                         // 100  // 183\n    if (!user) {                                                                                   // 101  // 184\n      selector = selectorForFastCaseInsensitiveLookup(fieldName, fieldValue);                      // 102  // 185\n      var candidateUsers = Meteor.users.find(selector).fetch();                                    // 103  // 186\n      // No match if multiple candidates are found                                                 // 104  // 187\n      if (candidateUsers.length === 1) {                                                           // 105  // 188\n        user = candidateUsers[0];                                                                  // 106  // 189\n      }                                                                                            // 107  // 190\n    }                                                                                              // 108  // 191\n  }                                                                                                // 109  // 192\n                                                                                                   // 110  // 193\n  return user;                                                                                     // 111  // 194\n};                                                                                                 // 112  // 195\n                                                                                                   // 113  // 196\n/**                                                                                                // 114  // 197\n * @summary Finds the user with the specified username.                                            // 115  // 198\n * First tries to match username case sensitively; if that fails, it                               // 116  // 199\n * tries case insensitively; but if more than one user matches the case                            // 117  // 200\n * insensitive search, it returns null.                                                            // 118  // 201\n * @locus Server                                                                                   // 119  // 202\n * @param {String} username The username to look for                                               // 120  // 203\n * @returns {Object} A user if found, else null                                                    // 121  // 204\n */                                                                                                // 122  // 205\nAccounts.findUserByUsername = function (username) {                                                // 123  // 206\n  return Accounts._findUserByQuery({                                                               // 124  // 207\n    username: username                                                                             // 125  // 208\n  });                                                                                              // 126  // 209\n};                                                                                                 // 127  // 210\n                                                                                                   // 128  // 211\n/**                                                                                                // 129  // 212\n * @summary Finds the user with the specified email.                                               // 130  // 213\n * First tries to match email case sensitively; if that fails, it                                  // 131  // 214\n * tries case insensitively; but if more than one user matches the case                            // 132  // 215\n * insensitive search, it returns null.                                                            // 133  // 216\n * @locus Server                                                                                   // 134  // 217\n * @param {String} email The email address to look for                                             // 135  // 218\n * @returns {Object} A user if found, else null                                                    // 136  // 219\n */                                                                                                // 137  // 220\nAccounts.findUserByEmail = function (email) {                                                      // 138  // 221\n  return Accounts._findUserByQuery({                                                               // 139  // 222\n    email: email                                                                                   // 140  // 223\n  });                                                                                              // 141  // 224\n};                                                                                                 // 142  // 225\n                                                                                                   // 143  // 226\n// Generates a MongoDB selector that can be used to perform a fast case                            // 144  // 227\n// insensitive lookup for the given fieldName and string. Since MongoDB does                       // 145  // 228\n// not support case insensitive indexes, and case insensitive regex queries                        // 146  // 229\n// are slow, we construct a set of prefix selectors for all permutations of                        // 147  // 230\n// the first 4 characters ourselves. We first attempt to matching against                          // 148  // 231\n// these, and because 'prefix expression' regex queries do use indexes (see                        // 149  // 232\n// http://docs.mongodb.org/v2.6/reference/operator/query/regex/#index-use),                        // 150  // 233\n// this has been found to greatly improve performance (from 1200ms to 5ms in a                     // 151  // 234\n// test with 1.000.000 users).                                                                     // 152  // 235\nvar selectorForFastCaseInsensitiveLookup = function (fieldName, string) {                          // 153  // 236\n  // Performance seems to improve up to 4 prefix characters                                        // 154  // 237\n  var prefix = string.substring(0, Math.min(string.length, 4));                                    // 155  // 238\n  var orClause = _.map(generateCasePermutationsForString(prefix),                                  // 156  // 239\n    function (prefixPermutation) {                                                                 // 157  // 240\n      var selector = {};                                                                           // 158  // 241\n      selector[fieldName] =                                                                        // 159  // 242\n        new RegExp('^' + Meteor._escapeRegExp(prefixPermutation));                                 // 160  // 243\n      return selector;                                                                             // 161  // 244\n    });                                                                                            // 162  // 245\n  var caseInsensitiveClause = {};                                                                  // 163  // 246\n  caseInsensitiveClause[fieldName] =                                                               // 164  // 247\n    new RegExp('^' + Meteor._escapeRegExp(string) + '$', 'i')                                      // 165  // 248\n  return {$and: [{$or: orClause}, caseInsensitiveClause]};                                         // 166  // 249\n}                                                                                                  // 167  // 250\n                                                                                                   // 168  // 251\n// Generates permutations of all case variations of a given string.                                // 169  // 252\nvar generateCasePermutationsForString = function (string) {                                        // 170  // 253\n  var permutations = [''];                                                                         // 171  // 254\n  for (var i = 0; i < string.length; i++) {                                                        // 172  // 255\n    var ch = string.charAt(i);                                                                     // 173  // 256\n    permutations = _.flatten(_.map(permutations, function (prefix) {                               // 174  // 257\n      var lowerCaseChar = ch.toLowerCase();                                                        // 175  // 258\n      var upperCaseChar = ch.toUpperCase();                                                        // 176  // 259\n      // Don't add unneccesary permutations when ch is not a letter                                // 177  // 260\n      if (lowerCaseChar === upperCaseChar) {                                                       // 178  // 261\n        return [prefix + ch];                                                                      // 179  // 262\n      } else {                                                                                     // 180  // 263\n        return [prefix + lowerCaseChar, prefix + upperCaseChar];                                   // 181  // 264\n      }                                                                                            // 182  // 265\n    }));                                                                                           // 183  // 266\n  }                                                                                                // 184  // 267\n  return permutations;                                                                             // 185  // 268\n}                                                                                                  // 186  // 269\n                                                                                                   // 187  // 270\nvar checkForCaseInsensitiveDuplicates = function (fieldName, displayName, fieldValue, ownUserId) {         // 271\n  // Some tests need the ability to add users with the same case insensitive                       // 189  // 272\n  // value, hence the _skipCaseInsensitiveChecksForTest check                                      // 190  // 273\n  var skipCheck = _.has(Accounts._skipCaseInsensitiveChecksForTest, fieldValue);                   // 191  // 274\n                                                                                                   // 192  // 275\n  if (fieldValue && !skipCheck) {                                                                  // 193  // 276\n    var matchedUsers = Meteor.users.find(                                                          // 194  // 277\n      selectorForFastCaseInsensitiveLookup(fieldName, fieldValue)).fetch();                        // 195  // 278\n                                                                                                   // 196  // 279\n    if (matchedUsers.length > 0 &&                                                                 // 197  // 280\n        // If we don't have a userId yet, any match we find is a duplicate                         // 198  // 281\n        (!ownUserId ||                                                                             // 199  // 282\n        // Otherwise, check to see if there are multiple matches or a match                        // 200  // 283\n        // that is not us                                                                          // 201  // 284\n        (matchedUsers.length > 1 || matchedUsers[0]._id !== ownUserId))) {                         // 202  // 285\n      throw new Meteor.Error(403, displayName + \" already exists.\");                               // 203  // 286\n    }                                                                                              // 204  // 287\n  }                                                                                                // 205  // 288\n};                                                                                                 // 206  // 289\n                                                                                                   // 207  // 290\n// XXX maybe this belongs in the check package                                                     // 208  // 291\nvar NonEmptyString = Match.Where(function (x) {                                                    // 209  // 292\n  check(x, String);                                                                                // 210  // 293\n  return x.length > 0;                                                                             // 211  // 294\n});                                                                                                // 212  // 295\n                                                                                                   // 213  // 296\nvar userQueryValidator = Match.Where(function (user) {                                             // 214  // 297\n  check(user, {                                                                                    // 215  // 298\n    id: Match.Optional(NonEmptyString),                                                            // 216  // 299\n    username: Match.Optional(NonEmptyString),                                                      // 217  // 300\n    email: Match.Optional(NonEmptyString)                                                          // 218  // 301\n  });                                                                                              // 219  // 302\n  if (_.keys(user).length !== 1)                                                                   // 220  // 303\n    throw new Match.Error(\"User property must have exactly one field\");                            // 221  // 304\n  return true;                                                                                     // 222  // 305\n});                                                                                                // 223  // 306\n                                                                                                   // 224  // 307\nvar passwordValidator = Match.OneOf(                                                               // 225  // 308\n  String,                                                                                          // 226  // 309\n  { digest: String, algorithm: String }                                                            // 227  // 310\n);                                                                                                 // 228  // 311\n                                                                                                   // 229  // 312\n// Handler to login with a password.                                                               // 230  // 313\n//                                                                                                 // 231  // 314\n// The Meteor client sets options.password to an object with keys                                  // 232  // 315\n// 'digest' (set to SHA256(password)) and 'algorithm' (\"sha-256\").                                 // 233  // 316\n//                                                                                                 // 234  // 317\n// For other DDP clients which don't have access to SHA, the handler                               // 235  // 318\n// also accepts the plaintext password in options.password as a string.                            // 236  // 319\n//                                                                                                 // 237  // 320\n// (It might be nice if servers could turn the plaintext password                                  // 238  // 321\n// option off. Or maybe it should be opt-in, not opt-out?                                          // 239  // 322\n// Accounts.config option?)                                                                        // 240  // 323\n//                                                                                                 // 241  // 324\n// Note that neither password option is secure without SSL.                                        // 242  // 325\n//                                                                                                 // 243  // 326\nAccounts.registerLoginHandler(\"password\", function (options) {                                     // 244  // 327\n  if (! options.password || options.srp)                                                           // 245  // 328\n    return undefined; // don't handle                                                              // 246  // 329\n                                                                                                   // 247  // 330\n  check(options, {                                                                                 // 248  // 331\n    user: userQueryValidator,                                                                      // 249  // 332\n    password: passwordValidator                                                                    // 250  // 333\n  });                                                                                              // 251  // 334\n                                                                                                   // 252  // 335\n                                                                                                   // 253  // 336\n  var user = Accounts._findUserByQuery(options.user);                                              // 254  // 337\n  if (!user)                                                                                       // 255  // 338\n    throw new Meteor.Error(403, \"User not found\");                                                 // 256  // 339\n                                                                                                   // 257  // 340\n  if (!user.services || !user.services.password ||                                                 // 258  // 341\n      !(user.services.password.bcrypt || user.services.password.srp))                              // 259  // 342\n    throw new Meteor.Error(403, \"User has no password set\");                                       // 260  // 343\n                                                                                                   // 261  // 344\n  if (!user.services.password.bcrypt) {                                                            // 262  // 345\n    if (typeof options.password === \"string\") {                                                    // 263  // 346\n      // The client has presented a plaintext password, and the user is                            // 264  // 347\n      // not upgraded to bcrypt yet. We don't attempt to tell the client                           // 265  // 348\n      // to upgrade to bcrypt, because it might be a standalone DDP                                // 266  // 349\n      // client doesn't know how to do such a thing.                                               // 267  // 350\n      var verifier = user.services.password.srp;                                                   // 268  // 351\n      var newVerifier = SRP.generateVerifier(options.password, {                                   // 269  // 352\n        identity: verifier.identity, salt: verifier.salt});                                        // 270  // 353\n                                                                                                   // 271  // 354\n      if (verifier.verifier !== newVerifier.verifier) {                                            // 272  // 355\n        return {                                                                                   // 273  // 356\n          userId: user._id,                                                                        // 274  // 357\n          error: new Meteor.Error(403, \"Incorrect password\")                                       // 275  // 358\n        };                                                                                         // 276  // 359\n      }                                                                                            // 277  // 360\n                                                                                                   // 278  // 361\n      return {userId: user._id};                                                                   // 279  // 362\n    } else {                                                                                       // 280  // 363\n      // Tell the client to use the SRP upgrade process.                                           // 281  // 364\n      throw new Meteor.Error(400, \"old password format\", EJSON.stringify({                         // 282  // 365\n        format: 'srp',                                                                             // 283  // 366\n        identity: user.services.password.srp.identity                                              // 284  // 367\n      }));                                                                                         // 285  // 368\n    }                                                                                              // 286  // 369\n  }                                                                                                // 287  // 370\n                                                                                                   // 288  // 371\n  return checkPassword(                                                                            // 289  // 372\n    user,                                                                                          // 290  // 373\n    options.password                                                                               // 291  // 374\n  );                                                                                               // 292  // 375\n});                                                                                                // 293  // 376\n                                                                                                   // 294  // 377\n// Handler to login using the SRP upgrade path. To use this login                                  // 295  // 378\n// handler, the client must provide:                                                               // 296  // 379\n//   - srp: H(identity + \":\" + password)                                                           // 297  // 380\n//   - password: a string or an object with properties 'digest' and 'algorithm'                    // 298  // 381\n//                                                                                                 // 299  // 382\n// We use `options.srp` to verify that the client knows the correct                                // 300  // 383\n// password without doing a full SRP flow. Once we've checked that, we                             // 301  // 384\n// upgrade the user to bcrypt and remove the SRP information from the                              // 302  // 385\n// user document.                                                                                  // 303  // 386\n//                                                                                                 // 304  // 387\n// The client ends up using this login handler after trying the normal                             // 305  // 388\n// login handler (above), which throws an error telling the client to                              // 306  // 389\n// try the SRP upgrade path.                                                                       // 307  // 390\n//                                                                                                 // 308  // 391\n// XXX COMPAT WITH 0.8.1.3                                                                         // 309  // 392\nAccounts.registerLoginHandler(\"password\", function (options) {                                     // 310  // 393\n  if (!options.srp || !options.password)                                                           // 311  // 394\n    return undefined; // don't handle                                                              // 312  // 395\n                                                                                                   // 313  // 396\n  check(options, {                                                                                 // 314  // 397\n    user: userQueryValidator,                                                                      // 315  // 398\n    srp: String,                                                                                   // 316  // 399\n    password: passwordValidator                                                                    // 317  // 400\n  });                                                                                              // 318  // 401\n                                                                                                   // 319  // 402\n  var user = Accounts._findUserByQuery(options.user);                                              // 320  // 403\n  if (!user)                                                                                       // 321  // 404\n    throw new Meteor.Error(403, \"User not found\");                                                 // 322  // 405\n                                                                                                   // 323  // 406\n  // Check to see if another simultaneous login has already upgraded                               // 324  // 407\n  // the user record to bcrypt.                                                                    // 325  // 408\n  if (user.services && user.services.password && user.services.password.bcrypt)                    // 326  // 409\n    return checkPassword(user, options.password);                                                  // 327  // 410\n                                                                                                   // 328  // 411\n  if (!(user.services && user.services.password && user.services.password.srp))                    // 329  // 412\n    throw new Meteor.Error(403, \"User has no password set\");                                       // 330  // 413\n                                                                                                   // 331  // 414\n  var v1 = user.services.password.srp.verifier;                                                    // 332  // 415\n  var v2 = SRP.generateVerifier(                                                                   // 333  // 416\n    null,                                                                                          // 334  // 417\n    {                                                                                              // 335  // 418\n      hashedIdentityAndPassword: options.srp,                                                      // 336  // 419\n      salt: user.services.password.srp.salt                                                        // 337  // 420\n    }                                                                                              // 338  // 421\n  ).verifier;                                                                                      // 339  // 422\n  if (v1 !== v2)                                                                                   // 340  // 423\n    return {                                                                                       // 341  // 424\n      userId: user._id,                                                                            // 342  // 425\n      error: new Meteor.Error(403, \"Incorrect password\")                                           // 343  // 426\n    };                                                                                             // 344  // 427\n                                                                                                   // 345  // 428\n  // Upgrade to bcrypt on successful login.                                                        // 346  // 429\n  var salted = hashPassword(options.password);                                                     // 347  // 430\n  Meteor.users.update(                                                                             // 348  // 431\n    user._id,                                                                                      // 349  // 432\n    {                                                                                              // 350  // 433\n      $unset: { 'services.password.srp': 1 },                                                      // 351  // 434\n      $set: { 'services.password.bcrypt': salted }                                                 // 352  // 435\n    }                                                                                              // 353  // 436\n  );                                                                                               // 354  // 437\n                                                                                                   // 355  // 438\n  return {userId: user._id};                                                                       // 356  // 439\n});                                                                                                // 357  // 440\n                                                                                                   // 358  // 441\n                                                                                                   // 359  // 442\n///                                                                                                // 360  // 443\n/// CHANGING                                                                                       // 361  // 444\n///                                                                                                // 362  // 445\n                                                                                                   // 363  // 446\n/**                                                                                                // 364  // 447\n * @summary Change a user's username. Use this instead of updating the                             // 365  // 448\n * database directly. The operation will fail if there is an existing user                         // 366  // 449\n * with a username only differing in case.                                                         // 367  // 450\n * @locus Server                                                                                   // 368  // 451\n * @param {String} userId The ID of the user to update.                                            // 369  // 452\n * @param {String} newUsername A new username for the user.                                        // 370  // 453\n */                                                                                                // 371  // 454\nAccounts.setUsername = function (userId, newUsername) {                                            // 372  // 455\n  check(userId, NonEmptyString);                                                                   // 373  // 456\n  check(newUsername, NonEmptyString);                                                              // 374  // 457\n                                                                                                   // 375  // 458\n  var user = Meteor.users.findOne(userId);                                                         // 376  // 459\n  if (!user)                                                                                       // 377  // 460\n    throw new Meteor.Error(403, \"User not found\");                                                 // 378  // 461\n                                                                                                   // 379  // 462\n  var oldUsername = user.username;                                                                 // 380  // 463\n                                                                                                   // 381  // 464\n  // Perform a case insensitive check fro duplicates before update                                 // 382  // 465\n  checkForCaseInsensitiveDuplicates('username', 'Username', newUsername, user._id);                // 383  // 466\n                                                                                                   // 384  // 467\n  Meteor.users.update({_id: user._id}, {$set: {username: newUsername}});                           // 385  // 468\n                                                                                                   // 386  // 469\n  // Perform another check after update, in case a matching user has been                          // 387  // 470\n  // inserted in the meantime                                                                      // 388  // 471\n  try {                                                                                            // 389  // 472\n    checkForCaseInsensitiveDuplicates('username', 'Username', newUsername, user._id);              // 390  // 473\n  } catch (ex) {                                                                                   // 391  // 474\n    // Undo update if the check fails                                                              // 392  // 475\n    Meteor.users.update({_id: user._id}, {$set: {username: oldUsername}});                         // 393  // 476\n    throw ex;                                                                                      // 394  // 477\n  }                                                                                                // 395  // 478\n};                                                                                                 // 396  // 479\n                                                                                                   // 397  // 480\n// Let the user change their own password if they know the old                                     // 398  // 481\n// password. `oldPassword` and `newPassword` should be objects with keys                           // 399  // 482\n// `digest` and `algorithm` (representing the SHA256 of the password).                             // 400  // 483\n//                                                                                                 // 401  // 484\n// XXX COMPAT WITH 0.8.1.3                                                                         // 402  // 485\n// Like the login method, if the user hasn't been upgraded from SRP to                             // 403  // 486\n// bcrypt yet, then this method will throw an 'old password format'                                // 404  // 487\n// error. The client should call the SRP upgrade login handler and then                            // 405  // 488\n// retry this method again.                                                                        // 406  // 489\n//                                                                                                 // 407  // 490\n// UNLIKE the login method, there is no way to avoid getting SRP upgrade                           // 408  // 491\n// errors thrown. The reasoning for this is that clients using this                                // 409  // 492\n// method directly will need to be updated anyway because we no longer                             // 410  // 493\n// support the SRP flow that they would have been doing to use this                                // 411  // 494\n// method previously.                                                                              // 412  // 495\nMeteor.methods({changePassword: function (oldPassword, newPassword) {                              // 413  // 496\n  check(oldPassword, passwordValidator);                                                           // 414  // 497\n  check(newPassword, passwordValidator);                                                           // 415  // 498\n                                                                                                   // 416  // 499\n  if (!this.userId)                                                                                // 417  // 500\n    throw new Meteor.Error(401, \"Must be logged in\");                                              // 418  // 501\n                                                                                                   // 419  // 502\n  var user = Meteor.users.findOne(this.userId);                                                    // 420  // 503\n  if (!user)                                                                                       // 421  // 504\n    throw new Meteor.Error(403, \"User not found\");                                                 // 422  // 505\n                                                                                                   // 423  // 506\n  if (!user.services || !user.services.password ||                                                 // 424  // 507\n      (!user.services.password.bcrypt && !user.services.password.srp))                             // 425  // 508\n    throw new Meteor.Error(403, \"User has no password set\");                                       // 426  // 509\n                                                                                                   // 427  // 510\n  if (! user.services.password.bcrypt) {                                                           // 428  // 511\n    throw new Meteor.Error(400, \"old password format\", EJSON.stringify({                           // 429  // 512\n      format: 'srp',                                                                               // 430  // 513\n      identity: user.services.password.srp.identity                                                // 431  // 514\n    }));                                                                                           // 432  // 515\n  }                                                                                                // 433  // 516\n                                                                                                   // 434  // 517\n  var result = checkPassword(user, oldPassword);                                                   // 435  // 518\n  if (result.error)                                                                                // 436  // 519\n    throw result.error;                                                                            // 437  // 520\n                                                                                                   // 438  // 521\n  var hashed = hashPassword(newPassword);                                                          // 439  // 522\n                                                                                                   // 440  // 523\n  // It would be better if this removed ALL existing tokens and replaced                           // 441  // 524\n  // the token for the current connection with a new one, but that would                           // 442  // 525\n  // be tricky, so we'll settle for just replacing all tokens other than                           // 443  // 526\n  // the one for the current connection.                                                           // 444  // 527\n  var currentToken = Accounts._getLoginToken(this.connection.id);                                  // 445  // 528\n  Meteor.users.update(                                                                             // 446  // 529\n    { _id: this.userId },                                                                          // 447  // 530\n    {                                                                                              // 448  // 531\n      $set: { 'services.password.bcrypt': hashed },                                                // 449  // 532\n      $pull: {                                                                                     // 450  // 533\n        'services.resume.loginTokens': { hashedToken: { $ne: currentToken } }                      // 451  // 534\n      },                                                                                           // 452  // 535\n      $unset: { 'services.password.reset': 1 }                                                     // 453  // 536\n    }                                                                                              // 454  // 537\n  );                                                                                               // 455  // 538\n                                                                                                   // 456  // 539\n  return {passwordChanged: true};                                                                  // 457  // 540\n}});                                                                                               // 458  // 541\n                                                                                                   // 459  // 542\n                                                                                                   // 460  // 543\n// Force change the users password.                                                                // 461  // 544\n                                                                                                   // 462  // 545\n/**                                                                                                // 463  // 546\n * @summary Forcibly change the password for a user.                                               // 464  // 547\n * @locus Server                                                                                   // 465  // 548\n * @param {String} userId The id of the user to update.                                            // 466  // 549\n * @param {String} newPassword A new password for the user.                                        // 467  // 550\n * @param {Object} [options]                                                                       // 468  // 551\n * @param {Object} options.logout Logout all current connections with this userId (default: true)  // 469  // 552\n */                                                                                                // 470  // 553\nAccounts.setPassword = function (userId, newPlaintextPassword, options) {                          // 471  // 554\n  options = _.extend({logout: true}, options);                                                     // 472  // 555\n                                                                                                   // 473  // 556\n  var user = Meteor.users.findOne(userId);                                                         // 474  // 557\n  if (!user)                                                                                       // 475  // 558\n    throw new Meteor.Error(403, \"User not found\");                                                 // 476  // 559\n                                                                                                   // 477  // 560\n  var update = {                                                                                   // 478  // 561\n    $unset: {                                                                                      // 479  // 562\n      'services.password.srp': 1, // XXX COMPAT WITH 0.8.1.3                                       // 480  // 563\n      'services.password.reset': 1                                                                 // 481  // 564\n    },                                                                                             // 482  // 565\n    $set: {'services.password.bcrypt': hashPassword(newPlaintextPassword)}                         // 483  // 566\n  };                                                                                               // 484  // 567\n                                                                                                   // 485  // 568\n  if (options.logout) {                                                                            // 486  // 569\n    update.$unset['services.resume.loginTokens'] = 1;                                              // 487  // 570\n  }                                                                                                // 488  // 571\n                                                                                                   // 489  // 572\n  Meteor.users.update({_id: user._id}, update);                                                    // 490  // 573\n};                                                                                                 // 491  // 574\n                                                                                                   // 492  // 575\n                                                                                                   // 493  // 576\n///                                                                                                // 494  // 577\n/// RESETTING VIA EMAIL                                                                            // 495  // 578\n///                                                                                                // 496  // 579\n                                                                                                   // 497  // 580\n// Method called by a user to request a password reset email. This is                              // 498  // 581\n// the start of the reset process.                                                                 // 499  // 582\nMeteor.methods({forgotPassword: function (options) {                                               // 500  // 583\n  check(options, {email: String});                                                                 // 501  // 584\n                                                                                                   // 502  // 585\n  var user = Meteor.users.findOne({\"emails.address\": options.email});                              // 503  // 586\n  if (!user)                                                                                       // 504  // 587\n    throw new Meteor.Error(403, \"User not found\");                                                 // 505  // 588\n                                                                                                   // 506  // 589\n  Accounts.sendResetPasswordEmail(user._id, options.email);                                        // 507  // 590\n}});                                                                                               // 508  // 591\n                                                                                                   // 509  // 592\n// send the user an email with a link that when opened allows the user                             // 510  // 593\n// to set a new password, without the old password.                                                // 511  // 594\n                                                                                                   // 512  // 595\n/**                                                                                                // 513  // 596\n * @summary Send an email with a link the user can use to reset their password.                    // 514  // 597\n * @locus Server                                                                                   // 515  // 598\n * @param {String} userId The id of the user to send email to.                                     // 516  // 599\n * @param {String} [email] Optional. Which address of the user's to send the email to. This address must be in the user's `emails` list. Defaults to the first email in the list.\n */                                                                                                // 518  // 601\nAccounts.sendResetPasswordEmail = function (userId, email) {                                       // 519  // 602\n  // Make sure the user exists, and email is one of their addresses.                               // 520  // 603\n  var user = Meteor.users.findOne(userId);                                                         // 521  // 604\n  if (!user)                                                                                       // 522  // 605\n    throw new Error(\"Can't find user\");                                                            // 523  // 606\n  // pick the first email if we weren't passed an email.                                           // 524  // 607\n  if (!email && user.emails && user.emails[0])                                                     // 525  // 608\n    email = user.emails[0].address;                                                                // 526  // 609\n  // make sure we have a valid email                                                               // 527  // 610\n  if (!email || !_.contains(_.pluck(user.emails || [], 'address'), email))                         // 528  // 611\n    throw new Error(\"No such email for user.\");                                                    // 529  // 612\n                                                                                                   // 530  // 613\n  var token = Random.secret();                                                                     // 531  // 614\n  var when = new Date();                                                                           // 532  // 615\n  var tokenRecord = {                                                                              // 533  // 616\n    token: token,                                                                                  // 534  // 617\n    email: email,                                                                                  // 535  // 618\n    when: when                                                                                     // 536  // 619\n  };                                                                                               // 537  // 620\n  Meteor.users.update(userId, {$set: {                                                             // 538  // 621\n    \"services.password.reset\": tokenRecord                                                         // 539  // 622\n  }});                                                                                             // 540  // 623\n  // before passing to template, update user object with new token                                 // 541  // 624\n  Meteor._ensure(user, 'services', 'password').reset = tokenRecord;                                // 542  // 625\n                                                                                                   // 543  // 626\n  var resetPasswordUrl = Accounts.urls.resetPassword(token);                                       // 544  // 627\n                                                                                                   // 545  // 628\n  var options = {                                                                                  // 546  // 629\n    to: email,                                                                                     // 547  // 630\n    from: Accounts.emailTemplates.resetPassword.from                                               // 548  // 631\n      ? Accounts.emailTemplates.resetPassword.from(user)                                           // 549  // 632\n      : Accounts.emailTemplates.from,                                                              // 550  // 633\n    subject: Accounts.emailTemplates.resetPassword.subject(user)                                   // 551  // 634\n  };                                                                                               // 552  // 635\n                                                                                                   // 553  // 636\n  if (typeof Accounts.emailTemplates.resetPassword.text === 'function') {                          // 554  // 637\n    options.text =                                                                                 // 555  // 638\n      Accounts.emailTemplates.resetPassword.text(user, resetPasswordUrl);                          // 556  // 639\n  }                                                                                                // 557  // 640\n                                                                                                   // 558  // 641\n  if (typeof Accounts.emailTemplates.resetPassword.html === 'function')                            // 559  // 642\n    options.html =                                                                                 // 560  // 643\n      Accounts.emailTemplates.resetPassword.html(user, resetPasswordUrl);                          // 561  // 644\n                                                                                                   // 562  // 645\n  if (typeof Accounts.emailTemplates.headers === 'object') {                                       // 563  // 646\n    options.headers = Accounts.emailTemplates.headers;                                             // 564  // 647\n  }                                                                                                // 565  // 648\n                                                                                                   // 566  // 649\n  Email.send(options);                                                                             // 567  // 650\n};                                                                                                 // 568  // 651\n                                                                                                   // 569  // 652\n// send the user an email informing them that their account was created, with                      // 570  // 653\n// a link that when opened both marks their email as verified and forces them                      // 571  // 654\n// to choose their password. The email must be one of the addresses in the                         // 572  // 655\n// user's emails field, or undefined to pick the first email automatically.                        // 573  // 656\n//                                                                                                 // 574  // 657\n// This is not called automatically. It must be called manually if you                             // 575  // 658\n// want to use enrollment emails.                                                                  // 576  // 659\n                                                                                                   // 577  // 660\n/**                                                                                                // 578  // 661\n * @summary Send an email with a link the user can use to set their initial password.              // 579  // 662\n * @locus Server                                                                                   // 580  // 663\n * @param {String} userId The id of the user to send email to.                                     // 581  // 664\n * @param {String} [email] Optional. Which address of the user's to send the email to. This address must be in the user's `emails` list. Defaults to the first email in the list.\n */                                                                                                // 583  // 666\nAccounts.sendEnrollmentEmail = function (userId, email) {                                          // 584  // 667\n  // XXX refactor! This is basically identical to sendResetPasswordEmail.                          // 585  // 668\n                                                                                                   // 586  // 669\n  // Make sure the user exists, and email is in their addresses.                                   // 587  // 670\n  var user = Meteor.users.findOne(userId);                                                         // 588  // 671\n  if (!user)                                                                                       // 589  // 672\n    throw new Error(\"Can't find user\");                                                            // 590  // 673\n  // pick the first email if we weren't passed an email.                                           // 591  // 674\n  if (!email && user.emails && user.emails[0])                                                     // 592  // 675\n    email = user.emails[0].address;                                                                // 593  // 676\n  // make sure we have a valid email                                                               // 594  // 677\n  if (!email || !_.contains(_.pluck(user.emails || [], 'address'), email))                         // 595  // 678\n    throw new Error(\"No such email for user.\");                                                    // 596  // 679\n                                                                                                   // 597  // 680\n  var token = Random.secret();                                                                     // 598  // 681\n  var when = new Date();                                                                           // 599  // 682\n  var tokenRecord = {                                                                              // 600  // 683\n    token: token,                                                                                  // 601  // 684\n    email: email,                                                                                  // 602  // 685\n    when: when                                                                                     // 603  // 686\n  };                                                                                               // 604  // 687\n  Meteor.users.update(userId, {$set: {                                                             // 605  // 688\n    \"services.password.reset\": tokenRecord                                                         // 606  // 689\n  }});                                                                                             // 607  // 690\n                                                                                                   // 608  // 691\n  // before passing to template, update user object with new token                                 // 609  // 692\n  Meteor._ensure(user, 'services', 'password').reset = tokenRecord;                                // 610  // 693\n                                                                                                   // 611  // 694\n  var enrollAccountUrl = Accounts.urls.enrollAccount(token);                                       // 612  // 695\n                                                                                                   // 613  // 696\n  var options = {                                                                                  // 614  // 697\n    to: email,                                                                                     // 615  // 698\n    from: Accounts.emailTemplates.enrollAccount.from                                               // 616  // 699\n      ? Accounts.emailTemplates.enrollAccount.from(user)                                           // 617  // 700\n      : Accounts.emailTemplates.from,                                                              // 618  // 701\n    subject: Accounts.emailTemplates.enrollAccount.subject(user)                                   // 619  // 702\n  };                                                                                               // 620  // 703\n                                                                                                   // 621  // 704\n  if (typeof Accounts.emailTemplates.enrollAccount.text === 'function') {                          // 622  // 705\n    options.text =                                                                                 // 623  // 706\n      Accounts.emailTemplates.enrollAccount.text(user, enrollAccountUrl);                          // 624  // 707\n  }                                                                                                // 625  // 708\n                                                                                                   // 626  // 709\n  if (typeof Accounts.emailTemplates.enrollAccount.html === 'function')                            // 627  // 710\n    options.html =                                                                                 // 628  // 711\n      Accounts.emailTemplates.enrollAccount.html(user, enrollAccountUrl);                          // 629  // 712\n                                                                                                   // 630  // 713\n  if (typeof Accounts.emailTemplates.headers === 'object') {                                       // 631  // 714\n    options.headers = Accounts.emailTemplates.headers;                                             // 632  // 715\n  }                                                                                                // 633  // 716\n                                                                                                   // 634  // 717\n  Email.send(options);                                                                             // 635  // 718\n};                                                                                                 // 636  // 719\n                                                                                                   // 637  // 720\n                                                                                                   // 638  // 721\n// Take token from sendResetPasswordEmail or sendEnrollmentEmail, change                           // 639  // 722\n// the users password, and log them in.                                                            // 640  // 723\nMeteor.methods({resetPassword: function (token, newPassword) {                                     // 641  // 724\n  var self = this;                                                                                 // 642  // 725\n  return Accounts._loginMethod(                                                                    // 643  // 726\n    self,                                                                                          // 644  // 727\n    \"resetPassword\",                                                                               // 645  // 728\n    arguments,                                                                                     // 646  // 729\n    \"password\",                                                                                    // 647  // 730\n    function () {                                                                                  // 648  // 731\n      check(token, String);                                                                        // 649  // 732\n      check(newPassword, passwordValidator);                                                       // 650  // 733\n                                                                                                   // 651  // 734\n      var user = Meteor.users.findOne({                                                            // 652  // 735\n        \"services.password.reset.token\": token});                                                  // 653  // 736\n      if (!user)                                                                                   // 654  // 737\n        throw new Meteor.Error(403, \"Token expired\");                                              // 655  // 738\n      var email = user.services.password.reset.email;                                              // 656  // 739\n      if (!_.include(_.pluck(user.emails || [], 'address'), email))                                // 657  // 740\n        return {                                                                                   // 658  // 741\n          userId: user._id,                                                                        // 659  // 742\n          error: new Meteor.Error(403, \"Token has invalid email address\")                          // 660  // 743\n        };                                                                                         // 661  // 744\n                                                                                                   // 662  // 745\n      var hashed = hashPassword(newPassword);                                                      // 663  // 746\n                                                                                                   // 664  // 747\n      // NOTE: We're about to invalidate tokens on the user, who we might be                       // 665  // 748\n      // logged in as. Make sure to avoid logging ourselves out if this                            // 666  // 749\n      // happens. But also make sure not to leave the connection in a state                        // 667  // 750\n      // of having a bad token set if things fail.                                                 // 668  // 751\n      var oldToken = Accounts._getLoginToken(self.connection.id);                                  // 669  // 752\n      Accounts._setLoginToken(user._id, self.connection, null);                                    // 670  // 753\n      var resetToOldToken = function () {                                                          // 671  // 754\n        Accounts._setLoginToken(user._id, self.connection, oldToken);                              // 672  // 755\n      };                                                                                           // 673  // 756\n                                                                                                   // 674  // 757\n      try {                                                                                        // 675  // 758\n        // Update the user record by:                                                              // 676  // 759\n        // - Changing the password to the new one                                                  // 677  // 760\n        // - Forgetting about the reset token that was just used                                   // 678  // 761\n        // - Verifying their email, since they got the password reset via email.                   // 679  // 762\n        var affectedRecords = Meteor.users.update(                                                 // 680  // 763\n          {                                                                                        // 681  // 764\n            _id: user._id,                                                                         // 682  // 765\n            'emails.address': email,                                                               // 683  // 766\n            'services.password.reset.token': token                                                 // 684  // 767\n          },                                                                                       // 685  // 768\n          {$set: {'services.password.bcrypt': hashed,                                              // 686  // 769\n                  'emails.$.verified': true},                                                      // 687  // 770\n           $unset: {'services.password.reset': 1,                                                  // 688  // 771\n                    'services.password.srp': 1}});                                                 // 689  // 772\n        if (affectedRecords !== 1)                                                                 // 690  // 773\n          return {                                                                                 // 691  // 774\n            userId: user._id,                                                                      // 692  // 775\n            error: new Meteor.Error(403, \"Invalid email\")                                          // 693  // 776\n          };                                                                                       // 694  // 777\n      } catch (err) {                                                                              // 695  // 778\n        resetToOldToken();                                                                         // 696  // 779\n        throw err;                                                                                 // 697  // 780\n      }                                                                                            // 698  // 781\n                                                                                                   // 699  // 782\n      // Replace all valid login tokens with new ones (changing                                    // 700  // 783\n      // password should invalidate existing sessions).                                            // 701  // 784\n      Accounts._clearAllLoginTokens(user._id);                                                     // 702  // 785\n                                                                                                   // 703  // 786\n      return {userId: user._id};                                                                   // 704  // 787\n    }                                                                                              // 705  // 788\n  );                                                                                               // 706  // 789\n}});                                                                                               // 707  // 790\n                                                                                                   // 708  // 791\n///                                                                                                // 709  // 792\n/// EMAIL VERIFICATION                                                                             // 710  // 793\n///                                                                                                // 711  // 794\n                                                                                                   // 712  // 795\n                                                                                                   // 713  // 796\n// send the user an email with a link that when opened marks that                                  // 714  // 797\n// address as verified                                                                             // 715  // 798\n                                                                                                   // 716  // 799\n/**                                                                                                // 717  // 800\n * @summary Send an email with a link the user can use verify their email address.                 // 718  // 801\n * @locus Server                                                                                   // 719  // 802\n * @param {String} userId The id of the user to send email to.                                     // 720  // 803\n * @param {String} [email] Optional. Which address of the user's to send the email to. This address must be in the user's `emails` list. Defaults to the first unverified email in the list.\n */                                                                                                // 722  // 805\nAccounts.sendVerificationEmail = function (userId, address) {                                      // 723  // 806\n  // XXX Also generate a link using which someone can delete this                                  // 724  // 807\n  // account if they own said address but weren't those who created                                // 725  // 808\n  // this account.                                                                                 // 726  // 809\n                                                                                                   // 727  // 810\n  // Make sure the user exists, and address is one of their addresses.                             // 728  // 811\n  var user = Meteor.users.findOne(userId);                                                         // 729  // 812\n  if (!user)                                                                                       // 730  // 813\n    throw new Error(\"Can't find user\");                                                            // 731  // 814\n  // pick the first unverified address if we weren't passed an address.                            // 732  // 815\n  if (!address) {                                                                                  // 733  // 816\n    var email = _.find(user.emails || [],                                                          // 734  // 817\n                       function (e) { return !e.verified; });                                      // 735  // 818\n    address = (email || {}).address;                                                               // 736  // 819\n  }                                                                                                // 737  // 820\n  // make sure we have a valid address                                                             // 738  // 821\n  if (!address || !_.contains(_.pluck(user.emails || [], 'address'), address))                     // 739  // 822\n    throw new Error(\"No such email address for user.\");                                            // 740  // 823\n                                                                                                   // 741  // 824\n                                                                                                   // 742  // 825\n  var tokenRecord = {                                                                              // 743  // 826\n    token: Random.secret(),                                                                        // 744  // 827\n    address: address,                                                                              // 745  // 828\n    when: new Date()};                                                                             // 746  // 829\n  Meteor.users.update(                                                                             // 747  // 830\n    {_id: userId},                                                                                 // 748  // 831\n    {$push: {'services.email.verificationTokens': tokenRecord}});                                  // 749  // 832\n                                                                                                   // 750  // 833\n  // before passing to template, update user object with new token                                 // 751  // 834\n  Meteor._ensure(user, 'services', 'email');                                                       // 752  // 835\n  if (!user.services.email.verificationTokens) {                                                   // 753  // 836\n    user.services.email.verificationTokens = [];                                                   // 754  // 837\n  }                                                                                                // 755  // 838\n  user.services.email.verificationTokens.push(tokenRecord);                                        // 756  // 839\n                                                                                                   // 757  // 840\n  var verifyEmailUrl = Accounts.urls.verifyEmail(tokenRecord.token);                               // 758  // 841\n                                                                                                   // 759  // 842\n  var options = {                                                                                  // 760  // 843\n    to: address,                                                                                   // 761  // 844\n    from: Accounts.emailTemplates.verifyEmail.from                                                 // 762  // 845\n      ? Accounts.emailTemplates.verifyEmail.from(user)                                             // 763  // 846\n      : Accounts.emailTemplates.from,                                                              // 764  // 847\n    subject: Accounts.emailTemplates.verifyEmail.subject(user)                                     // 765  // 848\n  };                                                                                               // 766  // 849\n                                                                                                   // 767  // 850\n  if (typeof Accounts.emailTemplates.verifyEmail.text === 'function') {                            // 768  // 851\n    options.text =                                                                                 // 769  // 852\n      Accounts.emailTemplates.verifyEmail.text(user, verifyEmailUrl);                              // 770  // 853\n  }                                                                                                // 771  // 854\n                                                                                                   // 772  // 855\n  if (typeof Accounts.emailTemplates.verifyEmail.html === 'function')                              // 773  // 856\n    options.html =                                                                                 // 774  // 857\n      Accounts.emailTemplates.verifyEmail.html(user, verifyEmailUrl);                              // 775  // 858\n                                                                                                   // 776  // 859\n  if (typeof Accounts.emailTemplates.headers === 'object') {                                       // 777  // 860\n    options.headers = Accounts.emailTemplates.headers;                                             // 778  // 861\n  }                                                                                                // 779  // 862\n                                                                                                   // 780  // 863\n  Email.send(options);                                                                             // 781  // 864\n};                                                                                                 // 782  // 865\n                                                                                                   // 783  // 866\n// Take token from sendVerificationEmail, mark the email as verified,                              // 784  // 867\n// and log them in.                                                                                // 785  // 868\nMeteor.methods({verifyEmail: function (token) {                                                    // 786  // 869\n  var self = this;                                                                                 // 787  // 870\n  return Accounts._loginMethod(                                                                    // 788  // 871\n    self,                                                                                          // 789  // 872\n    \"verifyEmail\",                                                                                 // 790  // 873\n    arguments,                                                                                     // 791  // 874\n    \"password\",                                                                                    // 792  // 875\n    function () {                                                                                  // 793  // 876\n      check(token, String);                                                                        // 794  // 877\n                                                                                                   // 795  // 878\n      var user = Meteor.users.findOne(                                                             // 796  // 879\n        {'services.email.verificationTokens.token': token});                                       // 797  // 880\n      if (!user)                                                                                   // 798  // 881\n        throw new Meteor.Error(403, \"Verify email link expired\");                                  // 799  // 882\n                                                                                                   // 800  // 883\n      var tokenRecord = _.find(user.services.email.verificationTokens,                             // 801  // 884\n                               function (t) {                                                      // 802  // 885\n                                 return t.token == token;                                          // 803  // 886\n                               });                                                                 // 804  // 887\n      if (!tokenRecord)                                                                            // 805  // 888\n        return {                                                                                   // 806  // 889\n          userId: user._id,                                                                        // 807  // 890\n          error: new Meteor.Error(403, \"Verify email link expired\")                                // 808  // 891\n        };                                                                                         // 809  // 892\n                                                                                                   // 810  // 893\n      var emailsRecord = _.find(user.emails, function (e) {                                        // 811  // 894\n        return e.address == tokenRecord.address;                                                   // 812  // 895\n      });                                                                                          // 813  // 896\n      if (!emailsRecord)                                                                           // 814  // 897\n        return {                                                                                   // 815  // 898\n          userId: user._id,                                                                        // 816  // 899\n          error: new Meteor.Error(403, \"Verify email link is for unknown address\")                 // 817  // 900\n        };                                                                                         // 818  // 901\n                                                                                                   // 819  // 902\n      // By including the address in the query, we can use 'emails.$' in the                       // 820  // 903\n      // modifier to get a reference to the specific object in the emails                          // 821  // 904\n      // array. See                                                                                // 822  // 905\n      // http://www.mongodb.org/display/DOCS/Updating/#Updating-The%24positionaloperator)          // 823  // 906\n      // http://www.mongodb.org/display/DOCS/Updating#Updating-%24pull                             // 824  // 907\n      Meteor.users.update(                                                                         // 825  // 908\n        {_id: user._id,                                                                            // 826  // 909\n         'emails.address': tokenRecord.address},                                                   // 827  // 910\n        {$set: {'emails.$.verified': true},                                                        // 828  // 911\n         $pull: {'services.email.verificationTokens': {address: tokenRecord.address}}});           // 829  // 912\n                                                                                                   // 830  // 913\n      return {userId: user._id};                                                                   // 831  // 914\n    }                                                                                              // 832  // 915\n  );                                                                                               // 833  // 916\n}});                                                                                               // 834  // 917\n                                                                                                   // 835  // 918\n/**                                                                                                // 836  // 919\n * @summary Add an email address for a user. Use this instead of directly                          // 837  // 920\n * updating the database. The operation will fail if there is a different user                     // 838  // 921\n * with an email only differing in case. If the specified user has an existing                     // 839  // 922\n * email only differing in case however, we replace it.                                            // 840  // 923\n * @locus Server                                                                                   // 841  // 924\n * @param {String} userId The ID of the user to update.                                            // 842  // 925\n * @param {String} newEmail A new email address for the user.                                      // 843  // 926\n * @param {Boolean} [verified] Optional - whether the new email address should                     // 844  // 927\n * be marked as verified. Defaults to false.                                                       // 845  // 928\n */                                                                                                // 846  // 929\nAccounts.addEmail = function (userId, newEmail, verified) {                                        // 847  // 930\n  check(userId, NonEmptyString);                                                                   // 848  // 931\n  check(newEmail, NonEmptyString);                                                                 // 849  // 932\n  check(verified, Match.Optional(Boolean));                                                        // 850  // 933\n                                                                                                   // 851  // 934\n  if (_.isUndefined(verified)) {                                                                   // 852  // 935\n    verified = false;                                                                              // 853  // 936\n  }                                                                                                // 854  // 937\n                                                                                                   // 855  // 938\n  var user = Meteor.users.findOne(userId);                                                         // 856  // 939\n  if (!user)                                                                                       // 857  // 940\n    throw new Meteor.Error(403, \"User not found\");                                                 // 858  // 941\n                                                                                                   // 859  // 942\n  // Allow users to change their own email to a version with a different case                      // 860  // 943\n                                                                                                   // 861  // 944\n  // We don't have to call checkForCaseInsensitiveDuplicates to do a case                          // 862  // 945\n  // insensitive check across all emails in the database here because: (1) if                      // 863  // 946\n  // there is no case-insensitive duplicate between this user and other users,                     // 864  // 947\n  // then we are OK and (2) if this would create a conflict with other users                       // 865  // 948\n  // then there would already be a case-insensitive duplicate and we can't fix                     // 866  // 949\n  // that in this code anyway.                                                                     // 867  // 950\n  var caseInsensitiveRegExp =                                                                      // 868  // 951\n    new RegExp('^' + Meteor._escapeRegExp(newEmail) + '$', 'i');                                   // 869  // 952\n                                                                                                   // 870  // 953\n  var didUpdateOwnEmail = _.any(user.emails, function(email, index) {                              // 871  // 954\n    if (caseInsensitiveRegExp.test(email.address)) {                                               // 872  // 955\n      Meteor.users.update({                                                                        // 873  // 956\n        _id: user._id,                                                                             // 874  // 957\n        'emails.address': email.address                                                            // 875  // 958\n      }, {$set: {                                                                                  // 876  // 959\n        'emails.$.address': newEmail,                                                              // 877  // 960\n        'emails.$.verified': verified                                                              // 878  // 961\n      }});                                                                                         // 879  // 962\n      return true;                                                                                 // 880  // 963\n    }                                                                                              // 881  // 964\n                                                                                                   // 882  // 965\n    return false;                                                                                  // 883  // 966\n  });                                                                                              // 884  // 967\n                                                                                                   // 885  // 968\n  // In the other updates below, we have to do another call to                                     // 886  // 969\n  // checkForCaseInsensitiveDuplicates to make sure that no conflicting values                     // 887  // 970\n  // were added to the database in the meantime. We don't have to do this for                      // 888  // 971\n  // the case where the user is updating their email address to one that is the                    // 889  // 972\n  // same as before, but only different because of capitalization. Read the                        // 890  // 973\n  // big comment above to understand why.                                                          // 891  // 974\n                                                                                                   // 892  // 975\n  if (didUpdateOwnEmail) {                                                                         // 893  // 976\n    return;                                                                                        // 894  // 977\n  }                                                                                                // 895  // 978\n                                                                                                   // 896  // 979\n  // Perform a case insensitive check for duplicates before update                                 // 897  // 980\n  checkForCaseInsensitiveDuplicates('emails.address', 'Email', newEmail, user._id);                // 898  // 981\n                                                                                                   // 899  // 982\n  Meteor.users.update({                                                                            // 900  // 983\n    _id: user._id                                                                                  // 901  // 984\n  }, {                                                                                             // 902  // 985\n    $addToSet: {                                                                                   // 903  // 986\n      emails: {                                                                                    // 904  // 987\n        address: newEmail,                                                                         // 905  // 988\n        verified: verified                                                                         // 906  // 989\n      }                                                                                            // 907  // 990\n    }                                                                                              // 908  // 991\n  });                                                                                              // 909  // 992\n                                                                                                   // 910  // 993\n  // Perform another check after update, in case a matching user has been                          // 911  // 994\n  // inserted in the meantime                                                                      // 912  // 995\n  try {                                                                                            // 913  // 996\n    checkForCaseInsensitiveDuplicates('emails.address', 'Email', newEmail, user._id);              // 914  // 997\n  } catch (ex) {                                                                                   // 915  // 998\n    // Undo update if the check fails                                                              // 916  // 999\n    Meteor.users.update({_id: user._id},                                                           // 917  // 1000\n      {$pull: {emails: {address: newEmail}}});                                                     // 918  // 1001\n    throw ex;                                                                                      // 919  // 1002\n  }                                                                                                // 920  // 1003\n}                                                                                                  // 921  // 1004\n                                                                                                   // 922  // 1005\n/**                                                                                                // 923  // 1006\n * @summary Remove an email address for a user. Use this instead of updating                       // 924  // 1007\n * the database directly.                                                                          // 925  // 1008\n * @locus Server                                                                                   // 926  // 1009\n * @param {String} userId The ID of the user to update.                                            // 927  // 1010\n * @param {String} email The email address to remove.                                              // 928  // 1011\n */                                                                                                // 929  // 1012\nAccounts.removeEmail = function (userId, email) {                                                  // 930  // 1013\n  check(userId, NonEmptyString);                                                                   // 931  // 1014\n  check(email, NonEmptyString);                                                                    // 932  // 1015\n                                                                                                   // 933  // 1016\n  var user = Meteor.users.findOne(userId);                                                         // 934  // 1017\n  if (!user)                                                                                       // 935  // 1018\n    throw new Meteor.Error(403, \"User not found\");                                                 // 936  // 1019\n                                                                                                   // 937  // 1020\n  Meteor.users.update({_id: user._id},                                                             // 938  // 1021\n    {$pull: {emails: {address: email}}});                                                          // 939  // 1022\n}                                                                                                  // 940  // 1023\n                                                                                                   // 941  // 1024\n///                                                                                                // 942  // 1025\n/// CREATING USERS                                                                                 // 943  // 1026\n///                                                                                                // 944  // 1027\n                                                                                                   // 945  // 1028\n// Shared createUser function called from the createUser method, both                              // 946  // 1029\n// if originates in client or server code. Calls user provided hooks,                              // 947  // 1030\n// does the actual user insertion.                                                                 // 948  // 1031\n//                                                                                                 // 949  // 1032\n// returns the user id                                                                             // 950  // 1033\nvar createUser = function (options) {                                                              // 951  // 1034\n  // Unknown keys allowed, because a onCreateUserHook can take arbitrary                           // 952  // 1035\n  // options.                                                                                      // 953  // 1036\n  check(options, Match.ObjectIncluding({                                                           // 954  // 1037\n    username: Match.Optional(String),                                                              // 955  // 1038\n    email: Match.Optional(String),                                                                 // 956  // 1039\n    password: Match.Optional(passwordValidator)                                                    // 957  // 1040\n  }));                                                                                             // 958  // 1041\n                                                                                                   // 959  // 1042\n  var username = options.username;                                                                 // 960  // 1043\n  var email = options.email;                                                                       // 961  // 1044\n  if (!username && !email)                                                                         // 962  // 1045\n    throw new Meteor.Error(400, \"Need to set a username or email\");                                // 963  // 1046\n                                                                                                   // 964  // 1047\n  var user = {services: {}};                                                                       // 965  // 1048\n  if (options.password) {                                                                          // 966  // 1049\n    var hashed = hashPassword(options.password);                                                   // 967  // 1050\n    user.services.password = { bcrypt: hashed };                                                   // 968  // 1051\n  }                                                                                                // 969  // 1052\n                                                                                                   // 970  // 1053\n  if (username)                                                                                    // 971  // 1054\n    user.username = username;                                                                      // 972  // 1055\n  if (email)                                                                                       // 973  // 1056\n    user.emails = [{address: email, verified: false}];                                             // 974  // 1057\n                                                                                                   // 975  // 1058\n  // Perform a case insensitive check before insert                                                // 976  // 1059\n  checkForCaseInsensitiveDuplicates('username', 'Username', username);                             // 977  // 1060\n  checkForCaseInsensitiveDuplicates('emails.address', 'Email', email);                             // 978  // 1061\n                                                                                                   // 979  // 1062\n  var userId = Accounts.insertUserDoc(options, user);                                              // 980  // 1063\n  // Perform another check after insert, in case a matching user has been                          // 981  // 1064\n  // inserted in the meantime                                                                      // 982  // 1065\n  try {                                                                                            // 983  // 1066\n    checkForCaseInsensitiveDuplicates('username', 'Username', username, userId);                   // 984  // 1067\n    checkForCaseInsensitiveDuplicates('emails.address', 'Email', email, userId);                   // 985  // 1068\n  } catch (ex) {                                                                                   // 986  // 1069\n    // Remove inserted user if the check fails                                                     // 987  // 1070\n    Meteor.users.remove(userId);                                                                   // 988  // 1071\n    throw ex;                                                                                      // 989  // 1072\n  }                                                                                                // 990  // 1073\n  return userId;                                                                                   // 991  // 1074\n};                                                                                                 // 992  // 1075\n                                                                                                   // 993  // 1076\n// method for create user. Requests come from the client.                                          // 994  // 1077\nMeteor.methods({createUser: function (options) {                                                   // 995  // 1078\n  var self = this;                                                                                 // 996  // 1079\n  return Accounts._loginMethod(                                                                    // 997  // 1080\n    self,                                                                                          // 998  // 1081\n    \"createUser\",                                                                                  // 999  // 1082\n    arguments,                                                                                     // 1000\n    \"password\",                                                                                    // 1001\n    function () {                                                                                  // 1002\n      // createUser() above does more checking.                                                    // 1003\n      check(options, Object);                                                                      // 1004\n      if (Accounts._options.forbidClientAccountCreation)                                           // 1005\n        return {                                                                                   // 1006\n          error: new Meteor.Error(403, \"Signups forbidden\")                                        // 1007\n        };                                                                                         // 1008\n                                                                                                   // 1009\n      // Create user. result contains id and token.                                                // 1010\n      var userId = createUser(options);                                                            // 1011\n      // safety belt. createUser is supposed to throw on error. send 500 error                     // 1012\n      // instead of sending a verification email with empty userid.                                // 1013\n      if (! userId)                                                                                // 1014\n        throw new Error(\"createUser failed to insert new user\");                                   // 1015\n                                                                                                   // 1016\n      // If `Accounts._options.sendVerificationEmail` is set, register                             // 1017\n      // a token to verify the user's primary email, and send it to                                // 1018\n      // that address.                                                                             // 1019\n      if (options.email && Accounts._options.sendVerificationEmail)                                // 1020\n        Accounts.sendVerificationEmail(userId, options.email);                                     // 1021\n                                                                                                   // 1022\n      // client gets logged in as the new user afterwards.                                         // 1023\n      return {userId: userId};                                                                     // 1024\n    }                                                                                              // 1025\n  );                                                                                               // 1026\n}});                                                                                               // 1027\n                                                                                                   // 1028\n// Create user directly on the server.                                                             // 1029\n//                                                                                                 // 1030\n// Unlike the client version, this does not log you in as this user                                // 1031\n// after creation.                                                                                 // 1032\n//                                                                                                 // 1033\n// returns userId or throws an error if it can't create                                            // 1034\n//                                                                                                 // 1035\n// XXX add another argument (\"server options\") that gets sent to onCreateUser,                     // 1036\n// which is always empty when called from the createUser method? eg, \"admin:                       // 1037\n// true\", which we want to prevent the client from setting, but which a custom                     // 1038\n// method calling Accounts.createUser could set?                                                   // 1039\n//                                                                                                 // 1040\nAccounts.createUser = function (options, callback) {                                               // 1041\n  options = _.clone(options);                                                                      // 1042\n                                                                                                   // 1043\n  // XXX allow an optional callback?                                                               // 1044\n  if (callback) {                                                                                  // 1045\n    throw new Error(\"Accounts.createUser with callback not supported on the server yet.\");         // 1046\n  }                                                                                                // 1047\n                                                                                                   // 1048\n  return createUser(options);                                                                      // 1049\n};                                                                                                 // 1050\n                                                                                                   // 1051\n///                                                                                                // 1052\n/// PASSWORD-SPECIFIC INDEXES ON USERS                                                             // 1053\n///                                                                                                // 1054\nMeteor.users._ensureIndex('services.email.verificationTokens.token',                               // 1055\n                          {unique: 1, sparse: 1});                                                 // 1056\nMeteor.users._ensureIndex('services.password.reset.token',                                         // 1057\n                          {unique: 1, sparse: 1});                                                 // 1058\n                                                                                                   // 1059\n/////////////////////////////////////////////////////////////////////////////////////////////////////      // 1143\n                                                                                                           // 1144\n}).call(this);                                                                                             // 1145\n                                                                                                           // 1146\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nif (typeof Package === 'undefined') Package = {};\nPackage['accounts-password'] = {};\n\n})();\n","servePath":"/packages/accounts-password.js","sourceMap":{"version":3,"sources":["/packages/accounts-password/packages/accounts-password.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kH","file":"/packages/accounts-password.js","sourcesContent":["(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                 //\n// packages/accounts-password/email_templates.js                                                   //\n//                                                                                                 //\n/////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                   //\n/**                                                                                                // 1\n * @summary Options to customize emails sent from the Accounts system.                             // 2\n * @locus Server                                                                                   // 3\n */                                                                                                // 4\nAccounts.emailTemplates = {                                                                        // 5\n  from: \"Meteor Accounts <no-reply@meteor.com>\",                                                   // 6\n  siteName: Meteor.absoluteUrl().replace(/^https?:\\/\\//, '').replace(/\\/$/, ''),                   // 7\n                                                                                                   // 8\n  resetPassword: {                                                                                 // 9\n    subject: function(user) {                                                                      // 10\n      return \"How to reset your password on \" + Accounts.emailTemplates.siteName;                  // 11\n    },                                                                                             // 12\n    text: function(user, url) {                                                                    // 13\n      var greeting = (user.profile && user.profile.name) ?                                         // 14\n            (\"Hello \" + user.profile.name + \",\") : \"Hello,\";                                       // 15\n      return greeting + \"\\n\"                                                                       // 16\n        + \"\\n\"                                                                                     // 17\n        + \"To reset your password, simply click the link below.\\n\"                                 // 18\n        + \"\\n\"                                                                                     // 19\n        + url + \"\\n\"                                                                               // 20\n        + \"\\n\"                                                                                     // 21\n        + \"Thanks.\\n\";                                                                             // 22\n    }                                                                                              // 23\n  },                                                                                               // 24\n  verifyEmail: {                                                                                   // 25\n    subject: function(user) {                                                                      // 26\n      return \"How to verify email address on \" + Accounts.emailTemplates.siteName;                 // 27\n    },                                                                                             // 28\n    text: function(user, url) {                                                                    // 29\n      var greeting = (user.profile && user.profile.name) ?                                         // 30\n            (\"Hello \" + user.profile.name + \",\") : \"Hello,\";                                       // 31\n      return greeting + \"\\n\"                                                                       // 32\n        + \"\\n\"                                                                                     // 33\n        + \"To verify your account email, simply click the link below.\\n\"                           // 34\n        + \"\\n\"                                                                                     // 35\n        + url + \"\\n\"                                                                               // 36\n        + \"\\n\"                                                                                     // 37\n        + \"Thanks.\\n\";                                                                             // 38\n    }                                                                                              // 39\n  },                                                                                               // 40\n  enrollAccount: {                                                                                 // 41\n    subject: function(user) {                                                                      // 42\n      return \"An account has been created for you on \" + Accounts.emailTemplates.siteName;         // 43\n    },                                                                                             // 44\n    text: function(user, url) {                                                                    // 45\n      var greeting = (user.profile && user.profile.name) ?                                         // 46\n            (\"Hello \" + user.profile.name + \",\") : \"Hello,\";                                       // 47\n      return greeting + \"\\n\"                                                                       // 48\n        + \"\\n\"                                                                                     // 49\n        + \"To start using the service, simply click the link below.\\n\"                             // 50\n        + \"\\n\"                                                                                     // 51\n        + url + \"\\n\"                                                                               // 52\n        + \"\\n\"                                                                                     // 53\n        + \"Thanks.\\n\";                                                                             // 54\n    }                                                                                              // 55\n  }                                                                                                // 56\n};                                                                                                 // 57\n                                                                                                   // 58\n/////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                 //\n// packages/accounts-password/password_server.js                                                   //\n//                                                                                                 //\n/////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                   //\n/// BCRYPT                                                                                         // 1\n                                                                                                   // 2\nvar bcrypt = NpmModuleBcrypt;                                                                      // 3\nvar bcryptHash = Meteor.wrapAsync(bcrypt.hash);                                                    // 4\nvar bcryptCompare = Meteor.wrapAsync(bcrypt.compare);                                              // 5\n                                                                                                   // 6\n// User records have a 'services.password.bcrypt' field on them to hold                            // 7\n// their hashed passwords (unless they have a 'services.password.srp'                              // 8\n// field, in which case they will be upgraded to bcrypt the next time                              // 9\n// they log in).                                                                                   // 10\n//                                                                                                 // 11\n// When the client sends a password to the server, it can either be a                              // 12\n// string (the plaintext password) or an object with keys 'digest' and                             // 13\n// 'algorithm' (must be \"sha-256\" for now). The Meteor client always sends                         // 14\n// password objects { digest: *, algorithm: \"sha-256\" }, but DDP clients                           // 15\n// that don't have access to SHA can just send plaintext passwords as                              // 16\n// strings.                                                                                        // 17\n//                                                                                                 // 18\n// When the server receives a plaintext password as a string, it always                            // 19\n// hashes it with SHA256 before passing it into bcrypt. When the server                            // 20\n// receives a password as an object, it asserts that the algorithm is                              // 21\n// \"sha-256\" and then passes the digest to bcrypt.                                                 // 22\n                                                                                                   // 23\n                                                                                                   // 24\nAccounts._bcryptRounds = 10;                                                                       // 25\n                                                                                                   // 26\n// Given a 'password' from the client, extract the string that we should                           // 27\n// bcrypt. 'password' can be one of:                                                               // 28\n//  - String (the plaintext password)                                                              // 29\n//  - Object with 'digest' and 'algorithm' keys. 'algorithm' must be \"sha-256\".                    // 30\n//                                                                                                 // 31\nvar getPasswordString = function (password) {                                                      // 32\n  if (typeof password === \"string\") {                                                              // 33\n    password = SHA256(password);                                                                   // 34\n  } else { // 'password' is an object                                                              // 35\n    if (password.algorithm !== \"sha-256\") {                                                        // 36\n      throw new Error(\"Invalid password hash algorithm. \" +                                        // 37\n                      \"Only 'sha-256' is allowed.\");                                               // 38\n    }                                                                                              // 39\n    password = password.digest;                                                                    // 40\n  }                                                                                                // 41\n  return password;                                                                                 // 42\n};                                                                                                 // 43\n                                                                                                   // 44\n// Use bcrypt to hash the password for storage in the database.                                    // 45\n// `password` can be a string (in which case it will be run through                                // 46\n// SHA256 before bcrypt) or an object with properties `digest` and                                 // 47\n// `algorithm` (in which case we bcrypt `password.digest`).                                        // 48\n//                                                                                                 // 49\nvar hashPassword = function (password) {                                                           // 50\n  password = getPasswordString(password);                                                          // 51\n  return bcryptHash(password, Accounts._bcryptRounds);                                             // 52\n};                                                                                                 // 53\n                                                                                                   // 54\n// Check whether the provided password matches the bcrypt'ed password in                           // 55\n// the database user record. `password` can be a string (in which case                             // 56\n// it will be run through SHA256 before bcrypt) or an object with                                  // 57\n// properties `digest` and `algorithm` (in which case we bcrypt                                    // 58\n// `password.digest`).                                                                             // 59\n//                                                                                                 // 60\nAccounts._checkPassword = function (user, password) {                                              // 61\n  var result = {                                                                                   // 62\n    userId: user._id                                                                               // 63\n  };                                                                                               // 64\n                                                                                                   // 65\n  password = getPasswordString(password);                                                          // 66\n                                                                                                   // 67\n  if (! bcryptCompare(password, user.services.password.bcrypt)) {                                  // 68\n    result.error = new Meteor.Error(403, \"Incorrect password\");                                    // 69\n  }                                                                                                // 70\n                                                                                                   // 71\n  return result;                                                                                   // 72\n};                                                                                                 // 73\nvar checkPassword = Accounts._checkPassword;                                                       // 74\n                                                                                                   // 75\n///                                                                                                // 76\n/// LOGIN                                                                                          // 77\n///                                                                                                // 78\n                                                                                                   // 79\nAccounts._findUserByQuery = function (query) {                                                     // 80\n  var user = null;                                                                                 // 81\n                                                                                                   // 82\n  if (query.id) {                                                                                  // 83\n    user = Meteor.users.findOne({ _id: query.id });                                                // 84\n  } else {                                                                                         // 85\n    var fieldName;                                                                                 // 86\n    var fieldValue;                                                                                // 87\n    if (query.username) {                                                                          // 88\n      fieldName = 'username';                                                                      // 89\n      fieldValue = query.username;                                                                 // 90\n    } else if (query.email) {                                                                      // 91\n      fieldName = 'emails.address';                                                                // 92\n      fieldValue = query.email;                                                                    // 93\n    } else {                                                                                       // 94\n      throw new Error(\"shouldn't happen (validation missed something)\");                           // 95\n    }                                                                                              // 96\n    var selector = {};                                                                             // 97\n    selector[fieldName] = fieldValue;                                                              // 98\n    user = Meteor.users.findOne(selector);                                                         // 99\n    // If user is not found, try a case insensitive lookup                                         // 100\n    if (!user) {                                                                                   // 101\n      selector = selectorForFastCaseInsensitiveLookup(fieldName, fieldValue);                      // 102\n      var candidateUsers = Meteor.users.find(selector).fetch();                                    // 103\n      // No match if multiple candidates are found                                                 // 104\n      if (candidateUsers.length === 1) {                                                           // 105\n        user = candidateUsers[0];                                                                  // 106\n      }                                                                                            // 107\n    }                                                                                              // 108\n  }                                                                                                // 109\n                                                                                                   // 110\n  return user;                                                                                     // 111\n};                                                                                                 // 112\n                                                                                                   // 113\n/**                                                                                                // 114\n * @summary Finds the user with the specified username.                                            // 115\n * First tries to match username case sensitively; if that fails, it                               // 116\n * tries case insensitively; but if more than one user matches the case                            // 117\n * insensitive search, it returns null.                                                            // 118\n * @locus Server                                                                                   // 119\n * @param {String} username The username to look for                                               // 120\n * @returns {Object} A user if found, else null                                                    // 121\n */                                                                                                // 122\nAccounts.findUserByUsername = function (username) {                                                // 123\n  return Accounts._findUserByQuery({                                                               // 124\n    username: username                                                                             // 125\n  });                                                                                              // 126\n};                                                                                                 // 127\n                                                                                                   // 128\n/**                                                                                                // 129\n * @summary Finds the user with the specified email.                                               // 130\n * First tries to match email case sensitively; if that fails, it                                  // 131\n * tries case insensitively; but if more than one user matches the case                            // 132\n * insensitive search, it returns null.                                                            // 133\n * @locus Server                                                                                   // 134\n * @param {String} email The email address to look for                                             // 135\n * @returns {Object} A user if found, else null                                                    // 136\n */                                                                                                // 137\nAccounts.findUserByEmail = function (email) {                                                      // 138\n  return Accounts._findUserByQuery({                                                               // 139\n    email: email                                                                                   // 140\n  });                                                                                              // 141\n};                                                                                                 // 142\n                                                                                                   // 143\n// Generates a MongoDB selector that can be used to perform a fast case                            // 144\n// insensitive lookup for the given fieldName and string. Since MongoDB does                       // 145\n// not support case insensitive indexes, and case insensitive regex queries                        // 146\n// are slow, we construct a set of prefix selectors for all permutations of                        // 147\n// the first 4 characters ourselves. We first attempt to matching against                          // 148\n// these, and because 'prefix expression' regex queries do use indexes (see                        // 149\n// http://docs.mongodb.org/v2.6/reference/operator/query/regex/#index-use),                        // 150\n// this has been found to greatly improve performance (from 1200ms to 5ms in a                     // 151\n// test with 1.000.000 users).                                                                     // 152\nvar selectorForFastCaseInsensitiveLookup = function (fieldName, string) {                          // 153\n  // Performance seems to improve up to 4 prefix characters                                        // 154\n  var prefix = string.substring(0, Math.min(string.length, 4));                                    // 155\n  var orClause = _.map(generateCasePermutationsForString(prefix),                                  // 156\n    function (prefixPermutation) {                                                                 // 157\n      var selector = {};                                                                           // 158\n      selector[fieldName] =                                                                        // 159\n        new RegExp('^' + Meteor._escapeRegExp(prefixPermutation));                                 // 160\n      return selector;                                                                             // 161\n    });                                                                                            // 162\n  var caseInsensitiveClause = {};                                                                  // 163\n  caseInsensitiveClause[fieldName] =                                                               // 164\n    new RegExp('^' + Meteor._escapeRegExp(string) + '$', 'i')                                      // 165\n  return {$and: [{$or: orClause}, caseInsensitiveClause]};                                         // 166\n}                                                                                                  // 167\n                                                                                                   // 168\n// Generates permutations of all case variations of a given string.                                // 169\nvar generateCasePermutationsForString = function (string) {                                        // 170\n  var permutations = [''];                                                                         // 171\n  for (var i = 0; i < string.length; i++) {                                                        // 172\n    var ch = string.charAt(i);                                                                     // 173\n    permutations = _.flatten(_.map(permutations, function (prefix) {                               // 174\n      var lowerCaseChar = ch.toLowerCase();                                                        // 175\n      var upperCaseChar = ch.toUpperCase();                                                        // 176\n      // Don't add unneccesary permutations when ch is not a letter                                // 177\n      if (lowerCaseChar === upperCaseChar) {                                                       // 178\n        return [prefix + ch];                                                                      // 179\n      } else {                                                                                     // 180\n        return [prefix + lowerCaseChar, prefix + upperCaseChar];                                   // 181\n      }                                                                                            // 182\n    }));                                                                                           // 183\n  }                                                                                                // 184\n  return permutations;                                                                             // 185\n}                                                                                                  // 186\n                                                                                                   // 187\nvar checkForCaseInsensitiveDuplicates = function (fieldName, displayName, fieldValue, ownUserId) {\n  // Some tests need the ability to add users with the same case insensitive                       // 189\n  // value, hence the _skipCaseInsensitiveChecksForTest check                                      // 190\n  var skipCheck = _.has(Accounts._skipCaseInsensitiveChecksForTest, fieldValue);                   // 191\n                                                                                                   // 192\n  if (fieldValue && !skipCheck) {                                                                  // 193\n    var matchedUsers = Meteor.users.find(                                                          // 194\n      selectorForFastCaseInsensitiveLookup(fieldName, fieldValue)).fetch();                        // 195\n                                                                                                   // 196\n    if (matchedUsers.length > 0 &&                                                                 // 197\n        // If we don't have a userId yet, any match we find is a duplicate                         // 198\n        (!ownUserId ||                                                                             // 199\n        // Otherwise, check to see if there are multiple matches or a match                        // 200\n        // that is not us                                                                          // 201\n        (matchedUsers.length > 1 || matchedUsers[0]._id !== ownUserId))) {                         // 202\n      throw new Meteor.Error(403, displayName + \" already exists.\");                               // 203\n    }                                                                                              // 204\n  }                                                                                                // 205\n};                                                                                                 // 206\n                                                                                                   // 207\n// XXX maybe this belongs in the check package                                                     // 208\nvar NonEmptyString = Match.Where(function (x) {                                                    // 209\n  check(x, String);                                                                                // 210\n  return x.length > 0;                                                                             // 211\n});                                                                                                // 212\n                                                                                                   // 213\nvar userQueryValidator = Match.Where(function (user) {                                             // 214\n  check(user, {                                                                                    // 215\n    id: Match.Optional(NonEmptyString),                                                            // 216\n    username: Match.Optional(NonEmptyString),                                                      // 217\n    email: Match.Optional(NonEmptyString)                                                          // 218\n  });                                                                                              // 219\n  if (_.keys(user).length !== 1)                                                                   // 220\n    throw new Match.Error(\"User property must have exactly one field\");                            // 221\n  return true;                                                                                     // 222\n});                                                                                                // 223\n                                                                                                   // 224\nvar passwordValidator = Match.OneOf(                                                               // 225\n  String,                                                                                          // 226\n  { digest: String, algorithm: String }                                                            // 227\n);                                                                                                 // 228\n                                                                                                   // 229\n// Handler to login with a password.                                                               // 230\n//                                                                                                 // 231\n// The Meteor client sets options.password to an object with keys                                  // 232\n// 'digest' (set to SHA256(password)) and 'algorithm' (\"sha-256\").                                 // 233\n//                                                                                                 // 234\n// For other DDP clients which don't have access to SHA, the handler                               // 235\n// also accepts the plaintext password in options.password as a string.                            // 236\n//                                                                                                 // 237\n// (It might be nice if servers could turn the plaintext password                                  // 238\n// option off. Or maybe it should be opt-in, not opt-out?                                          // 239\n// Accounts.config option?)                                                                        // 240\n//                                                                                                 // 241\n// Note that neither password option is secure without SSL.                                        // 242\n//                                                                                                 // 243\nAccounts.registerLoginHandler(\"password\", function (options) {                                     // 244\n  if (! options.password || options.srp)                                                           // 245\n    return undefined; // don't handle                                                              // 246\n                                                                                                   // 247\n  check(options, {                                                                                 // 248\n    user: userQueryValidator,                                                                      // 249\n    password: passwordValidator                                                                    // 250\n  });                                                                                              // 251\n                                                                                                   // 252\n                                                                                                   // 253\n  var user = Accounts._findUserByQuery(options.user);                                              // 254\n  if (!user)                                                                                       // 255\n    throw new Meteor.Error(403, \"User not found\");                                                 // 256\n                                                                                                   // 257\n  if (!user.services || !user.services.password ||                                                 // 258\n      !(user.services.password.bcrypt || user.services.password.srp))                              // 259\n    throw new Meteor.Error(403, \"User has no password set\");                                       // 260\n                                                                                                   // 261\n  if (!user.services.password.bcrypt) {                                                            // 262\n    if (typeof options.password === \"string\") {                                                    // 263\n      // The client has presented a plaintext password, and the user is                            // 264\n      // not upgraded to bcrypt yet. We don't attempt to tell the client                           // 265\n      // to upgrade to bcrypt, because it might be a standalone DDP                                // 266\n      // client doesn't know how to do such a thing.                                               // 267\n      var verifier = user.services.password.srp;                                                   // 268\n      var newVerifier = SRP.generateVerifier(options.password, {                                   // 269\n        identity: verifier.identity, salt: verifier.salt});                                        // 270\n                                                                                                   // 271\n      if (verifier.verifier !== newVerifier.verifier) {                                            // 272\n        return {                                                                                   // 273\n          userId: user._id,                                                                        // 274\n          error: new Meteor.Error(403, \"Incorrect password\")                                       // 275\n        };                                                                                         // 276\n      }                                                                                            // 277\n                                                                                                   // 278\n      return {userId: user._id};                                                                   // 279\n    } else {                                                                                       // 280\n      // Tell the client to use the SRP upgrade process.                                           // 281\n      throw new Meteor.Error(400, \"old password format\", EJSON.stringify({                         // 282\n        format: 'srp',                                                                             // 283\n        identity: user.services.password.srp.identity                                              // 284\n      }));                                                                                         // 285\n    }                                                                                              // 286\n  }                                                                                                // 287\n                                                                                                   // 288\n  return checkPassword(                                                                            // 289\n    user,                                                                                          // 290\n    options.password                                                                               // 291\n  );                                                                                               // 292\n});                                                                                                // 293\n                                                                                                   // 294\n// Handler to login using the SRP upgrade path. To use this login                                  // 295\n// handler, the client must provide:                                                               // 296\n//   - srp: H(identity + \":\" + password)                                                           // 297\n//   - password: a string or an object with properties 'digest' and 'algorithm'                    // 298\n//                                                                                                 // 299\n// We use `options.srp` to verify that the client knows the correct                                // 300\n// password without doing a full SRP flow. Once we've checked that, we                             // 301\n// upgrade the user to bcrypt and remove the SRP information from the                              // 302\n// user document.                                                                                  // 303\n//                                                                                                 // 304\n// The client ends up using this login handler after trying the normal                             // 305\n// login handler (above), which throws an error telling the client to                              // 306\n// try the SRP upgrade path.                                                                       // 307\n//                                                                                                 // 308\n// XXX COMPAT WITH 0.8.1.3                                                                         // 309\nAccounts.registerLoginHandler(\"password\", function (options) {                                     // 310\n  if (!options.srp || !options.password)                                                           // 311\n    return undefined; // don't handle                                                              // 312\n                                                                                                   // 313\n  check(options, {                                                                                 // 314\n    user: userQueryValidator,                                                                      // 315\n    srp: String,                                                                                   // 316\n    password: passwordValidator                                                                    // 317\n  });                                                                                              // 318\n                                                                                                   // 319\n  var user = Accounts._findUserByQuery(options.user);                                              // 320\n  if (!user)                                                                                       // 321\n    throw new Meteor.Error(403, \"User not found\");                                                 // 322\n                                                                                                   // 323\n  // Check to see if another simultaneous login has already upgraded                               // 324\n  // the user record to bcrypt.                                                                    // 325\n  if (user.services && user.services.password && user.services.password.bcrypt)                    // 326\n    return checkPassword(user, options.password);                                                  // 327\n                                                                                                   // 328\n  if (!(user.services && user.services.password && user.services.password.srp))                    // 329\n    throw new Meteor.Error(403, \"User has no password set\");                                       // 330\n                                                                                                   // 331\n  var v1 = user.services.password.srp.verifier;                                                    // 332\n  var v2 = SRP.generateVerifier(                                                                   // 333\n    null,                                                                                          // 334\n    {                                                                                              // 335\n      hashedIdentityAndPassword: options.srp,                                                      // 336\n      salt: user.services.password.srp.salt                                                        // 337\n    }                                                                                              // 338\n  ).verifier;                                                                                      // 339\n  if (v1 !== v2)                                                                                   // 340\n    return {                                                                                       // 341\n      userId: user._id,                                                                            // 342\n      error: new Meteor.Error(403, \"Incorrect password\")                                           // 343\n    };                                                                                             // 344\n                                                                                                   // 345\n  // Upgrade to bcrypt on successful login.                                                        // 346\n  var salted = hashPassword(options.password);                                                     // 347\n  Meteor.users.update(                                                                             // 348\n    user._id,                                                                                      // 349\n    {                                                                                              // 350\n      $unset: { 'services.password.srp': 1 },                                                      // 351\n      $set: { 'services.password.bcrypt': salted }                                                 // 352\n    }                                                                                              // 353\n  );                                                                                               // 354\n                                                                                                   // 355\n  return {userId: user._id};                                                                       // 356\n});                                                                                                // 357\n                                                                                                   // 358\n                                                                                                   // 359\n///                                                                                                // 360\n/// CHANGING                                                                                       // 361\n///                                                                                                // 362\n                                                                                                   // 363\n/**                                                                                                // 364\n * @summary Change a user's username. Use this instead of updating the                             // 365\n * database directly. The operation will fail if there is an existing user                         // 366\n * with a username only differing in case.                                                         // 367\n * @locus Server                                                                                   // 368\n * @param {String} userId The ID of the user to update.                                            // 369\n * @param {String} newUsername A new username for the user.                                        // 370\n */                                                                                                // 371\nAccounts.setUsername = function (userId, newUsername) {                                            // 372\n  check(userId, NonEmptyString);                                                                   // 373\n  check(newUsername, NonEmptyString);                                                              // 374\n                                                                                                   // 375\n  var user = Meteor.users.findOne(userId);                                                         // 376\n  if (!user)                                                                                       // 377\n    throw new Meteor.Error(403, \"User not found\");                                                 // 378\n                                                                                                   // 379\n  var oldUsername = user.username;                                                                 // 380\n                                                                                                   // 381\n  // Perform a case insensitive check fro duplicates before update                                 // 382\n  checkForCaseInsensitiveDuplicates('username', 'Username', newUsername, user._id);                // 383\n                                                                                                   // 384\n  Meteor.users.update({_id: user._id}, {$set: {username: newUsername}});                           // 385\n                                                                                                   // 386\n  // Perform another check after update, in case a matching user has been                          // 387\n  // inserted in the meantime                                                                      // 388\n  try {                                                                                            // 389\n    checkForCaseInsensitiveDuplicates('username', 'Username', newUsername, user._id);              // 390\n  } catch (ex) {                                                                                   // 391\n    // Undo update if the check fails                                                              // 392\n    Meteor.users.update({_id: user._id}, {$set: {username: oldUsername}});                         // 393\n    throw ex;                                                                                      // 394\n  }                                                                                                // 395\n};                                                                                                 // 396\n                                                                                                   // 397\n// Let the user change their own password if they know the old                                     // 398\n// password. `oldPassword` and `newPassword` should be objects with keys                           // 399\n// `digest` and `algorithm` (representing the SHA256 of the password).                             // 400\n//                                                                                                 // 401\n// XXX COMPAT WITH 0.8.1.3                                                                         // 402\n// Like the login method, if the user hasn't been upgraded from SRP to                             // 403\n// bcrypt yet, then this method will throw an 'old password format'                                // 404\n// error. The client should call the SRP upgrade login handler and then                            // 405\n// retry this method again.                                                                        // 406\n//                                                                                                 // 407\n// UNLIKE the login method, there is no way to avoid getting SRP upgrade                           // 408\n// errors thrown. The reasoning for this is that clients using this                                // 409\n// method directly will need to be updated anyway because we no longer                             // 410\n// support the SRP flow that they would have been doing to use this                                // 411\n// method previously.                                                                              // 412\nMeteor.methods({changePassword: function (oldPassword, newPassword) {                              // 413\n  check(oldPassword, passwordValidator);                                                           // 414\n  check(newPassword, passwordValidator);                                                           // 415\n                                                                                                   // 416\n  if (!this.userId)                                                                                // 417\n    throw new Meteor.Error(401, \"Must be logged in\");                                              // 418\n                                                                                                   // 419\n  var user = Meteor.users.findOne(this.userId);                                                    // 420\n  if (!user)                                                                                       // 421\n    throw new Meteor.Error(403, \"User not found\");                                                 // 422\n                                                                                                   // 423\n  if (!user.services || !user.services.password ||                                                 // 424\n      (!user.services.password.bcrypt && !user.services.password.srp))                             // 425\n    throw new Meteor.Error(403, \"User has no password set\");                                       // 426\n                                                                                                   // 427\n  if (! user.services.password.bcrypt) {                                                           // 428\n    throw new Meteor.Error(400, \"old password format\", EJSON.stringify({                           // 429\n      format: 'srp',                                                                               // 430\n      identity: user.services.password.srp.identity                                                // 431\n    }));                                                                                           // 432\n  }                                                                                                // 433\n                                                                                                   // 434\n  var result = checkPassword(user, oldPassword);                                                   // 435\n  if (result.error)                                                                                // 436\n    throw result.error;                                                                            // 437\n                                                                                                   // 438\n  var hashed = hashPassword(newPassword);                                                          // 439\n                                                                                                   // 440\n  // It would be better if this removed ALL existing tokens and replaced                           // 441\n  // the token for the current connection with a new one, but that would                           // 442\n  // be tricky, so we'll settle for just replacing all tokens other than                           // 443\n  // the one for the current connection.                                                           // 444\n  var currentToken = Accounts._getLoginToken(this.connection.id);                                  // 445\n  Meteor.users.update(                                                                             // 446\n    { _id: this.userId },                                                                          // 447\n    {                                                                                              // 448\n      $set: { 'services.password.bcrypt': hashed },                                                // 449\n      $pull: {                                                                                     // 450\n        'services.resume.loginTokens': { hashedToken: { $ne: currentToken } }                      // 451\n      },                                                                                           // 452\n      $unset: { 'services.password.reset': 1 }                                                     // 453\n    }                                                                                              // 454\n  );                                                                                               // 455\n                                                                                                   // 456\n  return {passwordChanged: true};                                                                  // 457\n}});                                                                                               // 458\n                                                                                                   // 459\n                                                                                                   // 460\n// Force change the users password.                                                                // 461\n                                                                                                   // 462\n/**                                                                                                // 463\n * @summary Forcibly change the password for a user.                                               // 464\n * @locus Server                                                                                   // 465\n * @param {String} userId The id of the user to update.                                            // 466\n * @param {String} newPassword A new password for the user.                                        // 467\n * @param {Object} [options]                                                                       // 468\n * @param {Object} options.logout Logout all current connections with this userId (default: true)  // 469\n */                                                                                                // 470\nAccounts.setPassword = function (userId, newPlaintextPassword, options) {                          // 471\n  options = _.extend({logout: true}, options);                                                     // 472\n                                                                                                   // 473\n  var user = Meteor.users.findOne(userId);                                                         // 474\n  if (!user)                                                                                       // 475\n    throw new Meteor.Error(403, \"User not found\");                                                 // 476\n                                                                                                   // 477\n  var update = {                                                                                   // 478\n    $unset: {                                                                                      // 479\n      'services.password.srp': 1, // XXX COMPAT WITH 0.8.1.3                                       // 480\n      'services.password.reset': 1                                                                 // 481\n    },                                                                                             // 482\n    $set: {'services.password.bcrypt': hashPassword(newPlaintextPassword)}                         // 483\n  };                                                                                               // 484\n                                                                                                   // 485\n  if (options.logout) {                                                                            // 486\n    update.$unset['services.resume.loginTokens'] = 1;                                              // 487\n  }                                                                                                // 488\n                                                                                                   // 489\n  Meteor.users.update({_id: user._id}, update);                                                    // 490\n};                                                                                                 // 491\n                                                                                                   // 492\n                                                                                                   // 493\n///                                                                                                // 494\n/// RESETTING VIA EMAIL                                                                            // 495\n///                                                                                                // 496\n                                                                                                   // 497\n// Method called by a user to request a password reset email. This is                              // 498\n// the start of the reset process.                                                                 // 499\nMeteor.methods({forgotPassword: function (options) {                                               // 500\n  check(options, {email: String});                                                                 // 501\n                                                                                                   // 502\n  var user = Meteor.users.findOne({\"emails.address\": options.email});                              // 503\n  if (!user)                                                                                       // 504\n    throw new Meteor.Error(403, \"User not found\");                                                 // 505\n                                                                                                   // 506\n  Accounts.sendResetPasswordEmail(user._id, options.email);                                        // 507\n}});                                                                                               // 508\n                                                                                                   // 509\n// send the user an email with a link that when opened allows the user                             // 510\n// to set a new password, without the old password.                                                // 511\n                                                                                                   // 512\n/**                                                                                                // 513\n * @summary Send an email with a link the user can use to reset their password.                    // 514\n * @locus Server                                                                                   // 515\n * @param {String} userId The id of the user to send email to.                                     // 516\n * @param {String} [email] Optional. Which address of the user's to send the email to. This address must be in the user's `emails` list. Defaults to the first email in the list.\n */                                                                                                // 518\nAccounts.sendResetPasswordEmail = function (userId, email) {                                       // 519\n  // Make sure the user exists, and email is one of their addresses.                               // 520\n  var user = Meteor.users.findOne(userId);                                                         // 521\n  if (!user)                                                                                       // 522\n    throw new Error(\"Can't find user\");                                                            // 523\n  // pick the first email if we weren't passed an email.                                           // 524\n  if (!email && user.emails && user.emails[0])                                                     // 525\n    email = user.emails[0].address;                                                                // 526\n  // make sure we have a valid email                                                               // 527\n  if (!email || !_.contains(_.pluck(user.emails || [], 'address'), email))                         // 528\n    throw new Error(\"No such email for user.\");                                                    // 529\n                                                                                                   // 530\n  var token = Random.secret();                                                                     // 531\n  var when = new Date();                                                                           // 532\n  var tokenRecord = {                                                                              // 533\n    token: token,                                                                                  // 534\n    email: email,                                                                                  // 535\n    when: when                                                                                     // 536\n  };                                                                                               // 537\n  Meteor.users.update(userId, {$set: {                                                             // 538\n    \"services.password.reset\": tokenRecord                                                         // 539\n  }});                                                                                             // 540\n  // before passing to template, update user object with new token                                 // 541\n  Meteor._ensure(user, 'services', 'password').reset = tokenRecord;                                // 542\n                                                                                                   // 543\n  var resetPasswordUrl = Accounts.urls.resetPassword(token);                                       // 544\n                                                                                                   // 545\n  var options = {                                                                                  // 546\n    to: email,                                                                                     // 547\n    from: Accounts.emailTemplates.resetPassword.from                                               // 548\n      ? Accounts.emailTemplates.resetPassword.from(user)                                           // 549\n      : Accounts.emailTemplates.from,                                                              // 550\n    subject: Accounts.emailTemplates.resetPassword.subject(user)                                   // 551\n  };                                                                                               // 552\n                                                                                                   // 553\n  if (typeof Accounts.emailTemplates.resetPassword.text === 'function') {                          // 554\n    options.text =                                                                                 // 555\n      Accounts.emailTemplates.resetPassword.text(user, resetPasswordUrl);                          // 556\n  }                                                                                                // 557\n                                                                                                   // 558\n  if (typeof Accounts.emailTemplates.resetPassword.html === 'function')                            // 559\n    options.html =                                                                                 // 560\n      Accounts.emailTemplates.resetPassword.html(user, resetPasswordUrl);                          // 561\n                                                                                                   // 562\n  if (typeof Accounts.emailTemplates.headers === 'object') {                                       // 563\n    options.headers = Accounts.emailTemplates.headers;                                             // 564\n  }                                                                                                // 565\n                                                                                                   // 566\n  Email.send(options);                                                                             // 567\n};                                                                                                 // 568\n                                                                                                   // 569\n// send the user an email informing them that their account was created, with                      // 570\n// a link that when opened both marks their email as verified and forces them                      // 571\n// to choose their password. The email must be one of the addresses in the                         // 572\n// user's emails field, or undefined to pick the first email automatically.                        // 573\n//                                                                                                 // 574\n// This is not called automatically. It must be called manually if you                             // 575\n// want to use enrollment emails.                                                                  // 576\n                                                                                                   // 577\n/**                                                                                                // 578\n * @summary Send an email with a link the user can use to set their initial password.              // 579\n * @locus Server                                                                                   // 580\n * @param {String} userId The id of the user to send email to.                                     // 581\n * @param {String} [email] Optional. Which address of the user's to send the email to. This address must be in the user's `emails` list. Defaults to the first email in the list.\n */                                                                                                // 583\nAccounts.sendEnrollmentEmail = function (userId, email) {                                          // 584\n  // XXX refactor! This is basically identical to sendResetPasswordEmail.                          // 585\n                                                                                                   // 586\n  // Make sure the user exists, and email is in their addresses.                                   // 587\n  var user = Meteor.users.findOne(userId);                                                         // 588\n  if (!user)                                                                                       // 589\n    throw new Error(\"Can't find user\");                                                            // 590\n  // pick the first email if we weren't passed an email.                                           // 591\n  if (!email && user.emails && user.emails[0])                                                     // 592\n    email = user.emails[0].address;                                                                // 593\n  // make sure we have a valid email                                                               // 594\n  if (!email || !_.contains(_.pluck(user.emails || [], 'address'), email))                         // 595\n    throw new Error(\"No such email for user.\");                                                    // 596\n                                                                                                   // 597\n  var token = Random.secret();                                                                     // 598\n  var when = new Date();                                                                           // 599\n  var tokenRecord = {                                                                              // 600\n    token: token,                                                                                  // 601\n    email: email,                                                                                  // 602\n    when: when                                                                                     // 603\n  };                                                                                               // 604\n  Meteor.users.update(userId, {$set: {                                                             // 605\n    \"services.password.reset\": tokenRecord                                                         // 606\n  }});                                                                                             // 607\n                                                                                                   // 608\n  // before passing to template, update user object with new token                                 // 609\n  Meteor._ensure(user, 'services', 'password').reset = tokenRecord;                                // 610\n                                                                                                   // 611\n  var enrollAccountUrl = Accounts.urls.enrollAccount(token);                                       // 612\n                                                                                                   // 613\n  var options = {                                                                                  // 614\n    to: email,                                                                                     // 615\n    from: Accounts.emailTemplates.enrollAccount.from                                               // 616\n      ? Accounts.emailTemplates.enrollAccount.from(user)                                           // 617\n      : Accounts.emailTemplates.from,                                                              // 618\n    subject: Accounts.emailTemplates.enrollAccount.subject(user)                                   // 619\n  };                                                                                               // 620\n                                                                                                   // 621\n  if (typeof Accounts.emailTemplates.enrollAccount.text === 'function') {                          // 622\n    options.text =                                                                                 // 623\n      Accounts.emailTemplates.enrollAccount.text(user, enrollAccountUrl);                          // 624\n  }                                                                                                // 625\n                                                                                                   // 626\n  if (typeof Accounts.emailTemplates.enrollAccount.html === 'function')                            // 627\n    options.html =                                                                                 // 628\n      Accounts.emailTemplates.enrollAccount.html(user, enrollAccountUrl);                          // 629\n                                                                                                   // 630\n  if (typeof Accounts.emailTemplates.headers === 'object') {                                       // 631\n    options.headers = Accounts.emailTemplates.headers;                                             // 632\n  }                                                                                                // 633\n                                                                                                   // 634\n  Email.send(options);                                                                             // 635\n};                                                                                                 // 636\n                                                                                                   // 637\n                                                                                                   // 638\n// Take token from sendResetPasswordEmail or sendEnrollmentEmail, change                           // 639\n// the users password, and log them in.                                                            // 640\nMeteor.methods({resetPassword: function (token, newPassword) {                                     // 641\n  var self = this;                                                                                 // 642\n  return Accounts._loginMethod(                                                                    // 643\n    self,                                                                                          // 644\n    \"resetPassword\",                                                                               // 645\n    arguments,                                                                                     // 646\n    \"password\",                                                                                    // 647\n    function () {                                                                                  // 648\n      check(token, String);                                                                        // 649\n      check(newPassword, passwordValidator);                                                       // 650\n                                                                                                   // 651\n      var user = Meteor.users.findOne({                                                            // 652\n        \"services.password.reset.token\": token});                                                  // 653\n      if (!user)                                                                                   // 654\n        throw new Meteor.Error(403, \"Token expired\");                                              // 655\n      var email = user.services.password.reset.email;                                              // 656\n      if (!_.include(_.pluck(user.emails || [], 'address'), email))                                // 657\n        return {                                                                                   // 658\n          userId: user._id,                                                                        // 659\n          error: new Meteor.Error(403, \"Token has invalid email address\")                          // 660\n        };                                                                                         // 661\n                                                                                                   // 662\n      var hashed = hashPassword(newPassword);                                                      // 663\n                                                                                                   // 664\n      // NOTE: We're about to invalidate tokens on the user, who we might be                       // 665\n      // logged in as. Make sure to avoid logging ourselves out if this                            // 666\n      // happens. But also make sure not to leave the connection in a state                        // 667\n      // of having a bad token set if things fail.                                                 // 668\n      var oldToken = Accounts._getLoginToken(self.connection.id);                                  // 669\n      Accounts._setLoginToken(user._id, self.connection, null);                                    // 670\n      var resetToOldToken = function () {                                                          // 671\n        Accounts._setLoginToken(user._id, self.connection, oldToken);                              // 672\n      };                                                                                           // 673\n                                                                                                   // 674\n      try {                                                                                        // 675\n        // Update the user record by:                                                              // 676\n        // - Changing the password to the new one                                                  // 677\n        // - Forgetting about the reset token that was just used                                   // 678\n        // - Verifying their email, since they got the password reset via email.                   // 679\n        var affectedRecords = Meteor.users.update(                                                 // 680\n          {                                                                                        // 681\n            _id: user._id,                                                                         // 682\n            'emails.address': email,                                                               // 683\n            'services.password.reset.token': token                                                 // 684\n          },                                                                                       // 685\n          {$set: {'services.password.bcrypt': hashed,                                              // 686\n                  'emails.$.verified': true},                                                      // 687\n           $unset: {'services.password.reset': 1,                                                  // 688\n                    'services.password.srp': 1}});                                                 // 689\n        if (affectedRecords !== 1)                                                                 // 690\n          return {                                                                                 // 691\n            userId: user._id,                                                                      // 692\n            error: new Meteor.Error(403, \"Invalid email\")                                          // 693\n          };                                                                                       // 694\n      } catch (err) {                                                                              // 695\n        resetToOldToken();                                                                         // 696\n        throw err;                                                                                 // 697\n      }                                                                                            // 698\n                                                                                                   // 699\n      // Replace all valid login tokens with new ones (changing                                    // 700\n      // password should invalidate existing sessions).                                            // 701\n      Accounts._clearAllLoginTokens(user._id);                                                     // 702\n                                                                                                   // 703\n      return {userId: user._id};                                                                   // 704\n    }                                                                                              // 705\n  );                                                                                               // 706\n}});                                                                                               // 707\n                                                                                                   // 708\n///                                                                                                // 709\n/// EMAIL VERIFICATION                                                                             // 710\n///                                                                                                // 711\n                                                                                                   // 712\n                                                                                                   // 713\n// send the user an email with a link that when opened marks that                                  // 714\n// address as verified                                                                             // 715\n                                                                                                   // 716\n/**                                                                                                // 717\n * @summary Send an email with a link the user can use verify their email address.                 // 718\n * @locus Server                                                                                   // 719\n * @param {String} userId The id of the user to send email to.                                     // 720\n * @param {String} [email] Optional. Which address of the user's to send the email to. This address must be in the user's `emails` list. Defaults to the first unverified email in the list.\n */                                                                                                // 722\nAccounts.sendVerificationEmail = function (userId, address) {                                      // 723\n  // XXX Also generate a link using which someone can delete this                                  // 724\n  // account if they own said address but weren't those who created                                // 725\n  // this account.                                                                                 // 726\n                                                                                                   // 727\n  // Make sure the user exists, and address is one of their addresses.                             // 728\n  var user = Meteor.users.findOne(userId);                                                         // 729\n  if (!user)                                                                                       // 730\n    throw new Error(\"Can't find user\");                                                            // 731\n  // pick the first unverified address if we weren't passed an address.                            // 732\n  if (!address) {                                                                                  // 733\n    var email = _.find(user.emails || [],                                                          // 734\n                       function (e) { return !e.verified; });                                      // 735\n    address = (email || {}).address;                                                               // 736\n  }                                                                                                // 737\n  // make sure we have a valid address                                                             // 738\n  if (!address || !_.contains(_.pluck(user.emails || [], 'address'), address))                     // 739\n    throw new Error(\"No such email address for user.\");                                            // 740\n                                                                                                   // 741\n                                                                                                   // 742\n  var tokenRecord = {                                                                              // 743\n    token: Random.secret(),                                                                        // 744\n    address: address,                                                                              // 745\n    when: new Date()};                                                                             // 746\n  Meteor.users.update(                                                                             // 747\n    {_id: userId},                                                                                 // 748\n    {$push: {'services.email.verificationTokens': tokenRecord}});                                  // 749\n                                                                                                   // 750\n  // before passing to template, update user object with new token                                 // 751\n  Meteor._ensure(user, 'services', 'email');                                                       // 752\n  if (!user.services.email.verificationTokens) {                                                   // 753\n    user.services.email.verificationTokens = [];                                                   // 754\n  }                                                                                                // 755\n  user.services.email.verificationTokens.push(tokenRecord);                                        // 756\n                                                                                                   // 757\n  var verifyEmailUrl = Accounts.urls.verifyEmail(tokenRecord.token);                               // 758\n                                                                                                   // 759\n  var options = {                                                                                  // 760\n    to: address,                                                                                   // 761\n    from: Accounts.emailTemplates.verifyEmail.from                                                 // 762\n      ? Accounts.emailTemplates.verifyEmail.from(user)                                             // 763\n      : Accounts.emailTemplates.from,                                                              // 764\n    subject: Accounts.emailTemplates.verifyEmail.subject(user)                                     // 765\n  };                                                                                               // 766\n                                                                                                   // 767\n  if (typeof Accounts.emailTemplates.verifyEmail.text === 'function') {                            // 768\n    options.text =                                                                                 // 769\n      Accounts.emailTemplates.verifyEmail.text(user, verifyEmailUrl);                              // 770\n  }                                                                                                // 771\n                                                                                                   // 772\n  if (typeof Accounts.emailTemplates.verifyEmail.html === 'function')                              // 773\n    options.html =                                                                                 // 774\n      Accounts.emailTemplates.verifyEmail.html(user, verifyEmailUrl);                              // 775\n                                                                                                   // 776\n  if (typeof Accounts.emailTemplates.headers === 'object') {                                       // 777\n    options.headers = Accounts.emailTemplates.headers;                                             // 778\n  }                                                                                                // 779\n                                                                                                   // 780\n  Email.send(options);                                                                             // 781\n};                                                                                                 // 782\n                                                                                                   // 783\n// Take token from sendVerificationEmail, mark the email as verified,                              // 784\n// and log them in.                                                                                // 785\nMeteor.methods({verifyEmail: function (token) {                                                    // 786\n  var self = this;                                                                                 // 787\n  return Accounts._loginMethod(                                                                    // 788\n    self,                                                                                          // 789\n    \"verifyEmail\",                                                                                 // 790\n    arguments,                                                                                     // 791\n    \"password\",                                                                                    // 792\n    function () {                                                                                  // 793\n      check(token, String);                                                                        // 794\n                                                                                                   // 795\n      var user = Meteor.users.findOne(                                                             // 796\n        {'services.email.verificationTokens.token': token});                                       // 797\n      if (!user)                                                                                   // 798\n        throw new Meteor.Error(403, \"Verify email link expired\");                                  // 799\n                                                                                                   // 800\n      var tokenRecord = _.find(user.services.email.verificationTokens,                             // 801\n                               function (t) {                                                      // 802\n                                 return t.token == token;                                          // 803\n                               });                                                                 // 804\n      if (!tokenRecord)                                                                            // 805\n        return {                                                                                   // 806\n          userId: user._id,                                                                        // 807\n          error: new Meteor.Error(403, \"Verify email link expired\")                                // 808\n        };                                                                                         // 809\n                                                                                                   // 810\n      var emailsRecord = _.find(user.emails, function (e) {                                        // 811\n        return e.address == tokenRecord.address;                                                   // 812\n      });                                                                                          // 813\n      if (!emailsRecord)                                                                           // 814\n        return {                                                                                   // 815\n          userId: user._id,                                                                        // 816\n          error: new Meteor.Error(403, \"Verify email link is for unknown address\")                 // 817\n        };                                                                                         // 818\n                                                                                                   // 819\n      // By including the address in the query, we can use 'emails.$' in the                       // 820\n      // modifier to get a reference to the specific object in the emails                          // 821\n      // array. See                                                                                // 822\n      // http://www.mongodb.org/display/DOCS/Updating/#Updating-The%24positionaloperator)          // 823\n      // http://www.mongodb.org/display/DOCS/Updating#Updating-%24pull                             // 824\n      Meteor.users.update(                                                                         // 825\n        {_id: user._id,                                                                            // 826\n         'emails.address': tokenRecord.address},                                                   // 827\n        {$set: {'emails.$.verified': true},                                                        // 828\n         $pull: {'services.email.verificationTokens': {address: tokenRecord.address}}});           // 829\n                                                                                                   // 830\n      return {userId: user._id};                                                                   // 831\n    }                                                                                              // 832\n  );                                                                                               // 833\n}});                                                                                               // 834\n                                                                                                   // 835\n/**                                                                                                // 836\n * @summary Add an email address for a user. Use this instead of directly                          // 837\n * updating the database. The operation will fail if there is a different user                     // 838\n * with an email only differing in case. If the specified user has an existing                     // 839\n * email only differing in case however, we replace it.                                            // 840\n * @locus Server                                                                                   // 841\n * @param {String} userId The ID of the user to update.                                            // 842\n * @param {String} newEmail A new email address for the user.                                      // 843\n * @param {Boolean} [verified] Optional - whether the new email address should                     // 844\n * be marked as verified. Defaults to false.                                                       // 845\n */                                                                                                // 846\nAccounts.addEmail = function (userId, newEmail, verified) {                                        // 847\n  check(userId, NonEmptyString);                                                                   // 848\n  check(newEmail, NonEmptyString);                                                                 // 849\n  check(verified, Match.Optional(Boolean));                                                        // 850\n                                                                                                   // 851\n  if (_.isUndefined(verified)) {                                                                   // 852\n    verified = false;                                                                              // 853\n  }                                                                                                // 854\n                                                                                                   // 855\n  var user = Meteor.users.findOne(userId);                                                         // 856\n  if (!user)                                                                                       // 857\n    throw new Meteor.Error(403, \"User not found\");                                                 // 858\n                                                                                                   // 859\n  // Allow users to change their own email to a version with a different case                      // 860\n                                                                                                   // 861\n  // We don't have to call checkForCaseInsensitiveDuplicates to do a case                          // 862\n  // insensitive check across all emails in the database here because: (1) if                      // 863\n  // there is no case-insensitive duplicate between this user and other users,                     // 864\n  // then we are OK and (2) if this would create a conflict with other users                       // 865\n  // then there would already be a case-insensitive duplicate and we can't fix                     // 866\n  // that in this code anyway.                                                                     // 867\n  var caseInsensitiveRegExp =                                                                      // 868\n    new RegExp('^' + Meteor._escapeRegExp(newEmail) + '$', 'i');                                   // 869\n                                                                                                   // 870\n  var didUpdateOwnEmail = _.any(user.emails, function(email, index) {                              // 871\n    if (caseInsensitiveRegExp.test(email.address)) {                                               // 872\n      Meteor.users.update({                                                                        // 873\n        _id: user._id,                                                                             // 874\n        'emails.address': email.address                                                            // 875\n      }, {$set: {                                                                                  // 876\n        'emails.$.address': newEmail,                                                              // 877\n        'emails.$.verified': verified                                                              // 878\n      }});                                                                                         // 879\n      return true;                                                                                 // 880\n    }                                                                                              // 881\n                                                                                                   // 882\n    return false;                                                                                  // 883\n  });                                                                                              // 884\n                                                                                                   // 885\n  // In the other updates below, we have to do another call to                                     // 886\n  // checkForCaseInsensitiveDuplicates to make sure that no conflicting values                     // 887\n  // were added to the database in the meantime. We don't have to do this for                      // 888\n  // the case where the user is updating their email address to one that is the                    // 889\n  // same as before, but only different because of capitalization. Read the                        // 890\n  // big comment above to understand why.                                                          // 891\n                                                                                                   // 892\n  if (didUpdateOwnEmail) {                                                                         // 893\n    return;                                                                                        // 894\n  }                                                                                                // 895\n                                                                                                   // 896\n  // Perform a case insensitive check for duplicates before update                                 // 897\n  checkForCaseInsensitiveDuplicates('emails.address', 'Email', newEmail, user._id);                // 898\n                                                                                                   // 899\n  Meteor.users.update({                                                                            // 900\n    _id: user._id                                                                                  // 901\n  }, {                                                                                             // 902\n    $addToSet: {                                                                                   // 903\n      emails: {                                                                                    // 904\n        address: newEmail,                                                                         // 905\n        verified: verified                                                                         // 906\n      }                                                                                            // 907\n    }                                                                                              // 908\n  });                                                                                              // 909\n                                                                                                   // 910\n  // Perform another check after update, in case a matching user has been                          // 911\n  // inserted in the meantime                                                                      // 912\n  try {                                                                                            // 913\n    checkForCaseInsensitiveDuplicates('emails.address', 'Email', newEmail, user._id);              // 914\n  } catch (ex) {                                                                                   // 915\n    // Undo update if the check fails                                                              // 916\n    Meteor.users.update({_id: user._id},                                                           // 917\n      {$pull: {emails: {address: newEmail}}});                                                     // 918\n    throw ex;                                                                                      // 919\n  }                                                                                                // 920\n}                                                                                                  // 921\n                                                                                                   // 922\n/**                                                                                                // 923\n * @summary Remove an email address for a user. Use this instead of updating                       // 924\n * the database directly.                                                                          // 925\n * @locus Server                                                                                   // 926\n * @param {String} userId The ID of the user to update.                                            // 927\n * @param {String} email The email address to remove.                                              // 928\n */                                                                                                // 929\nAccounts.removeEmail = function (userId, email) {                                                  // 930\n  check(userId, NonEmptyString);                                                                   // 931\n  check(email, NonEmptyString);                                                                    // 932\n                                                                                                   // 933\n  var user = Meteor.users.findOne(userId);                                                         // 934\n  if (!user)                                                                                       // 935\n    throw new Meteor.Error(403, \"User not found\");                                                 // 936\n                                                                                                   // 937\n  Meteor.users.update({_id: user._id},                                                             // 938\n    {$pull: {emails: {address: email}}});                                                          // 939\n}                                                                                                  // 940\n                                                                                                   // 941\n///                                                                                                // 942\n/// CREATING USERS                                                                                 // 943\n///                                                                                                // 944\n                                                                                                   // 945\n// Shared createUser function called from the createUser method, both                              // 946\n// if originates in client or server code. Calls user provided hooks,                              // 947\n// does the actual user insertion.                                                                 // 948\n//                                                                                                 // 949\n// returns the user id                                                                             // 950\nvar createUser = function (options) {                                                              // 951\n  // Unknown keys allowed, because a onCreateUserHook can take arbitrary                           // 952\n  // options.                                                                                      // 953\n  check(options, Match.ObjectIncluding({                                                           // 954\n    username: Match.Optional(String),                                                              // 955\n    email: Match.Optional(String),                                                                 // 956\n    password: Match.Optional(passwordValidator)                                                    // 957\n  }));                                                                                             // 958\n                                                                                                   // 959\n  var username = options.username;                                                                 // 960\n  var email = options.email;                                                                       // 961\n  if (!username && !email)                                                                         // 962\n    throw new Meteor.Error(400, \"Need to set a username or email\");                                // 963\n                                                                                                   // 964\n  var user = {services: {}};                                                                       // 965\n  if (options.password) {                                                                          // 966\n    var hashed = hashPassword(options.password);                                                   // 967\n    user.services.password = { bcrypt: hashed };                                                   // 968\n  }                                                                                                // 969\n                                                                                                   // 970\n  if (username)                                                                                    // 971\n    user.username = username;                                                                      // 972\n  if (email)                                                                                       // 973\n    user.emails = [{address: email, verified: false}];                                             // 974\n                                                                                                   // 975\n  // Perform a case insensitive check before insert                                                // 976\n  checkForCaseInsensitiveDuplicates('username', 'Username', username);                             // 977\n  checkForCaseInsensitiveDuplicates('emails.address', 'Email', email);                             // 978\n                                                                                                   // 979\n  var userId = Accounts.insertUserDoc(options, user);                                              // 980\n  // Perform another check after insert, in case a matching user has been                          // 981\n  // inserted in the meantime                                                                      // 982\n  try {                                                                                            // 983\n    checkForCaseInsensitiveDuplicates('username', 'Username', username, userId);                   // 984\n    checkForCaseInsensitiveDuplicates('emails.address', 'Email', email, userId);                   // 985\n  } catch (ex) {                                                                                   // 986\n    // Remove inserted user if the check fails                                                     // 987\n    Meteor.users.remove(userId);                                                                   // 988\n    throw ex;                                                                                      // 989\n  }                                                                                                // 990\n  return userId;                                                                                   // 991\n};                                                                                                 // 992\n                                                                                                   // 993\n// method for create user. Requests come from the client.                                          // 994\nMeteor.methods({createUser: function (options) {                                                   // 995\n  var self = this;                                                                                 // 996\n  return Accounts._loginMethod(                                                                    // 997\n    self,                                                                                          // 998\n    \"createUser\",                                                                                  // 999\n    arguments,                                                                                     // 1000\n    \"password\",                                                                                    // 1001\n    function () {                                                                                  // 1002\n      // createUser() above does more checking.                                                    // 1003\n      check(options, Object);                                                                      // 1004\n      if (Accounts._options.forbidClientAccountCreation)                                           // 1005\n        return {                                                                                   // 1006\n          error: new Meteor.Error(403, \"Signups forbidden\")                                        // 1007\n        };                                                                                         // 1008\n                                                                                                   // 1009\n      // Create user. result contains id and token.                                                // 1010\n      var userId = createUser(options);                                                            // 1011\n      // safety belt. createUser is supposed to throw on error. send 500 error                     // 1012\n      // instead of sending a verification email with empty userid.                                // 1013\n      if (! userId)                                                                                // 1014\n        throw new Error(\"createUser failed to insert new user\");                                   // 1015\n                                                                                                   // 1016\n      // If `Accounts._options.sendVerificationEmail` is set, register                             // 1017\n      // a token to verify the user's primary email, and send it to                                // 1018\n      // that address.                                                                             // 1019\n      if (options.email && Accounts._options.sendVerificationEmail)                                // 1020\n        Accounts.sendVerificationEmail(userId, options.email);                                     // 1021\n                                                                                                   // 1022\n      // client gets logged in as the new user afterwards.                                         // 1023\n      return {userId: userId};                                                                     // 1024\n    }                                                                                              // 1025\n  );                                                                                               // 1026\n}});                                                                                               // 1027\n                                                                                                   // 1028\n// Create user directly on the server.                                                             // 1029\n//                                                                                                 // 1030\n// Unlike the client version, this does not log you in as this user                                // 1031\n// after creation.                                                                                 // 1032\n//                                                                                                 // 1033\n// returns userId or throws an error if it can't create                                            // 1034\n//                                                                                                 // 1035\n// XXX add another argument (\"server options\") that gets sent to onCreateUser,                     // 1036\n// which is always empty when called from the createUser method? eg, \"admin:                       // 1037\n// true\", which we want to prevent the client from setting, but which a custom                     // 1038\n// method calling Accounts.createUser could set?                                                   // 1039\n//                                                                                                 // 1040\nAccounts.createUser = function (options, callback) {                                               // 1041\n  options = _.clone(options);                                                                      // 1042\n                                                                                                   // 1043\n  // XXX allow an optional callback?                                                               // 1044\n  if (callback) {                                                                                  // 1045\n    throw new Error(\"Accounts.createUser with callback not supported on the server yet.\");         // 1046\n  }                                                                                                // 1047\n                                                                                                   // 1048\n  return createUser(options);                                                                      // 1049\n};                                                                                                 // 1050\n                                                                                                   // 1051\n///                                                                                                // 1052\n/// PASSWORD-SPECIFIC INDEXES ON USERS                                                             // 1053\n///                                                                                                // 1054\nMeteor.users._ensureIndex('services.email.verificationTokens.token',                               // 1055\n                          {unique: 1, sparse: 1});                                                 // 1056\nMeteor.users._ensureIndex('services.password.reset.token',                                         // 1057\n                          {unique: 1, sparse: 1});                                                 // 1058\n                                                                                                   // 1059\n/////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n"]}}]