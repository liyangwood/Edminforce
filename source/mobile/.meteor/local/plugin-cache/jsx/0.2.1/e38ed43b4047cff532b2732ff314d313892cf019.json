{"metadata":{"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}},"usedHelpers":[]},"ignored":false,"code":"/**\n * Created on 9/25/15.\n */\n\nDependency.add('classEdit.ChangeClass.store', new function () {\n\n    var self = this;\n\n    self.swimmerId = new ReactiveVar();\n    self.classId = new ReactiveVar();\n\n    self.swimmer = new ReactiveVar();\n    self[\"class\"] = new ReactiveVar();\n\n    self.currentLevel = new ReactiveVar();\n\n    //可选days 依赖于 当前的currentLevel\n    self.avaiableDays = new ReactiveVar([]);\n    //可选时间   依赖于 当前选中的currentDay\n    self.avaiableTimes = new ReactiveVar([]);\n\n    //选择的class\n    self.currentDay = new ReactiveVar();\n    self.currentTime = new ReactiveVar();\n    self.currentClass = new ReactiveVar();\n\n    self.tokenId = Dispatcher.register(function (payload) {\n\n        switch (payload.actionType) {\n\n            case \"ChangeClassPage_INIT\":\n                {\n\n                    self.swimmerId.set(payload.swimmerId);\n                    self.classId.set(payload.classId);\n\n                    Meteor.subscribe(\"classes\");\n                    Meteor.subscribe(\"swimmer\", payload.swimmerId);\n\n                    break;\n                }\n            case \"ChangeClassPage_DAY_CHANGE\":\n                {\n\n                    debugger;\n\n                    self.currentDay.set(payload.day);\n                    break;\n                }\n            case \"ChangeClassPage_TIME_CHANGE\":\n                {\n\n                    debugger;\n                    self.currentTime.set(payload.time);\n\n                    break;\n                }\n            case \"ChangeClassPage_CLASS_CONFIRM\":\n                {\n\n                    var href = '/classEdit/ChangeClassBillingPage';\n\n                    FlowRouter.go(href);\n\n                    break;\n                }\n            case \"ChangeClassPage_BILLING_CONFIRM\":\n                {\n\n                    var swimmer = self.swimmer.get();\n                    var oldClass = self[\"class\"].get();\n                    var newClass = self.currentClass.get();\n\n                    debugger;\n                    Meteor.call('change_class', swimmer._id, oldClass._id, newClass._id, function (err) {\n                        if (err) {\n                            //todo  prompt\n                            console.error(err);\n                            alert(err.message);\n                            return;\n                        }\n\n                        FlowRouter.go('/classEdit/swimmerList');\n                    });\n\n                    break;\n                }\n            case \"ChangeClassPage_CLASS_SEND_REQUEST\":\n                {\n\n                    var currentClass = self.currentClass.get();\n                    if (!currentClass) {\n                        alert('Please select a class to change');\n                        return;\n                    }\n                    alert('Your request to change class for ' + 'Daniel has been submitted. ' + 'We’ll contact you soon.');\n\n                    var href = '/classEdit/swimmerList';\n\n                    FlowRouter.go(href);\n\n                    break;\n                }\n\n            //每次 router到这个页面 清空用户选择\n            case \"GOTO_ChangeClassPage\":\n                {\n                    self.currentDay.set();\n                    self.currentTime.set();\n                    self.currentClass.set();\n                }\n\n        }\n    });\n\n    //todo  为autorun 添加 ignore逻辑 优化性能\n    Meteor.startup(function () {\n\n        //swimmerId  classId\n        Tracker.autorun(function () {\n\n            var swimmerId = self.swimmerId.get();\n            var classId = self.classId.get();\n\n            if (!swimmerId || !classId) return;\n\n            var swimmer = DB.Swimmers.findOne({ _id: swimmerId });\n            var classDetail = DB.Classes.findOne({ _id: classId });\n\n            if (!swimmer || !classDetail) return;\n\n            self.swimmer.set(swimmer);\n            self[\"class\"].set(classDetail);\n\n            //var curentLevel= App.getNextClassLevel(swimmer.level)\n            //console.log(curentLevel)\n            //\n            //self.currentLevel.set(curentLevel)\n        });\n\n        Tracker.autorun(function () {\n            var currentSwimmer = self.swimmer.get();\n            var appInfo = DB.App.findOne();\n\n            if (!appInfo) return;\n            if (!currentSwimmer) return;\n\n            Tracker.autorun(function () {\n\n                var nowClasses = DB.ClassesRegister.find({\n                    swimmerId: currentSwimmer._id,\n                    status: 'normal', //不显示cancel中的和 change中的\n                    sessionId: App.info.sessionNow\n                }).fetch();\n\n                //self.nowClasses.set(nowClasses)\n\n                if (nowClasses.length > 0) {\n                    self.currentLevel.set(App.getNextClassLevel(currentSwimmer.level));\n                } else {\n                    self.currentLevel.set(currentSwimmer.level);\n                }\n            });\n        });\n\n        //选择 avaiableDays\n        Tracker.autorun(function () {\n            App.info = App.info || DB.App.findOne();\n            if (!App.info) return;\n\n            var level = self.currentLevel.get();\n\n            var classes = DB.Classes.find({\n                sessionId: App.info.sessionRegister, //level session\n                levels: level,\n                _id: { $ne: self.classId.get() } //除去当前class\n            }).fetch();\n\n            console.log(level, classes);\n            classes = _.uniq(classes, function (item, key, a) {\n                return item.day;\n            });\n\n            var days = classes.map(function (v, n) {\n                return { text: App.Config.week[v.day], value: v.day };\n            });\n\n            days.unshift({ value: undefined });\n\n            //debugger\n\n            self.avaiableDays.set(days);\n        });\n\n        Tracker.autorun(function () {\n            App.info = App.info || DB.App.findOne();\n            if (!App.info) return;\n\n            var currentDay = self.currentDay.get();\n\n            var level = self.currentLevel.get();\n\n            var classes = DB.Classes.find({\n                sessionId: App.info.sessionRegister, // session level day\n                levels: level,\n                day: currentDay,\n                _id: { $ne: self.classId.get() }\n            }).fetch();\n\n            var times = classes.map(function (v, n) {\n                return {\n                    text: App.num2time(v.startTime) + \"-\" + App.num2time(v.endTime),\n                    value: v.startTime\n                };\n            });\n\n            //add an empty value to prevent browser init select value  use the first item\n            times.unshift({ value: undefined });\n\n            self.avaiableTimes.set(times);\n\n            //初始化time\n            //if (times.length) {\n            //    self.currentTime.set(times[0].value)\n            //}\n        });\n\n        Tracker.autorun(function () {\n            App.info = App.info || DB.App.findOne();\n            if (!App.info) return;\n\n            var time = self.currentTime.get();\n\n            var level = self.currentLevel.get();\n            var day = self.currentDay.get();\n\n            var theClass = DB.Classes.findOne({\n                sessionId: App.info.sessionRegister, // session level day\n                levels: level,\n                day: day,\n                startTime: time\n            });\n\n            if (theClass) {\n                self.currentClass.set(theClass);\n            }\n        });\n    });\n}());","ast":null,"map":{"version":3,"sources":["/client/app/class.edit/ChangeClassPage.store.jsx"],"names":[],"mappings":";;;;AAIA,UAAU,CAAC,GAAG,CAAC,6BAA6B,EAAE,IAAI,YAAY;;AAE1D,QAAI,IAAI,GAAG,IAAI,CAAC;;AAGhB,QAAI,CAAC,SAAS,GAAG,IAAI,WAAW,EAAE,CAAA;AAClC,QAAI,CAAC,OAAO,GAAG,IAAI,WAAW,EAAE,CAAA;;AAGhC,QAAI,CAAC,OAAO,GAAG,IAAI,WAAW,EAAE,CAAA;AAChC,QAAI,SAAM,GAAG,IAAI,WAAW,EAAE,CAAA;;AAE9B,QAAI,CAAC,YAAY,GAAG,IAAI,WAAW,EAAE,CAAA;;;AAIrC,QAAI,CAAC,YAAY,GAAG,IAAI,WAAW,CAAC,EAAE,CAAC,CAAA;;AAEvC,QAAI,CAAC,aAAa,GAAG,IAAI,WAAW,CAAC,EAAE,CAAC,CAAA;;;AAIxC,QAAI,CAAC,UAAU,GAAG,IAAI,WAAW,EAAE,CAAA;AACnC,QAAI,CAAC,WAAW,GAAG,IAAI,WAAW,EAAE,CAAA;AACpC,QAAI,CAAC,YAAY,GAAG,IAAI,WAAW,EAAE,CAAA;;AAGrC,QAAI,CAAC,OAAO,GAAG,UAAU,CAAC,QAAQ,CAAC,UAAU,OAAO,EAAE;;AAElD,gBAAQ,OAAO,CAAC,UAAU;;AAItB,iBAAK,sBAAsB;AAC3B;;AAEI,wBAAI,CAAC,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,CAAC,CAAA;AACrC,wBAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,CAAA;;AAEjC,0BAAM,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;AAC5B,0BAAM,CAAC,SAAS,CAAC,SAAS,EAAE,OAAO,CAAC,SAAS,CAAC,CAAC;;AAG/C,0BAAM;iBACT;AAAA,AACD,iBAAK,4BAA4B;AACjC;;AAEI,6BAAQ;;AAER,wBAAI,CAAC,UAAU,CAAC,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,CAAA;AAChC,0BAAM;iBACT;AAAA,AACD,iBAAK,6BAA6B;AAClC;;AAEI,6BAAQ;AACR,wBAAI,CAAC,WAAW,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,CAAA;;AAElC,0BAAM;iBACT;AAAA,AACD,iBAAK,+BAA+B;AACpC;;AAEI,wBAAI,IAAI,GAAG,mCAAmC,CAAA;;AAE9C,8BAAU,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC;;AAEpB,0BAAM;iBACT;AAAA,AACD,iBAAK,iCAAiC;AACtC;;AAEI,wBAAI,OAAO,GAAE,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,CAAA;AAC/B,wBAAI,QAAQ,GAAG,IAAI,SAAM,CAAC,GAAG,EAAE,CAAA;AAC/B,wBAAI,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,EAAE,CAAA;;AAGtC,6BAAQ;AACR,0BAAM,CAAC,IAAI,CAAC,cAAc,EACtB,OAAO,CAAC,GAAG,EACX,QAAQ,CAAC,GAAG,EACZ,QAAQ,CAAC,GAAG,EAEZ,UAAU,GAAG,EAAE;AACf,4BAAI,GAAG,EAAE;;AACL,mCAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;AAClB,iCAAK,CAAC,GAAG,CAAC,OAAO,CAAC,CAAA;AAClB,mCAAO;yBACV;;AAED,kCAAU,CAAC,EAAE,CAAC,wBAAwB,CAAC,CAAC;qBAC3C,CAAC,CAAA;;AAEF,0BAAM;iBACT;AAAA,AACD,iBAAK,oCAAoC;AACzC;;AAEI,wBAAI,YAAY,GAAE,IAAI,CAAC,YAAY,CAAC,GAAG,EAAE,CAAA;AACzC,wBAAG,CAAC,YAAY,EAAC;AACb,6BAAK,CAAC,iCAAiC,CAAC,CAAA;AACxC,+BAAM;qBACT;AACD,yBAAK,CACD,mCAAmC,GACnC,6BAA6B,GAC7B,yBAAyB,CAC5B,CAAA;;AAED,wBAAI,IAAI,GAAG,wBAAwB,CAAA;;AAEnC,8BAAU,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC;;AAEpB,0BAAM;iBACT;;AAAA;AAMD,iBAAK,sBAAsB;AAC3B;AACI,wBAAI,CAAC,UAAU,CAAC,GAAG,EAAE,CAAA;AACrB,wBAAI,CAAC,WAAW,CAAC,GAAG,EAAE,CAAA;AACtB,wBAAI,CAAC,YAAY,CAAC,GAAG,EAAE,CAAA;iBAE1B;;AAAA,SAIJ;KACJ,CAAC,CAAA;;;AAIF,UAAM,CAAC,OAAO,CAAC,YAAY;;;AAGvB,eAAO,CAAC,OAAO,CAAC,YAAY;;AAExB,gBAAI,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,CAAA;AACpC,gBAAI,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,CAAA;;AAEhC,gBAAG,CAAC,SAAS,IAAI,CAAC,OAAO,EAAE,OAAO;;AAElC,gBAAI,OAAO,GAAG,EAAE,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAC,GAAG,EAAE,SAAS,EAAC,CAAC,CAAA;AACnD,gBAAI,WAAW,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,EAAC,GAAG,EAAE,OAAO,EAAC,CAAC,CAAA;;AAEpD,gBAAG,CAAC,OAAO,IAAI,CAAC,WAAW,EAAE,OAAO;;AAEpC,gBAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAA;AACzB,gBAAI,SAAM,CAAC,GAAG,CAAC,WAAW,CAAC,CAAA;;;;;;SAQ9B,CAAC,CAAA;;AAEF,eAAO,CAAC,OAAO,CAAC,YAAY;AACxB,gBAAI,cAAc,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,CAAA;AACvC,gBAAI,OAAO,GAAG,EAAE,CAAC,GAAG,CAAC,OAAO,EAAE,CAAA;;AAE9B,gBAAG,CAAC,OAAO,EAAE,OAAO;AACpB,gBAAG,CAAC,cAAc,EAAE,OAAO;;AAE3B,mBAAO,CAAC,OAAO,CAAC,YAAY;;AAExB,oBAAI,UAAU,GAAG,EAAE,CAAC,eAAe,CAAC,IAAI,CAAC;AACrC,6BAAS,EAAE,cAAc,CAAC,GAAG;AAC7B,0BAAM,EAAC,QAAQ;AACf,6BAAS,EAAE,GAAG,CAAC,IAAI,CAAC,UAAU;iBACjC,CAAC,CAAC,KAAK,EAAE,CAAC;;;;AAIX,oBAAG,UAAU,CAAC,MAAM,GAAC,CAAC,EAAC;AACnB,wBAAI,CAAC,YAAY,CAAC,GAAG,CAAC,GAAG,CAAC,iBAAiB,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,CAAA;iBAErE,MAAI;AACD,wBAAI,CAAC,YAAY,CAAC,GAAG,CAAC,cAAc,CAAC,KAAK,CAAC,CAAA;iBAC9C;aAEJ,CAAC,CAAA;SAEL,CAAC,CAAA;;;AAGF,eAAO,CAAC,OAAO,CAAC,YAAY;AACxB,eAAG,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,IAAI,EAAE,CAAC,GAAG,CAAC,OAAO,EAAE,CAAA;AACvC,gBAAI,CAAC,GAAG,CAAC,IAAI,EAAE,OAAO;;AAEtB,gBAAI,KAAK,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,EAAE,CAAA;;AAEnC,gBAAI,OAAO,GAAG,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;AAC1B,yBAAS,EAAE,GAAG,CAAC,IAAI,CAAC,eAAe;AACnC,sBAAM,EAAE,KAAK;AACb,mBAAG,EAAC,EAAC,GAAG,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,EAAC;aAChC,CAAC,CAAC,KAAK,EAAE,CAAA;;AAEV,mBAAO,CAAC,GAAG,CAAC,KAAK,EAAC,OAAO,CAAC,CAAA;AAC1B,mBAAO,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,EAAE,UAAU,IAAI,EAAE,GAAG,EAAE,CAAC,EAAE;AAC9C,uBAAO,IAAI,CAAC,GAAG,CAAC;aACnB,CAAC,CAAC;;AAEH,gBAAI,IAAI,GAAG,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC,EAAE;AACnC,uBAAO,EAAC,IAAI,EAAE,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,GAAG,EAAC,CAAA;aACtD,CAAC,CAAA;;AAEF,gBAAI,CAAC,OAAO,CAAC,EAAC,KAAK,EAAE,SAAS,EAAC,CAAC,CAAA;;;;AAIhC,gBAAI,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAA;SAG9B,CAAC,CAAA;;AAGF,eAAO,CAAC,OAAO,CAAC,YAAY;AACxB,eAAG,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,IAAI,EAAE,CAAC,GAAG,CAAC,OAAO,EAAE,CAAA;AACvC,gBAAI,CAAC,GAAG,CAAC,IAAI,EAAE,OAAO;;AAEtB,gBAAI,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;;AAEvC,gBAAI,KAAK,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,EAAE,CAAA;;AAEnC,gBAAI,OAAO,GAAG,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;AAC1B,yBAAS,EAAE,GAAG,CAAC,IAAI,CAAC,eAAe;AACnC,sBAAM,EAAE,KAAK;AACb,mBAAG,EAAE,UAAU;AACf,mBAAG,EAAC,EAAC,GAAG,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,EAAC;aAChC,CAAC,CAAC,KAAK,EAAE,CAAA;;AAEV,gBAAI,KAAK,GAAG,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC,EAAE;AACpC,uBAAO;AACH,wBAAI,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,SAAS,CAAC,GAAG,GAAG,GAAG,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC;AAC/D,yBAAK,EAAE,CAAC,CAAC,SAAS;iBACrB,CAAA;aACJ,CAAC,CAAA;;;AAGF,iBAAK,CAAC,OAAO,CAAC,EAAC,KAAK,EAAE,SAAS,EAAC,CAAC,CAAA;;AAEjC,gBAAI,CAAC,aAAa,CAAC,GAAG,CAAC,KAAK,CAAC,CAAA;;;;;;SAOhC,CAAC,CAAC;;AAGH,eAAO,CAAC,OAAO,CAAC,YAAY;AACxB,eAAG,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,IAAI,EAAE,CAAC,GAAG,CAAC,OAAO,EAAE,CAAA;AACvC,gBAAI,CAAC,GAAG,CAAC,IAAI,EAAE,OAAO;;AAEtB,gBAAI,IAAI,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,EAAE,CAAA;;AAEjC,gBAAI,KAAK,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,EAAE,CAAA;AACnC,gBAAI,GAAG,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,CAAA;;AAG/B,gBAAI,QAAQ,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC;AAC9B,yBAAS,EAAE,GAAG,CAAC,IAAI,CAAC,eAAe;AACnC,sBAAM,EAAE,KAAK;AACb,mBAAG,EAAE,GAAG;AACR,yBAAS,EAAE,IAAI;aAClB,CAAC,CAAA;;AAEF,gBAAI,QAAQ,EAAE;AACV,oBAAI,CAAC,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAA;aAClC;SAEJ,CAAC,CAAC;KAGN,CAAC,CAAA;CAGL,EAAA,CAAC,CAAA","file":"/client/app/class.edit/ChangeClassPage.store.jsx.map","sourcesContent":["/**\n * Created on 9/25/15.\n */\n\nDependency.add('classEdit.ChangeClass.store', new function () {\n\n    var self = this;\n\n\n    self.swimmerId = new ReactiveVar()\n    self.classId = new ReactiveVar()\n\n\n    self.swimmer = new ReactiveVar()\n    self.class = new ReactiveVar()\n\n    self.currentLevel = new ReactiveVar()\n\n\n    //可选days 依赖于 当前的currentLevel\n    self.avaiableDays = new ReactiveVar([])\n    //可选时间   依赖于 当前选中的currentDay\n    self.avaiableTimes = new ReactiveVar([])\n\n\n    //选择的class\n    self.currentDay = new ReactiveVar()\n    self.currentTime = new ReactiveVar()\n    self.currentClass = new ReactiveVar()\n\n\n    self.tokenId = Dispatcher.register(function (payload) {\n\n        switch (payload.actionType) {\n\n\n\n            case \"ChangeClassPage_INIT\":\n            {\n\n                self.swimmerId.set(payload.swimmerId)\n                self.classId.set(payload.classId)\n\n                Meteor.subscribe(\"classes\");\n                Meteor.subscribe(\"swimmer\", payload.swimmerId);\n\n\n                break;\n            }\n            case \"ChangeClassPage_DAY_CHANGE\":\n            {\n\n                debugger\n\n                self.currentDay.set(payload.day)\n                break;\n            }\n            case \"ChangeClassPage_TIME_CHANGE\":\n            {\n\n                debugger\n                self.currentTime.set(payload.time)\n\n                break;\n            }\n            case \"ChangeClassPage_CLASS_CONFIRM\":\n            {\n\n                var href = '/classEdit/ChangeClassBillingPage'\n\n                FlowRouter.go(href);\n\n                break;\n            }\n            case \"ChangeClassPage_BILLING_CONFIRM\":\n            {\n\n                var swimmer =self.swimmer.get()\n                var oldClass = self.class.get()\n                var newClass = self.currentClass.get()\n\n\n                debugger\n                Meteor.call('change_class',\n                    swimmer._id,\n                    oldClass._id,\n                    newClass._id,\n\n                    function (err) {\n                    if (err) {//todo  prompt\n                        console.error(err)\n                        alert(err.message)\n                        return;\n                    }\n\n                    FlowRouter.go('/classEdit/swimmerList');\n                })\n\n                break;\n            }\n            case \"ChangeClassPage_CLASS_SEND_REQUEST\":\n            {\n\n                var currentClass =self.currentClass.get()\n                if(!currentClass){\n                    alert('Please select a class to change')\n                    return\n                }\n                alert(\n                    'Your request to change class for ' +\n                    'Daniel has been submitted. ' +\n                    'We’ll contact you soon.'\n                )\n\n                var href = '/classEdit/swimmerList'\n\n                FlowRouter.go(href);\n\n                break;\n            }\n\n\n\n\n            //每次 router到这个页面 清空用户选择\n            case \"GOTO_ChangeClassPage\":\n            {\n                self.currentDay.set()\n                self.currentTime.set()\n                self.currentClass.set()\n\n            }\n\n\n\n        }\n    })\n\n\n    //todo  为autorun 添加 ignore逻辑 优化性能\n    Meteor.startup(function () {\n\n        //swimmerId  classId\n        Tracker.autorun(function () {\n\n            var swimmerId = self.swimmerId.get()\n            var classId = self.classId.get()\n\n            if(!swimmerId || !classId) return;\n\n            var swimmer = DB.Swimmers.findOne({_id: swimmerId})\n            var classDetail = DB.Classes.findOne({_id: classId})\n\n            if(!swimmer || !classDetail) return;\n\n            self.swimmer.set(swimmer)\n            self.class.set(classDetail)\n\n\n            //var curentLevel= App.getNextClassLevel(swimmer.level)\n            //console.log(curentLevel)\n            //\n            //self.currentLevel.set(curentLevel)\n\n        })\n\n        Tracker.autorun(function () {\n            var currentSwimmer = self.swimmer.get()\n            var appInfo = DB.App.findOne()\n\n            if(!appInfo) return;\n            if(!currentSwimmer) return;\n\n            Tracker.autorun(function () {\n\n                var nowClasses = DB.ClassesRegister.find({\n                    swimmerId: currentSwimmer._id,\n                    status:'normal',  //不显示cancel中的和 change中的\n                    sessionId: App.info.sessionNow\n                }).fetch();\n\n                //self.nowClasses.set(nowClasses)\n\n                if(nowClasses.length>0){\n                    self.currentLevel.set(App.getNextClassLevel(currentSwimmer.level))\n\n                }else{\n                    self.currentLevel.set(currentSwimmer.level)\n                }\n\n            })\n\n        })\n\n        //选择 avaiableDays\n        Tracker.autorun(function () {\n            App.info = App.info || DB.App.findOne()\n            if (!App.info) return;\n\n            var level = self.currentLevel.get()\n\n            let classes = DB.Classes.find({\n                sessionId: App.info.sessionRegister, //level session\n                levels: level,\n                _id:{$ne: self.classId.get()} //除去当前class\n            }).fetch()\n\n            console.log(level,classes)\n            classes = _.uniq(classes, function (item, key, a) {\n                return item.day;\n            });\n\n            let days = classes.map(function (v, n) {\n                return {text: App.Config.week[v.day], value: v.day}\n            })\n\n            days.unshift({value: undefined})\n\n            //debugger\n\n            self.avaiableDays.set(days)\n\n\n        })\n\n\n        Tracker.autorun(function () {\n            App.info = App.info || DB.App.findOne()\n            if (!App.info) return;\n\n            var currentDay = self.currentDay.get();\n\n            var level = self.currentLevel.get()\n\n            let classes = DB.Classes.find({\n                sessionId: App.info.sessionRegister, // session level day\n                levels: level,\n                day: currentDay,\n                _id:{$ne: self.classId.get()}\n            }).fetch()\n\n            let times = classes.map(function (v, n) {\n                return {\n                    text: App.num2time(v.startTime) + \"-\" + App.num2time(v.endTime),\n                    value: v.startTime\n                }\n            })\n\n            //add an empty value to prevent browser init select value  use the first item\n            times.unshift({value: undefined})\n\n            self.avaiableTimes.set(times)\n\n            //初始化time\n            //if (times.length) {\n            //    self.currentTime.set(times[0].value)\n            //}\n\n        });\n\n\n        Tracker.autorun(function () {\n            App.info = App.info || DB.App.findOne()\n            if (!App.info) return;\n\n            let time = self.currentTime.get()\n\n            let level = self.currentLevel.get()\n            let day = self.currentDay.get()\n\n\n            let theClass = DB.Classes.findOne({\n                sessionId: App.info.sessionRegister, // session level day\n                levels: level,\n                day: day,\n                startTime: time\n            })\n\n            if (theClass) {\n                self.currentClass.set(theClass)\n            }\n\n        });\n\n\n    })\n\n\n})"]},"hash":"e38ed43b4047cff532b2732ff314d313892cf019"}
