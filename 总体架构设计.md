A: 病人的手机客户端App

这个手机客户端实际上是 MyVitals 1.0的一个改进版本. 增加的功能是小米推送 Push Notification. 推送的内容可以有以下几种

消息提醒. 用户看一下就行了. 比如提醒一下该测血糖了. 没有任何随后的 Action
URL 推送. 用户看一下标题, 需要点击进入一个 URL. 这个 URL 是 Meteor Server 的一个 URL. 其功能可以是任何可能. 比如消息标题叫做张医生需要和你讨论健康数据. 然后点击后进入一个页面. 这个页面的内容就是一个 chatting Card. 医生和病人随后开始 Chatting. 这个 eChatting 就是 Meteor 的一个页面.
Action 推送. 用户点一下标题. 然后 App 执行预订好的各种动作. 比如获取 App 数据库里面的数据等. 这是用户不需要做什么动作. 只要允许即可. 可以用于 Pull 用户数据库历史数据等操作. 这个需要 App 预先设置到协议, 根据协议进行动作. 目前这个版本还没有想好需要什么功能. 预留即可.
B: 医生手机客户端 App

这个是一个新开发的Native App或者 Ionic 的 Metoer Cordova app 其功能尽可能简单. 主要目的 就是完成医生 PC Web 端无法完成的手机功能. 这个 App 的工作流程就是一个纯粹的小米推送的接收方. 根据推送内容完成以下功能

拨打电话. 当医生从 pC Web 发起一个打电话请求的时候. 在 PC Web 上点击拨打电话按钮. metoer Server 向小米 Server 发送一个带有需要拨打的电话号码的 Push 消息. 这个消息最终通过小米推送到达同一个医生的手机 App 上. App 收到 Push message, 医生点击后直接打开电话功能并播出号码. 这样医生就不需要拿起来手机输入号码了.
发送 SMS 短信. 和拨打电话过程完全一样. 不同之处就是不是拨打号码而是给指定号码发出一个 PC Web 端设定好的短信息.
发送 微信消息. 和 SMS 短信息过程完全一样. 不同之处在于启动微信 API,发出消息. 目前想象这个 App 没有什么需要的界面. 日后可以考虑增添必要的界面.
显示重要的 Alert 信息
当医生不在电脑前, 如果有重要的提醒需要让医生知道, 把 Alert 可以 push 过来

C: Oasis 医生 PC/平板客户端

这个是主要的开发工作. 这是一个 Meteor App. 如果跑在平板电脑上就是 Meteor Cordova 项目. 采用 INSPINIA 框架开发. 目前不考虑跑在手机上. 只允许 PC Web 和平板. 因为手机端有专门的 B:医生手机客户端

D: iHealth dotNET 的云端

这个就是目前的 iHealth 使用 dotNET 技术开发的云服务器. 不做任何改动. 我们只是使用而已

E: 小米推送

这个就是目前我们使用的小米推送. 不是我们开发的, 我们只是使用而已.

F: Meteor Server

这个和 C:模块一起开发的. 是 Meteor 服务器端. 跑在 Node 上. 目前版本是双 Ubuntu 主机, 通过 Load Balancer 连接. 支持 Websocket 和 DDP.

G: MongoDB

部署在小米云上的3台主机组成的Replica set.

H: Data Server

这个是新开发的来进行数据同步的服务器. 使用 Node.js 来开发. 功能是

当有新用户增加到慈铭医院项目中时候, 向 D:iHealth 服务器请求这个用户的历史所有数据, 并转存到 G:MongoDB
当有老用户新测试数据产生, 本服务器接受 D push 过来的 API 请求,并讲数据转存到 G:MongoDB
各种使用场景的数据流
新用户第一次加入医院系统.

新用户第一次加入医院系统 操作: 甲医生把乙病人加入系统. 数据流

医生客户端A Meteor Call Server F 增加新病人.
F DDP Call H Data Server. 告诉新增病人的 iHealth ID.
H 通过 REST 请求 iHealth Server D. Pull 这个病人的 Data.
D 返回 H 这个病人的历史数据. 分页反复, 一直到全部取完.
H 得到所有数据, 一次性写入 G MongoDB.
老用户每次测血压血糖

老用户每次测血压血糖 操作: 病人自己在自己的手机上使用 iHealth 产品测血压血糖 数据流

病人客户端 A 上行数据给 iHealth Server D
D 通过 Push 接口把这个病人的最新测量数据送给 H Data Server
H 将数据存入 G: MongoDB
F 通过 Reactive 的方法得到 G 的数据更新. 这个数据更新触发一个 Alert 判断算法. 如果真的产生一个 Alert 就走 Alert 流程.
F 通过 DDP 更新医生客户端 C. 如果必要显示 Alert 或者一般性数据
如果真的触发了 Alert, 通过小米把信息发送给医生手机 B. 目的是让医生不在电脑前面也可以得到重要 Alert
小米推送 Alert 给医生
定期运行计划好的任务, 发现用户忘记测血压, 提醒用户

定期运行计划任务 通知用户 这个是预设定好的定期执行任务. 不需要触发. 数据流

定期执行一个检查任务. 根据预定义的规则检查用户是否按照预期进行测量. 这期间会有多次数据库读取操作. 如果没有发现异常就继续. 如果发现用户没有按照预订计划测量. 就进入下一步
通知E:小米服务器发送预定义好的提醒消息 "甲医生提醒您测量血压...". 自己也记录一下推送历史.
E 通过小米推送机制直接推送给病人手机客户端
医生发起聊天请求给病人并开始聊天

医生发起聊天请求给病人并开始聊天 医生发现某病人有特别情况需要一个实时聊天. 讨论病情. 操作: 医生点击这个病人的 Profile 中的 Chat. 然后直接输入一句话 数据流

医生发起聊天请求. 通过 Meteor Call 请求服务器
服务器判断如果这时候病人已经在聊天窗口中. 就不进行小米推送. 而是直接把这句话发到聊天窗口即可. 如果病人这时候不在聊天窗口. 则继续通知 E:小米推送服务的步骤, 同时发送这句话在数据库中. 当病人进入聊天窗口就看到了.
E:推送到病人手机 A.
病人手机会收到一个 Push Notification. 病人如果点击这个 Message, 就会打开一个 Web View. 这个 Web view 的 URL 是指向到 Meteor 服务器的. 直接建立一个 Chat Window 开始聊天
在 Chat Window 开始 Chatting 的过程. 这里需要通过 Meteor Server F
医生给病人手动推送信息

医生给病人手动推送信息 操作: 医生在病人的 Profile 页面发送一条信息给这个病人. Optional, 也可以发送一个网页 URL 用户可以点击进入 Web view 数据流:

C:医生客户端发起 Meteor Call 给 F. 参数是病人 ID 和正文内容, 类型. 类型可以是普通文本或者 URL. 如果是 URL 那么可以附带一个 URL 字段
F 请求 E 小米推送
E 通过小米推送给用户手机 A 一个 Push.如果消息类型就是一个文本 那么显示一个文本就完了. 如果是一个 URL, 那么用户可以点击这个 URL 进入4
用户点击 URL, 进入页面. 看到 医生推送的页面内容.
病人给医生发送消息

病人给医生发送消息 操作, 病人在手机app MyVitals 的新增按钮"医生对话"点击. 进入 Web View. 开始和医生对话

数据流

病人点击 App 上的按钮. 进入 Web view. 载入 Chatting Window
医生开始和病人 Chatting. 如果医生不在登陆. 信息会留在窗口上. 下次进入可以看到. 病人手机任何时候再进入 Chatting Window 的时候也可以看到.
医生给病人打电话或者微信

医生给病人打电话或者微信

操作. 医生在客户端某个病人的 Profile 上点打电话, 或者发微信(带内容) 数据流

C 医生客户端 Meteor Call 到 F . 参数病人 ID, 电话号码, 或者微信内容
F 请求 E
E 通过小米推送到 B. B 的手机上显示一个 Push Notification. 医生点击这个 Message. 如果是电话, 直接进入电话程序自动拨打, 无需输入内容. 如果是微信, 直接 App2App 打开微信自动输入了内容
通过电话或者微信联系病人手机. 这个是本系统之外的操作.
病人给医生电话或者微信

这个是本系统之外的操作.

开发团队分工
A 李超的团队在现有 myvitals 1.0 上增加 Push Notification 功能来完成 B 美国团队完成 (王宇晨 + 陈学伟) C Kevin, Vivian + 中国外包团队完成 D 现有产品不需要开发 E 现有产品不需要开发 F Kevin, vivian + 中国外包团队完成 G MongoDB , 安装即可, 不需要开发 H 周鸿峰完成